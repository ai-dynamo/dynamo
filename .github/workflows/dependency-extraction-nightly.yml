# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Nightly Dependency Extraction

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  extract-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need history for comparison

      - name: Setup dependency extraction environment
        uses: ./.github/actions/dependency-extraction-setup
        with:
          python-version: '3.12'

      - name: Run dependency extraction
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M)

          # Generate timestamped version (for artifacts)
          python3 .github/workflows/extract_dependency_versions.py \
            --output .github/reports/dependency_versions_${TIMESTAMP}.csv \
            --report-unversioned \
            --report-removed .github/reports/removed_dependencies.json

          # Copy to latest version (for repo tracking)
          mkdir -p .github/reports
          cp .github/reports/dependency_versions_${TIMESTAMP}.csv .github/reports/dependency_versions_latest.csv

          # Copy unversioned report if it exists (matches extractor's naming)
          if [ -f ".github/reports/dependency_versions_${TIMESTAMP}_unversioned.csv" ]; then
            cp ".github/reports/dependency_versions_${TIMESTAMP}_unversioned.csv" .github/reports/unversioned_dependencies_latest.csv
          fi

          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain .github/reports/*_latest.csv) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Count dependencies by status from latest
            new_count=$(grep -c ",New," .github/reports/dependency_versions_latest.csv 2>/dev/null || echo "0")
            changed_count=$(grep -c ",Changed," .github/reports/dependency_versions_latest.csv 2>/dev/null || echo "0")
            unchanged_count=$(grep -c ",Unchanged," .github/reports/dependency_versions_latest.csv 2>/dev/null || echo "0")

            # Parse removed dependencies from JSON
            if [ -f ".github/reports/removed_dependencies.json" ]; then
              removed_count=$(python3 -c "import json; print(json.load(open('.github/reports/removed_dependencies.json'))['count'])" 2>/dev/null || echo "0")

              # Simple formatting - just list names and versions
              removed_list=$(python3 -c "import json; data=json.load(open('.github/reports/removed_dependencies.json')); removed=data['removed'][:10]; lines=[]; [lines.extend([f\"    ‚Ä¢ **{d['Dependency Name']}** (was: \\\`{d['Version']}\\\`){' **[CRITICAL]**' if d.get('Critical')=='Yes' else ''}\", f\"      _from {d['Source File']}_\"]) for d in removed]; (lines.append(f\"    _... and {data['count']-10} more_\") if data['count']>10 else None); print('\\n'.join(lines))" 2>/dev/null || echo "    _Unable to parse removed dependencies_")
            else
              removed_count="0"
              removed_list="    _No removed dependencies_"
            fi

            echo "new_deps=$new_count" >> $GITHUB_OUTPUT
            echo "changed_deps=$changed_count" >> $GITHUB_OUTPUT
            echo "unchanged_deps=$unchanged_count" >> $GITHUB_OUTPUT
            echo "removed_deps=$removed_count" >> $GITHUB_OUTPUT
            echo "removed_list<<EOF" >> $GITHUB_OUTPUT
            echo "$removed_list" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: Update dependency versions [automated]'
          title: '[Automated] Nightly Dependency Version Update - $(date +%Y-%m-%d)'
          body: |
            ## ü§ñ Automated Dependency Version Update

            This PR contains the nightly dependency extraction results.

            ### üìä Summary
            - **New Dependencies:** ${{ steps.check_changes.outputs.new_deps }}
            - **Changed Versions:** ${{ steps.check_changes.outputs.changed_deps }}
            - **Removed Dependencies:** ${{ steps.check_changes.outputs.removed_deps }}
            - **Unchanged:** ${{ steps.check_changes.outputs.unchanged_deps }}

            ### üóëÔ∏è Removed Dependencies
            ${{ steps.check_changes.outputs.removed_list }}

            ### üìã Files Updated
            - ‚úÖ `.github/reports/dependency_versions_latest.csv` - Latest dependency snapshot
            - ‚úÖ `.github/reports/unversioned_dependencies_latest.csv` - Unversioned deps report (if applicable)

            > **Note:** Timestamped versions are stored in GitHub Artifacts (90-day retention) to avoid repo clutter.

            ### ‚úîÔ∏è Review Checklist
            - [ ] Review new dependencies for security/licensing concerns
            - [ ] Check version changes for breaking updates
            - [ ] Review removed dependencies (intentional?)
            - [ ] Verify unversioned dependencies report
            - [ ] Update baseline count if increase is expected

            ---

            üîó **Documentation:** [Dependency Reports README](../.github/reports/README.md)
            üì¶ **Artifacts:** Download timestamped CSVs from workflow run

            _Generated by nightly dependency extraction workflow_
            _Timestamp: ${{ env.TIMESTAMP }}_
          branch: automated/dependency-extraction-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            dependencies
            documentation

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-extraction-${{ github.run_number }}
          path: |
            .github/reports/dependency_versions_*.csv
            .github/reports/dependency_versions_*_unversioned.csv
          retention-days: 90

      - name: Summary
        if: always()
        run: |
          echo "## Dependency Extraction Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]]; then
            echo "‚úÖ **Changes Detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- New Dependencies: ${{ steps.check_changes.outputs.new_deps }}" >> $GITHUB_STEP_SUMMARY
            echo "- Changed Versions: ${{ steps.check_changes.outputs.changed_deps }}" >> $GITHUB_STEP_SUMMARY
            echo "- Unchanged: ${{ steps.check_changes.outputs.unchanged_deps }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìù A pull request has been created for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **No Changes Detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All dependencies remain unchanged since the last extraction." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const timestamp = new Date().toISOString();
            
            // Check if there's already an open issue for failed nightly runs
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,dependencies,nightly-failure',
              per_page: 1
            });
            
            const issueBody = `## ‚ö†Ô∏è Nightly Dependency Extraction Failed

            **Run:** ${runUrl}
            **Time:** ${timestamp}
            **Branch:** \`${{ github.ref_name }}\`

            ### Failure Details
            The automated nightly dependency extraction workflow has failed. Please investigate and resolve the issue.

            ### Possible Causes
            - Parsing errors in dependency files (Dockerfiles, requirements.txt, go.mod, etc.)
            - Network issues accessing the repository
            - Changes to file structure or naming conventions
            - Python script errors or exceptions

            ### Action Required
            1. Review the workflow run logs: ${runUrl}
            2. Fix any identified issues
            3. Re-run the workflow manually to verify the fix
            4. Close this issue once resolved

            **Note:** This issue was automatically created by the nightly dependency extraction workflow.`;
            
            if (issues.data.length > 0) {
              // Update existing issue with new failure
              const existingIssue = issues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### üîÑ Another Failure Detected\n\n**Run:** ${runUrl}\n**Time:** ${timestamp}\n\nThe nightly dependency extraction is still failing. Please prioritize investigation.`
              });
              core.info(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `‚ö†Ô∏è Nightly Dependency Extraction Failed - ${timestamp.split('T')[0]}`,
                body: issueBody,
                labels: ['automated', 'dependencies', 'nightly-failure', 'bug']
              });
              core.info('Created new failure issue');
            }

