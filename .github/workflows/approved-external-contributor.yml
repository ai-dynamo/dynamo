# SPDX-FileCopyrightText: Copyright (c) 2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Approved External Contributor

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  ok-to-test:
    runs-on: ubuntu-latest
    environment: external_collaborator
    steps:
      - name: Check if PR is from a fork
        id: fork_check
        run: |
          if [[ "${{ github.event.pull_request.head.repo.fork }}" == "true" ]]; then
            echo "is_fork=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_fork=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Comment /ok to test for approved contributor
        if: steps.fork_check.outputs.is_fork == 'true'
        uses: actions/github-script@v7
        env:
          APPROVED_EXTERNAL_CONTRIBUTORS: ${{ secrets.APPROVED_EXTERNAL_CONTRIBUTORS }}
        with:
          github-token: ${{ secrets.AUTO_VERIFIER_CI_TOKEN }}
          script: |
            const approvedRaw = process.env.APPROVED_EXTERNAL_CONTRIBUTORS || "[]";
            let approved = [];
            try {
              approved = JSON.parse(approvedRaw);
            } catch (error) {
              core.warning(`Invalid APPROVED_EXTERNAL_CONTRIBUTORS JSON: ${error.message}`);
              return;
            }

            if (!Array.isArray(approved)) {
              core.warning("APPROVED_EXTERNAL_CONTRIBUTORS is not a JSON array.");
              return;
            }

            const author = context.payload.pull_request?.user?.login;
            if (!author) {
              core.warning("No PR author found.");
              return;
            }

            if (!approved.includes(author)) {
              core.info(`Author ${author} is not in APPROVED_EXTERNAL_CONTRIBUTORS.`);
              return;
            }

            const sha = context.payload.pull_request?.head?.sha || context.sha;
            const body = `/ok to test ${sha}`;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body,
            });