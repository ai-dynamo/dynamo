# SPDX-FileCopyrightText: Copyright (c) 2024-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# Release pipeline: runs full CI on every push to release/* branches.
# When manually dispatched, also tags an RC and copies images from ECR to NGC.

name: Release Pipeline

on:
  push:
    branches:
      - 'release/*'
  workflow_dispatch:
    inputs:
      rc_number:
        description: 'RC number (e.g., 0 for rc0). Leave empty to auto-increment.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  manual-approval:
    name: Approve Manual Run
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: automated-release
    steps:
      - name: Manual run approved
        run: echo "Manual workflow run approved via automated-release environment"

  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      image_prefix: ${{ steps.extract.outputs.image_prefix }}
    steps:
      - name: Extract version from branch
        id: extract
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          VERSION="${BRANCH_NAME#release/}"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ ! "$BRANCH_NAME" =~ ^release/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: workflow_dispatch can only be triggered from release/* branches"
              echo "Current branch: $BRANCH_NAME"
              echo "Expected pattern: release/X.Y.Z (e.g., release/0.7.0)"
              exit 1
            fi
          fi

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z (e.g., 0.7.0)"
            exit 1
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "image_prefix=release-${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected version: ${VERSION}"

  ci-pipeline:
    name: Release CI
    needs: [prepare-release, manual-approval]
    if: |
      always() &&
      needs.prepare-release.result == 'success' &&
      (github.event_name == 'push' || needs.manual-approval.result == 'success')
    uses: ./.github/workflows/ci.yml
    with:
      pipeline_type: release
      image_prefix: ${{ needs.prepare-release.outputs.image_prefix }}
      include_nightly_marks: true
    secrets: inherit

  frontend-build:
    name: Build Frontend Images
    needs: [prepare-release, manual-approval]
    if: |
      always() &&
      needs.prepare-release.result == 'success' &&
      (github.event_name == 'push' || needs.manual-approval.result == 'success')
    uses: ./.github/workflows/build-frontend-image.yaml
    with:
      frontend_build: true
    secrets: inherit

  # Only runs on manual dispatch (not on push)
  release-publish:
    name: Tag RC & Publish to NGC
    needs: [prepare-release, manual-approval, ci-pipeline, frontend-build]
    if: |
      github.event_name == 'workflow_dispatch' &&
      needs.prepare-release.result == 'success' &&
      needs.manual-approval.result == 'success' &&
      needs.ci-pipeline.result == 'success'
    runs-on: cpu-amd-m5-4xlarge
    environment: automated-release
    env:
      VERSION: ${{ needs.prepare-release.outputs.version }}
      REGISTRY_IMAGE: ai-dynamo/dynamo
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      IMAGE_PREFIX: ${{ needs.prepare-release.outputs.image_prefix }}
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Determine next RC tag
        id: rc_tag
        env:
          INPUT_RC_NUMBER: ${{ github.event.inputs.rc_number }}
        run: |
          set -euo pipefail

          if [ -n "${INPUT_RC_NUMBER}" ]; then
            if ! [[ "${INPUT_RC_NUMBER}" =~ ^[0-9]+$ ]]; then
              echo "Error: rc_number must be a non-negative integer (got: ${INPUT_RC_NUMBER})"
              exit 1
            fi
            NEXT_RC="${INPUT_RC_NUMBER}"
            echo "Using provided RC number: ${NEXT_RC}"
          else
            echo "No RC number provided. Auto-incrementing..."
            echo "Looking for existing RC tags for version ${VERSION}..."

            RC_PATTERN="v${VERSION}-rc"
            EXISTING_RCS=$(git tag -l "${RC_PATTERN}*" | grep -E "^v${VERSION}-rc[0-9]+$" | sort -V || true)

            if [ -z "$EXISTING_RCS" ]; then
              NEXT_RC=0
              echo "No existing RC tags found. Starting with rc0."
            else
              LAST_RC=$(echo "$EXISTING_RCS" | tail -1)
              LAST_RC_NUM=${LAST_RC#v${VERSION}-rc}
              NEXT_RC=$((LAST_RC_NUM + 1))
              echo "Found existing RC tags:"
              echo "$EXISTING_RCS"
              echo "Last RC: ${LAST_RC}, Next RC number: ${NEXT_RC}"
            fi
          fi

          RC_TAG="v${VERSION}-rc${NEXT_RC}"
          echo "rc_tag=${RC_TAG}" >> $GITHUB_OUTPUT
          echo "rc_number=${NEXT_RC}" >> $GITHUB_OUTPUT
          echo "ngc_version_tag=${VERSION}rc${NEXT_RC}" >> $GITHUB_OUTPUT
          echo "Will create tag: ${RC_TAG}"

      - name: Create RC tag
        env:
          RC_TAG: ${{ steps.rc_tag.outputs.rc_tag }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "${RC_TAG}" -m "Release candidate ${RC_TAG}"
          git push origin "${RC_TAG}"

          echo "Created and pushed tag: ${RC_TAG}"

      - name: Setup crane
        env:
          CRANE_VERSION: v0.20.2
        run: |
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${CRANE_VERSION}/go-containerregistry_Linux_x86_64.tar.gz" \
            | tar -xzf - crane
          sudo mv crane /usr/local/bin/
          crane version

      - name: Login to ECR
        run: |
          ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          ECR_HOSTNAME="${ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
          echo "::add-mask::${ACCOUNT_ID}"
          echo "::add-mask::${ECR_HOSTNAME}"
          aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin "${ECR_HOSTNAME}"

      - name: Login to NGC
        env:
          NGC_TOKEN: ${{ secrets.NGC_PUBLISH_TOKEN }}
        run: |
          echo "${NGC_TOKEN}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "${NGC_TOKEN}" | crane auth login nvcr.io -u '$oauthtoken' --password-stdin

      - name: Copy images to NGC
        id: copy_images
        env:
          NGC_REGISTRY: nvcr.io
          NGC_ORG: ${{ secrets.NGC_PUBLISH_ORG }}
          NGC_VERSION_TAG: ${{ steps.rc_tag.outputs.ngc_version_tag }}
        run: |
          set -euo pipefail

          SUCCESSFUL_COPIES=()
          FAILED_COPIES=()

          ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          ECR_HOSTNAME="${ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
          echo "::add-mask::${ACCOUNT_ID}"
          echo "::add-mask::${ECR_HOSTNAME}"

          ARCHITECTURES=("amd64" "arm64")

          echo "Copying images: prefix=${IMAGE_PREFIX} version=${NGC_VERSION_TAG}"

          # CUDA 12: no cuda suffix in tag
          CUDA12_FRAMEWORKS=("vllm" "sglang")
          echo "Copying CUDA 12 runtime images..."
          for FRAMEWORK in "${CUDA12_FRAMEWORKS[@]}"; do
            for ARCH in "${ARCHITECTURES[@]}"; do
              SOURCE_TAG="${IMAGE_PREFIX}-${FRAMEWORK}-${ARCH}"
              SOURCE_IMAGE="${ECR_HOSTNAME}/${REGISTRY_IMAGE}:${SOURCE_TAG}"
              NGC_TAG="${NGC_VERSION_TAG}-${ARCH}"
              NGC_IMAGE="${NGC_REGISTRY}/${NGC_ORG}/ai-dynamo/${FRAMEWORK}-runtime:${NGC_TAG}"

              if crane copy "${SOURCE_IMAGE}" "${NGC_IMAGE}"; then
                echo "Copied: ${FRAMEWORK}-runtime:${NGC_TAG}"
                SUCCESSFUL_COPIES+=("${FRAMEWORK}-runtime:${NGC_TAG}")
              else
                echo "Failed: ${FRAMEWORK}-runtime:${NGC_TAG}"
                FAILED_COPIES+=("${FRAMEWORK}-runtime:${NGC_TAG}")
              fi
            done
          done

          # CUDA 13: explicit -cuda13 suffix in tag
          CUDA13_FRAMEWORKS=("vllm" "sglang" "trtllm")
          echo "Copying CUDA 13 runtime images..."
          for FRAMEWORK in "${CUDA13_FRAMEWORKS[@]}"; do
            for ARCH in "${ARCHITECTURES[@]}"; do
              SOURCE_TAG="${IMAGE_PREFIX}-${FRAMEWORK}-cuda13-${ARCH}"
              SOURCE_IMAGE="${ECR_HOSTNAME}/${REGISTRY_IMAGE}:${SOURCE_TAG}"
              NGC_TAG="${NGC_VERSION_TAG}-cuda13-${ARCH}"
              NGC_IMAGE="${NGC_REGISTRY}/${NGC_ORG}/ai-dynamo/${FRAMEWORK}-runtime:${NGC_TAG}"

              if crane copy "${SOURCE_IMAGE}" "${NGC_IMAGE}"; then
                echo "Copied: ${FRAMEWORK}-runtime:${NGC_TAG}"
                SUCCESSFUL_COPIES+=("${FRAMEWORK}-runtime:${NGC_TAG}")
              else
                echo "Failed: ${FRAMEWORK}-runtime:${NGC_TAG}"
                FAILED_COPIES+=("${FRAMEWORK}-runtime:${NGC_TAG}")
              fi
            done

            MULTIARCH="${NGC_REGISTRY}/${NGC_ORG}/ai-dynamo/${FRAMEWORK}-runtime:${NGC_VERSION_TAG}-cuda13"
            echo "Creating manifest: ${MULTIARCH}"
            docker manifest create "${MULTIARCH}" \
              "${NGC_REGISTRY}/${NGC_ORG}/ai-dynamo/${FRAMEWORK}-runtime:${NGC_VERSION_TAG}-cuda13-amd64" \
              "${NGC_REGISTRY}/${NGC_ORG}/ai-dynamo/${FRAMEWORK}-runtime:${NGC_VERSION_TAG}-cuda13-arm64" || true
            if docker manifest push "${MULTIARCH}"; then
              echo "Created multi-arch: ${FRAMEWORK}-runtime:${NGC_VERSION_TAG}-cuda13"
              SUCCESSFUL_COPIES+=("${FRAMEWORK}-runtime:${NGC_VERSION_TAG}-cuda13 (multi-arch)")
            else
              echo "Failed to create ${FRAMEWORK} cuda13 multi-arch"
              FAILED_COPIES+=("${FRAMEWORK}-runtime:${NGC_VERSION_TAG}-cuda13 (multi-arch)")
            fi
          done

          # Frontend images
          echo "Copying frontend images..."
          FRONTEND_IMAGES=()
          for ARCH in "${ARCHITECTURES[@]}"; do
            SOURCE_TAG="${IMAGE_PREFIX}-frontend-${ARCH}"
            SOURCE_IMAGE="${ECR_HOSTNAME}/${REGISTRY_IMAGE}:${SOURCE_TAG}"
            NGC_TAG="${NGC_VERSION_TAG}-${ARCH}"
            NGC_IMAGE="${NGC_REGISTRY}/${NGC_ORG}/ai-dynamo/dynamo-frontend:${NGC_TAG}"

            if crane copy "${SOURCE_IMAGE}" "${NGC_IMAGE}"; then
              echo "Copied: dynamo-frontend:${NGC_TAG}"
              SUCCESSFUL_COPIES+=("dynamo-frontend:${NGC_TAG}")
              FRONTEND_IMAGES+=("${NGC_IMAGE}")
            else
              echo "Failed: dynamo-frontend:${NGC_TAG}"
              FAILED_COPIES+=("dynamo-frontend:${NGC_TAG}")
            fi
          done

          FRONTEND_MULTIARCH="${NGC_REGISTRY}/${NGC_ORG}/ai-dynamo/dynamo-frontend:${NGC_VERSION_TAG}"
          if [ ${#FRONTEND_IMAGES[@]} -eq 2 ]; then
            docker manifest create "${FRONTEND_MULTIARCH}" \
              "${FRONTEND_IMAGES[0]}" \
              "${FRONTEND_IMAGES[1]}" || true

            if docker manifest push "${FRONTEND_MULTIARCH}"; then
              SUCCESSFUL_COPIES+=("dynamo-frontend:${NGC_VERSION_TAG} (multi-arch)")
            else
              FAILED_COPIES+=("dynamo-frontend:${NGC_VERSION_TAG} (multi-arch)")
            fi
          else
            FAILED_COPIES+=("dynamo-frontend:${NGC_VERSION_TAG} (multi-arch - missing archs)")
          fi

          echo "successful_count=${#SUCCESSFUL_COPIES[@]}" >> $GITHUB_OUTPUT
          echo "failed_count=${#FAILED_COPIES[@]}" >> $GITHUB_OUTPUT

          echo "Image copy summary: ${#SUCCESSFUL_COPIES[@]} succeeded, ${#FAILED_COPIES[@]} failed"

          if [ ${#SUCCESSFUL_COPIES[@]} -eq 0 ]; then
            echo "ERROR: No images were successfully copied to NGC!"
            exit 1
          fi

      - name: Validate chart versions
        run: .github/scripts/check_version_consistency.sh || echo "::warning::Chart version mismatch detected"

      - name: Build and push Helm charts to NGC
        id: helm_publish
        env:
          CHART_VERSION: ${{ steps.rc_tag.outputs.ngc_version_tag }}
          NGC_HELM_REPO: "oci://nvcr.io/${{ secrets.NGC_PUBLISH_ORG }}/ai-dynamo"
        run: .github/scripts/publish-helm-charts.sh

      - name: Create release summary
        env:
          RC_TAG: ${{ steps.rc_tag.outputs.rc_tag }}
          RC_NUMBER: ${{ steps.rc_tag.outputs.rc_number }}
          NGC_VERSION_TAG: ${{ steps.rc_tag.outputs.ngc_version_tag }}
          SUCCESSFUL_COUNT: ${{ steps.copy_images.outputs.successful_count }}
          FAILED_COUNT: ${{ steps.copy_images.outputs.failed_count }}
          HELM_SUCCESS_COUNT: ${{ steps.helm_publish.outputs.helm_success_count }}
          HELM_FAILED_COUNT: ${{ steps.helm_publish.outputs.helm_failed_count }}
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Git Tag | ${RC_TAG} |" >> $GITHUB_STEP_SUMMARY
          echo "| NGC Version Tag | ${NGC_VERSION_TAG} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### NGC Publishing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Successful image copies**: ${SUCCESSFUL_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed image copies**: ${FAILED_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Successful Helm pushes**: ${HELM_SUCCESS_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed Helm pushes**: ${HELM_FAILED_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Expected Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Runtime images (CUDA 12):" >> $GITHUB_STEP_SUMMARY
          echo "- \`vllm-runtime:${NGC_VERSION_TAG}-{amd64,arm64}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`sglang-runtime:${NGC_VERSION_TAG}-{amd64,arm64}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Runtime images (CUDA 13):" >> $GITHUB_STEP_SUMMARY
          echo "- \`vllm-runtime:${NGC_VERSION_TAG}-cuda13\` (multi-arch: amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- \`vllm-runtime:${NGC_VERSION_TAG}-cuda13-{amd64,arm64}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`sglang-runtime:${NGC_VERSION_TAG}-cuda13\` (multi-arch: amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- \`sglang-runtime:${NGC_VERSION_TAG}-cuda13-{amd64,arm64}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`trtllm-runtime:${NGC_VERSION_TAG}-cuda13\` (multi-arch: amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- \`trtllm-runtime:${NGC_VERSION_TAG}-cuda13-{amd64,arm64}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Frontend images:" >> $GITHUB_STEP_SUMMARY
          echo "- \`dynamo-frontend:${NGC_VERSION_TAG}\` (multi-arch: amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- \`dynamo-frontend:${NGC_VERSION_TAG}-{amd64,arm64}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Helm Charts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`dynamo-crds:${NGC_VERSION_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`dynamo-platform:${NGC_VERSION_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`chrek:${NGC_VERSION_TAG}\`" >> $GITHUB_STEP_SUMMARY
