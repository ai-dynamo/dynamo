# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Sync vNext docs from main to docs-website branch
#
# This workflow syncs the fern/ directory from main branch to the docs-website branch,
# preserving versioned documentation (pages-vX.Y.Z/, versions/vX.Y.Z.yml) and
# the versions section of docs.yml on the docs-website branch.
#
# The docs-website branch structure:
#   fern/
#   ├── docs.yml              # Has all versions listed (Next + released versions)
#   ├── fern.config.json
#   ├── assets/
#   ├── pages/                # vNext content (synced from main)
#   ├── pages-v1.0.0/         # Versioned snapshots (preserved)
#   ├── pages-v1.1.0/
#   ├── versions/
#   │   ├── next.yml          # vNext navigation (synced from main)
#   │   ├── v1.0.0.yml         # Versioned navigation (preserved)
#   │   └── v1.1.0.yml
#   └── ...

name: Sync Fern vNext Docs

on:
  push:
    branches:
      - main
    paths:
      - 'fern/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-vnext:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-checkout
          fetch-depth: 1

      - name: Checkout docs-website branch
        uses: actions/checkout@v4
        with:
          ref: docs-website
          path: fern-checkout
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          cd fern-checkout
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Preserve versioned content list
        id: preserve
        run: |
          cd fern-checkout/fern

          # Find all versioned pages directories (pages-vX.Y.Z)
          VERSIONED_PAGES=$(find . -maxdepth 1 -type d -name 'pages-v*' | sort)
          echo "Found versioned pages directories:"
          echo "$VERSIONED_PAGES"

          # Find all versioned config files (versions/vX.Y.Z.yml)
          VERSIONED_CONFIGS=$(find versions -maxdepth 1 -type f -name 'v*.yml' 2>/dev/null | sort || true)
          echo "Found versioned config files:"
          echo "$VERSIONED_CONFIGS"

          # Extract versions section from docs.yml to preserve it
          # We'll preserve everything after the "- display-name: Next" entry
          echo "Extracting versions from docs.yml..."

      - name: Sync vNext content from main
        run: |
          # Sync pages/ directory (vNext content)
          echo "Syncing pages/ from main to docs-website branch..."
          rm -rf fern-checkout/fern/pages
          cp -r main-checkout/fern/pages fern-checkout/fern/pages

          # Sync versions/next.yml (vNext navigation)
          echo "Syncing versions/next.yml from main to docs-website branch..."
          cp main-checkout/fern/versions/next.yml fern-checkout/fern/versions/next.yml

          # Sync assets/ directory
          echo "Syncing assets/ from main to docs-website branch..."
          rm -rf fern-checkout/fern/assets
          cp -r main-checkout/fern/assets fern-checkout/fern/assets

          # Sync fern.config.json
          echo "Syncing fern.config.json from main to docs-website branch..."
          cp main-checkout/fern/fern.config.json fern-checkout/fern/fern.config.json

          # Sync .gitignore if it exists
          if [ -f main-checkout/fern/.gitignore ]; then
            cp main-checkout/fern/.gitignore fern-checkout/fern/.gitignore
          fi

          # Sync convert_callouts.py script
          if [ -f main-checkout/fern/convert_callouts.py ]; then
            cp main-checkout/fern/convert_callouts.py fern-checkout/fern/convert_callouts.py
          fi

      - name: Convert GitHub callouts to Fern format
        run: |
          echo "Converting GitHub-style callouts to Fern format in pages/..."
          python3 fern-checkout/fern/convert_callouts.py --dir fern-checkout/fern/pages
          echo "Callout conversion complete."

      - name: Update docs.yml preserving versions
        run: |
          cd fern-checkout/fern

          # Extract the list of versioned entries from current docs.yml (on docs-website branch)
          # These are entries after "path: ./versions/next.yml"
          # We need to preserve them while updating the rest from main

          # Get version entries (lines containing "display-name: v" and their path lines)
          VERSION_ENTRIES=$(awk '/- display-name: v/{found=1} found{print; if(/path:/) found=0}' docs.yml)

          # Copy docs.yml from main as base
          cp ../../main-checkout/fern/docs.yml docs.yml

          # If we had version entries, append them after the next.yml line
          if [ -n "$VERSION_ENTRIES" ]; then
            echo "Preserving version entries:"
            echo "$VERSION_ENTRIES"

            # Create a temp file with the version entries properly indented
            echo "$VERSION_ENTRIES" > /tmp/version_entries.txt

            # Insert version entries after the next.yml path line
            sed -i '/path: \.\/versions\/next\.yml/r /tmp/version_entries.txt' docs.yml
          fi

          echo "Updated docs.yml:"
          cat docs.yml

      - name: Check for changes
        id: changes
        run: |
          cd fern-checkout
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          cd fern-checkout

          git add -A
          git commit -m "docs(fern): sync vNext from main

          Automated sync of fern/ directory from main branch.
          Preserves versioned documentation snapshots.

          Source commit: ${{ github.sha }}"

          git push origin docs-website

          echo "Successfully synced vNext docs to docs-website branch"
