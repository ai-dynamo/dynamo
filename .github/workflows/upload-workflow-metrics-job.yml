# Reusable job for uploading workflow metrics
# Add this job to the end of every workflow to capture metrics for all jobs in that workflow

upload-workflow-metrics:
  name: Upload Workflow Metrics
  runs-on: gitlab
  if: always()  # Always run, even if other jobs fail
  needs: [lychee]  # Replace with actual job names from the workflow
  
  steps:
    - name: Check out repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Upload Complete Workflow Metrics
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PIPELINE_INDEX: ${{ secrets.PIPELINE_INDEX }}
        JOB_INDEX: ${{ secrets.JOB_INDEX }}
      run: |
        # Run the enhanced metrics upload script
        python3 .github/workflows/upload_complete_workflow_metrics.py
