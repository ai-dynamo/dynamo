
name: debug

on:
  push:
    branches:
      - ci/grove

jobs:

  e2e:
    runs-on: prod-grove-e2e-v1
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - test_name: gang_scheduling
            test_pattern: "^Test_GS"
          # - test_name: rolling_updates
          #   test_pattern: "^Test_RU"
          # - test_name: startup_ordering
          #   test_pattern: "^Test_SO"
          # - test_name: Topology_Aware_Scheduling
          #   test_pattern: "^Test_TAS"
          # - test_name: cert_management
          #   test_pattern: "^Test_CM"
          # - test_name: auto_mnnvl
          #   test_pattern: "^Test_AutoMNNVL"
          #   make_target: "run-e2e-mnnvl-full"
    name: E2E - ${{ matrix.test_name }}
    steps:
      # print runner specs so we have a record in case of failures
      - name: Print runner specs
        run: |
          echo "CPUs: $(nproc)"
          echo "RAM: $(free -h | awk '/^Mem:/ {print $2}')"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: "ai-dynamo/grove"
          ref: "main"

      - name: E2E Setup
        uses: ./.github/actions/e2e-setup

      - name: Run e2e tests - ${{ matrix.test_name }}
        run: |
          make ${{ matrix.make_target || 'run-e2e-full' }} TEST_PATTERN='${{ matrix.test_pattern }}'
        working-directory: operator

      # The test code handles cleanup via Teardown(), but this step provides
      # extra safety in case of timeout or panic. Also good practice to ensure
      # clean state even though GitHub Actions runners are ephemeral.
      - name: Cleanup k3d cluster
        if: always()
        working-directory: operator
        run: |
          make e2e-cluster-down || true

      # Upload diagnostic logs collected by debug_utils.go on test failure.
      # Uses 'warn' since this only runs on failure and missing files indicates a problem.
      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs-${{ matrix.test_name }}
          path: operator/e2e-diagnostics/
          if-no-files-found: warn
          retention-days: 7