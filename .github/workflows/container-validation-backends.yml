# SPDX-FileCopyrightText: Copyright (c) 2024-2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: NVIDIA Dynamo Backends Github Validation

on:
  push:
    branches:
      - main
      - "pull-request/[0-9]+"

jobs:
  vllm-build-test:
    runs-on: gpu-l40-amd64
    name: Build and Test - vllm
    
    # Do not cancel main branch runs
    concurrency:
      group: ${{ github.workflow }}-vllm-build-test-${{ github.ref_name || github.run_id }}
      cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Build and Test VLLM
        uses: ./.github/actions/build-and-test-framework
        with:
          framework: vllm
          target: runtime
          pytest_marks: "e2e and vllm and gpu_1 and not slow"
          ngc_token: ${{ (github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push') && secrets.NGC_CI_ACCESS_TOKEN || '' }}
          github_token: ${{ secrets.CI_TOKEN }}
          aws_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  sglang-build-test:
    runs-on: gpu-l40-amd64
    name: Build and Test - sglang
    
    # Do not cancel main branch runs
    concurrency:
      group: ${{ github.workflow }}-sglang-build-test-${{ github.ref_name || github.run_id }}
      cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Build and Test SGLang
        uses: ./.github/actions/build-and-test-framework
        with:
          framework: sglang
          target: runtime
          pytest_marks: "e2e and sglang and gpu_1"
          ngc_token: ${{ (github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push') && secrets.NGC_CI_ACCESS_TOKEN || '' }}
          github_token: ${{ secrets.CI_TOKEN }}
          aws_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  trtllm-build-test:
    runs-on: gpu-l40-amd64
    name: Build and Test - trtllm
    
    # Do not cancel main branch runs
    concurrency:
      group: ${{ github.workflow }}-trtllm-build-test-${{ github.ref_name || github.run_id }}
      cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Build and Test TensorRT-LLM
        uses: ./.github/actions/build-and-test-framework
        with:
          framework: trtllm
          target: runtime
          pytest_marks: "e2e and trtllm_marker and gpu_1"
          ngc_token: ${{ (github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push') && secrets.NGC_CI_ACCESS_TOKEN || '' }}
          github_token: ${{ secrets.CI_TOKEN }}
          aws_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
