# SPDX-FileCopyrightText: Copyright (c) 2024-2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Dynamo Backend Validation

on:
  push:
    branches:
      - main
      - "pull-request/[0-9]+"

concurrency:
    group: ${{ github.workflow }}-build-test-${{ github.ref_name || github.run_id }}
    cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: .github/filters.yaml

  backend-checks:
    runs-on: ubuntu-latest
    needs: [build-test-vllm, build-test-sglang, build-test-trtllm]
    if: always()
    steps:
      - name: "Check all dependent jobs"
        run: |
          echo '${{ toJson(needs) }}' | jq 'to_entries | map(.value.result) | all(. as $result | ["success", "skipped"] | any($result == .))'

  build-test-vllm:
    runs-on: gpu-l40-amd64
    needs: changes
    if: needs.changes.outputs.docs == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Build Container
        id: build-image
        uses: ./.github/actions/docker-build-composite-action
        with:
          framework: vllm
          target: runtime
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Run tests
        uses: ./.github/actions/pytest-composite-action
        with:
          image_tag: ${{ steps.build-image.outputs.image_tag }}
          pytest_marks: "e2e and vllm and gpu_1 and not slow"

  build-test-sglang:
    runs-on: gpu-l40-amd64
    needs: changes
    if: needs.changes.outputs.docs == 'false'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build Container
        id: build-image
        uses: ./.github/actions/docker-build-composite-action
        with:
          framework: sglang
          target: runtime
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Run tests
        uses: ./.github/actions/pytest-composite-action
        with:
          image_tag: ${{ steps.build-image.outputs.image_tag }}
          pytest_marks: "e2e and sglang and gpu_1"

  build-test-trtllm:
    runs-on: gpu-l40-amd64
    needs: changes
    if: needs.changes.outputs.docs == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Build Container
        id: build-image
        uses: ./.github/actions/docker-build-composite-action
        with:
          framework: sglang
          target: runtime
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Run tests
        uses: ./.github/actions/pytest-composite-action
        with:
          image_tag: ${{ steps.build-image.outputs.image_tag }}
          pytest_marks: "e2e and sglang and gpu_1 and not slow"