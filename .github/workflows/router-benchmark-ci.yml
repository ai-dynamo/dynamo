# SPDX-FileCopyrightText: Copyright (c) 2024-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# Router benchmark only — for quick feedback while developing.
# Runs the same e2e router benchmark test as nightly, without the full pipeline.
# Always pulls the latest main branch image (main-vllm-amd64) from Azure ACR.
#
# Trigger from a branch:
#   - Push to any branch that has this file (runs on push when workflow or test changes).
#   - After merge to default: Actions → "Router Benchmark CI" → Run workflow.

name: Router Benchmark CI

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/router-benchmark-ci.yml'
      - 'tests/router/test_router_benchmark_vllm.py'
      - 'tests/router/common.py'

permissions:
  contents: read

env:
  REGISTRY_IMAGE: ai-dynamo/dynamo

jobs:
  router-benchmark:
    name: Router benchmark (4 GPU)
    runs-on: prod-tester-gb200-4-v1
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false  # Runner may not have git-lfs; benchmark does not need LFS
      - name: Set image tag by runner architecture
        id: image-tag
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ] || [ "$ARCH" = "amd64" ]; then
            echo "IMAGE_TAG=main-vllm-amd64" >> $GITHUB_ENV
            echo "platform_arch=amd64" >> $GITHUB_OUTPUT
          else
            echo "IMAGE_TAG=main-vllm-arm64" >> $GITHUB_ENV
            echo "platform_arch=arm64" >> $GITHUB_OUTPUT
          fi
          echo "Using image tag: $IMAGE_TAG (runner arch: $ARCH)"
      - name: Login to Azure ACR
        uses: ./.github/actions/docker-login
        with:
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Pull image
        shell: bash
        env:
          ACR_HOSTNAME: ${{ secrets.AZURE_ACR_HOSTNAME }}
        run: |
          docker pull "${ACR_HOSTNAME}/${{ env.REGISTRY_IMAGE }}:${{ env.IMAGE_TAG }}"
          docker tag "${ACR_HOSTNAME}/${{ env.REGISTRY_IMAGE }}:${{ env.IMAGE_TAG }}" "${{ env.IMAGE_TAG }}"
      - name: Run E2E Router Benchmark Tests (gpu_4)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.IMAGE_TAG }}
          pytest_marks: "vllm and e2e and router_benchmark and nightly and gpu_4"
          framework: vllm
          test_type: e2e-router-benchmark
          platform_arch: ${{ steps.image-tag.outputs.platform_arch }}
          hf_token: ${{ secrets.HF_TOKEN }}
