# SPDX-FileCopyrightText: Copyright (c) 2024-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# Router benchmark only — for quick feedback while developing.
# Runs the same e2e router benchmark test as nightly, without the full pipeline.
# Always pulls the latest main branch image (main-vllm-amd64) from ECR.
#
# Trigger from a branch:
#   - Push to any branch that has this file (runs on push when workflow or test changes).
#   - After merge to default: Actions → "Router Benchmark CI" → Run workflow.

name: Router Benchmark CI

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/router-benchmark-ci.yml'
      - 'tests/router/test_router_benchmark_vllm.py'
      - 'tests/router/common.py'

permissions:
  contents: read

env:
  REGISTRY_IMAGE: ai-dynamo/dynamo
  IMAGE_TAG: main-vllm-amd64

jobs:
  router-benchmark:
    name: Router benchmark (4 GPU)
    runs-on: prod-tester-gb200-4-v1
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false  # Runner may not have git-lfs; benchmark does not need LFS
      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: 'true'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Pull image
        shell: bash
        env:
          ECR_HOSTNAME: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
        run: |
          docker pull "${ECR_HOSTNAME}/${{ env.REGISTRY_IMAGE }}:${{ env.IMAGE_TAG }}"
          docker tag "${ECR_HOSTNAME}/${{ env.REGISTRY_IMAGE }}:${{ env.IMAGE_TAG }}" "${{ env.IMAGE_TAG }}"
      - name: Run E2E Router Benchmark Tests (gpu_4)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.IMAGE_TAG }}
          pytest_marks: "vllm and e2e and router_benchmark and nightly and gpu_4"
          framework: vllm
          test_type: e2e-router-benchmark
          platform_arch: amd64
          hf_token: ${{ secrets.HF_TOKEN }}
