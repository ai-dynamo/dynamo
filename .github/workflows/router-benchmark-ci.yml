# SPDX-FileCopyrightText: Copyright (c) 2024-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# Router benchmark only — for quick feedback while developing.
# Runs the same e2e router benchmark test as nightly, without the full pipeline.
# Uses a pre-built image (default: main-vllm-amd64) so no build step.
#
# Trigger from a branch:
#   - Push to any branch that has this file (runs on push when workflow or test changes).
#   - After merge to default: Actions → "Router Benchmark CI" → Run workflow.

name: Router Benchmark CI

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Runtime image tag (e.g. main-vllm-amd64, nightly-vllm-amd64)'
        required: true
        default: 'main-vllm-amd64'
        type: string
  push:
    paths:
      - '.github/workflows/router-benchmark-ci.yml'
      - 'tests/router/test_router_benchmark_vllm.py'
      - 'tests/router/common.py'

permissions:
  contents: read

env:
  REGISTRY_IMAGE: ai-dynamo/dynamo

jobs:
  router-benchmark:
    name: Router benchmark (4 GPU)
    runs-on: prod-tester-gb200-4-v1
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false  # Runner may not have git-lfs; benchmark does not need LFS
      # Pull from Azure ACR; runner has ACR access (cluster secret / pre-configured docker)
      - name: Pull image
        shell: bash
        env:
          ACR_HOSTNAME: ${{ secrets.AZURE_ACR_HOSTNAME }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          docker pull ${ACR_HOSTNAME}/${{ env.REGISTRY_IMAGE }}:${IMAGE_TAG}
          docker tag ${ACR_HOSTNAME}/${{ env.REGISTRY_IMAGE }}:${IMAGE_TAG} ${IMAGE_TAG}
      - name: Run E2E Router Benchmark Tests (gpu_4)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ inputs.image_tag }}
          pytest_marks: "vllm and e2e and router_benchmark and nightly and gpu_4"
          framework: vllm
          test_type: e2e-router-benchmark
          platform_arch: amd64
          hf_token: ${{ secrets.HF_TOKEN }}
