# SPDX-FileCopyrightText: Copyright (c) 2024-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Build Frontend Image

on:
  push:
    branches:
      - 'test-runner'
  workflow_call:
    secrets:
      AWS_ACCOUNT_ID:
        required: true
      AWS_DEFAULT_REGION:
        required: true
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AZURE_ACR_HOSTNAME:
        required: true
      AZURE_ACR_USER:
        required: true
      AZURE_ACR_PASSWORD:
        required: true
      CI_TOKEN:
        required: true
      SCCACHE_S3_BUCKET:
        required: true


jobs:
  changed-files:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
        with:
          fetch-depth: 0
      - name: Check for changes
        id: changes
        uses: ./.github/actions/changed-files
        with:
          gh_token: ${{ github.token }}

  build-frontend-image:
    name: Build Frontend Image (${{ matrix.platform.arch }})
    needs: changed-files
    if: needs.changed-files.outputs.frontend == 'true'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - { arch: arm64, runner: prod-builder-arm-v1 }
    runs-on: ${{ matrix.platform.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Debug Network
        run: |
          sudo apt-get install -y iproute2 || true
          echo "--- Interface Config ---"
          ip link  || true
          echo "--- Route Config ---"
          ip route  || true
          echo "--- MTU Check ---"
          cat /sys/class/net/eth0/mtu

          echo "--- MTU Check (Direct) ---"
          cat /sys/class/net/eth0/mtu

          echo "--- Docker Interface Check (if exists) ---"
          # Check for docker0 or other interfaces in /sys/class/net/
          ls -l /sys/class/net/
      - name: ðŸš‘ Fix Network MTU (Privileged Side-Loader)
        run: |
          echo "Attempting to fix MTU using a privileged helper container..."

          # We spin up a tiny Alpine container with --privileged and --net=host.
          # This allows it to see and modify the Runner Pod's network interfaces.

          docker run --rm --privileged --net=host alpine sh -c '
            apk add --no-cache iproute2 iptables &&

            # 1. Lower the Docker Bridge MTU (if it exists) to be safe
            if ip link show docker0 > /dev/null 2>&1; then
              ip link set dev docker0 mtu 1400
              echo "Successfully set docker0 MTU to 1400"
            else
              echo "docker0 interface not found, skipping..."
            fi &&

            # 2. The "Big Hammer": Clamp TCP MSS
            # This forces all TCP connections leaving the pod to negotiate smaller packet sizes
            # preventing the "Black Hole" drop.
            iptables -t mangle -A POSTROUTING -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1360
            echo "Successfully applied iptables MSS clamp"
          '

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          # Install system dependencies from apt
          sudo apt-get update && sudo apt-get install -y git build-essential protobuf-compiler
          # Install Rust (cargo + rustc)
          curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable
          # Make cargo available to later steps
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
      # - name: Install cbindgen
      #   shell: bash
      #   run: |
      #     set -euo pipefail
      #     cargo install cbindgen
      # - name: Docker Login
      #   uses: ./.github/actions/docker-login
      #   with:
      #     aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
      #     aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
      #     azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
      #     azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
      #     azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
