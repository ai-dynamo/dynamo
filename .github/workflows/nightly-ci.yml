# SPDX-FileCopyrightText: Copyright (c) 2024-2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Nightly CI pipeline

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-nightly-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

defaults:
  run:
    shell: bash --noprofile --norc -eo pipefail {0}

env:
  REGISTRY_IMAGE: ai-dynamo/dynamo
  NIGHTLY_IMAGE_PREFIX: nightly
  PREFER_PROVIDER: aws

############################## BUILD JOBS ##############################

jobs:
  build-amd64:
    name: Build ${{ matrix.framework }} (amd64)
    runs-on: cpu-amd-m5-4xlarge
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        framework: [vllm, trtllm, sglang]
    env:
      ECR_HOSTNAME: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
    steps:
      - uses: actions/checkout@v4
      - name: Login to ECR
        shell: bash
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_DEFAULT_REGION }} | docker login --username AWS --password-stdin ${ECR_HOSTNAME}
      - name: Pull existing framework image for cache
        shell: bash
        continue-on-error: true
        run: |
          echo "Attempting to pull existing ${{ matrix.framework }} image for layer caching..."
          if docker pull "${ECR_HOSTNAME}/${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-amd64"; then
            echo "Successfully pulled existing image for cache"
          else
            echo "No existing image found or pull failed, will build from scratch"
          fi
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ matrix.framework }}
          target: runtime
          platform: linux/amd64
          base_image_tag: ''
          runtime_image_tag: ''
          cuda_version: ''
          torch_backend: ''
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-amd64
      - name: Tag and Push Images
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-amd64
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-amd64-run-${{ github.run_id }}
          aws_push: 'true'
          azure_push: 'true'
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-arm64:
    name: Build ${{ matrix.framework }} (arm64)
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          - framework: vllm
            base_image_tag: '25.06-cuda12.9-devel-ubuntu24.04'
            runtime_image_tag: '12.9.0-runtime-ubuntu24.04'
            cuda_version: '129'
            torch_backend: 'cu129'
          - framework: trtllm
            base_image_tag: '25.06-py3'
            runtime_image_tag: '12.9.0-runtime-ubuntu24.04'
            cuda_version: '129'
            torch_backend: 'cu129'
          - framework: sglang
            base_image_tag: ''
            runtime_image_tag: ''
            cuda_version: ''
            torch_backend: ''
    env:
      ECR_HOSTNAME: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
    steps:
      - uses: actions/checkout@v4
      - name: Login to ECR
        shell: bash
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_DEFAULT_REGION }} | docker login --username AWS --password-stdin ${ECR_HOSTNAME}
      - name: Pull existing framework image for cache
        shell: bash
        continue-on-error: true
        run: |
          echo "Attempting to pull existing ${{ matrix.framework }} image for layer caching..."
          if docker pull "${ECR_HOSTNAME}/${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-arm64"; then
            echo "Successfully pulled existing image for cache"
          else
            echo "No existing image found or pull failed, will build from scratch"
          fi
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ matrix.framework }}
          target: runtime
          platform: linux/arm64
          base_image_tag: ${{ matrix.base_image_tag }}
          runtime_image_tag: ${{ matrix.runtime_image_tag }}
          cuda_version: ${{ matrix.cuda_version }}
          torch_backend: ${{ matrix.torch_backend }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-arm64
      - name: Tag and Push Images
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-arm64
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-arm64-run-${{ github.run_id }}
          aws_push: 'true'
          azure_push: 'true'
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

############################## TEST JOBS ##############################

  unit-tests:
    name: ${{ matrix.framework }}-${{ matrix.arch }}
    needs: [build-amd64, build-arm64]
    if: always()
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - { framework: vllm, arch: amd64, runner: gpu-l40-amd64 }
          - { framework: vllm, arch: arm64, runner: cpu-arm-r8g-4xlarge }
          - { framework: trtllm, arch: amd64, runner: gpu-l40-amd64 }
          - { framework: trtllm, arch: arm64, runner: cpu-arm-r8g-4xlarge }
          - { framework: sglang, arch: amd64, runner: gpu-l40-amd64 }
          - { framework: sglang, arch: arm64, runner: cpu-arm-r8g-4xlarge }
    steps:
      - uses: actions/checkout@v4
      - name: Check if build succeeded
        id: check_build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +x
          echo "Checking build status for ${{ matrix.framework }} (${{ matrix.arch }})"

          # Determine which build job to check
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            BUILD_JOB_NAME="Build ${{ matrix.framework }} (amd64)"
          else
            BUILD_JOB_NAME="Build ${{ matrix.framework }} (arm64)"
          fi

          # Query GitHub API for job status using curl (token from env to avoid log exposure)
          JOBS=$(curl -s -S -L --fail-with-body \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs?per_page=100" 2>&1)

          if [ $? -ne 0 ]; then
            echo "Error: Failed to query GitHub API"
            exit 1
          fi

          # Find the specific build job and check its conclusion
          BUILD_STATUS=$(echo "$JOBS" | jq -r --arg job_name "$BUILD_JOB_NAME" '.jobs[] | select(.name == $job_name) | .conclusion')

          echo "Build status for '$BUILD_JOB_NAME': $BUILD_STATUS"

          if [ "$BUILD_STATUS" != "success" ]; then
            echo "Error: Build failed or did not complete successfully. Failing test job."
            exit 1
          fi

          echo "Build succeeded. Proceeding with tests."
      - name: Login to ECR
        shell: bash
        env:
          ECR_HOSTNAME: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_DEFAULT_REGION }} | docker login --username AWS --password-stdin ${ECR_HOSTNAME}
      - name: Pull nightly image
        uses: ./.github/actions/ecr-pull-image
        with:
          registry_image: ${{ env.REGISTRY_IMAGE }}
          image_prefix: ${{ env.NIGHTLY_IMAGE_PREFIX }}
          framework: ${{ matrix.framework }}
          architecture: ${{ matrix.arch }}
          ecr_hostname: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-${{ matrix.arch }}
          pytest_marks: "${{ matrix.framework }} and unit and nightly"
          framework: ${{ matrix.framework }}
          test_type: unit
          platform_arch: ${{ matrix.arch }}
          cpu_limit: '8'

  integration-tests:
    name: ${{ matrix.framework }}-${{ matrix.arch }}
    needs: [build-amd64, build-arm64]
    if: always()
    runs-on: ${{ matrix.runner }}
    timeout-minutes: ${{ matrix.timeout }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { framework: vllm, arch: amd64, runner: gpu-l40-amd64, timeout: 90 }
          - { framework: vllm, arch: arm64, runner: cpu-arm-r8g-4xlarge, timeout: 90 }
          - { framework: trtllm, arch: amd64, runner: gpu-l40-amd64, timeout: 90 }
          - { framework: trtllm, arch: arm64, runner: cpu-arm-r8g-4xlarge, timeout: 90 }
          - { framework: sglang, arch: amd64, runner: gpu-l40-amd64, timeout: 90 }
          - { framework: sglang, arch: arm64, runner: cpu-arm-r8g-4xlarge, timeout: 90 }
    steps:
      - uses: actions/checkout@v4
      - name: Check if build succeeded
        id: check_build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +x
          echo "Checking build status for ${{ matrix.framework }} (${{ matrix.arch }})"
          BUILD_JOB_NAME="Build ${{ matrix.framework }} (${{ matrix.arch }})"

          JOBS=$(curl -s -S -L --fail-with-body \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs?per_page=100" 2>&1)

          if [ $? -ne 0 ]; then
            echo "Error: Failed to query GitHub API"
            exit 1
          fi

          BUILD_STATUS=$(echo "$JOBS" | jq -r --arg job_name "$BUILD_JOB_NAME" '.jobs[] | select(.name == $job_name) | .conclusion')

          echo "Build status for '$BUILD_JOB_NAME': $BUILD_STATUS"

          if [ "$BUILD_STATUS" != "success" ]; then
            echo "Error: Build failed or did not complete successfully. Failing test job."
            exit 1
          fi

          echo "Build succeeded. Proceeding with tests."
      - name: Login to ECR
        shell: bash
        env:
          ECR_HOSTNAME: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_DEFAULT_REGION }} | docker login --username AWS --password-stdin ${ECR_HOSTNAME}
      - name: Pull nightly image
        uses: ./.github/actions/ecr-pull-image
        with:
          registry_image: ${{ env.REGISTRY_IMAGE }}
          image_prefix: ${{ env.NIGHTLY_IMAGE_PREFIX }}
          framework: ${{ matrix.framework }}
          architecture: ${{ matrix.arch }}
          ecr_hostname: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
      - name: Run Integration Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-${{ matrix.arch }}
          pytest_marks: "${{ matrix.framework }} and integration and nightly"
          framework: ${{ matrix.framework }}
          test_type: integration
          platform_arch: ${{ matrix.arch }}

  e2e-single-gpu-tests:
    name: ${{ matrix.framework }}-${{ matrix.arch }}
    needs: [build-amd64, build-arm64]
    if: always()
    runs-on: ${{ matrix.runner }}
    timeout-minutes: ${{ matrix.timeout }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { framework: vllm, arch: amd64, runner: gpu-l40-amd64, timeout: 120 }
          - { framework: vllm, arch: arm64, runner: cpu-arm-r8g-4xlarge, timeout: 120 }
          - { framework: trtllm, arch: amd64, runner: gpu-l40-amd64, timeout: 120 }
          - { framework: trtllm, arch: arm64, runner: cpu-arm-r8g-4xlarge, timeout: 120 }
          - { framework: sglang, arch: amd64, runner: gpu-l40-amd64, timeout: 120 }
          - { framework: sglang, arch: arm64, runner: cpu-arm-r8g-4xlarge, timeout: 120 }
    steps:
      - uses: actions/checkout@v4
      - name: Check if build succeeded
        id: check_build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +x
          echo "Checking build status for ${{ matrix.framework }} (${{ matrix.arch }})"
          BUILD_JOB_NAME="Build ${{ matrix.framework }} (${{ matrix.arch }})"

          JOBS=$(curl -s -S -L --fail-with-body \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs?per_page=100" 2>&1)

          if [ $? -ne 0 ]; then
            echo "Error: Failed to query GitHub API"
            exit 1
          fi

          BUILD_STATUS=$(echo "$JOBS" | jq -r --arg job_name "$BUILD_JOB_NAME" '.jobs[] | select(.name == $job_name) | .conclusion')

          echo "Build status for '$BUILD_JOB_NAME': $BUILD_STATUS"

          if [ "$BUILD_STATUS" != "success" ]; then
            echo "Error: Build failed or did not complete successfully. Failing test job."
            exit 1
          fi

          echo "Build succeeded. Proceeding with tests."
      - name: Login to ECR
        shell: bash
        env:
          ECR_HOSTNAME: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_DEFAULT_REGION }} | docker login --username AWS --password-stdin ${ECR_HOSTNAME}
      - name: Pull nightly image
        uses: ./.github/actions/ecr-pull-image
        with:
          registry_image: ${{ env.REGISTRY_IMAGE }}
          image_prefix: ${{ env.NIGHTLY_IMAGE_PREFIX }}
          framework: ${{ matrix.framework }}
          architecture: ${{ matrix.arch }}
          ecr_hostname: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
      - name: Run E2E Tests (gpu_1)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-${{ matrix.arch }}
          pytest_marks: "nightly and ${{ matrix.framework }} and e2e and gpu_1"
          framework: ${{ matrix.framework }}
          test_type: e2e
          platform_arch: ${{ matrix.arch }}

  e2e-multi-gpu-tests:
    name: ${{ matrix.framework }}-${{ matrix.arch }}
    needs: [build-amd64, build-arm64]
    if: always()
    runs-on: ${{ matrix.runner }}
    timeout-minutes: ${{ matrix.timeout }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { framework: vllm, arch: amd64, runner: gpu-l40-amd64, timeout: 150 }
          - { framework: vllm, arch: arm64, runner: cpu-arm-r8g-4xlarge, timeout: 150 }
          - { framework: trtllm, arch: amd64, runner: gpu-l40-amd64, timeout: 150 }
          - { framework: trtllm, arch: arm64, runner: cpu-arm-r8g-4xlarge, timeout: 150 }
          - { framework: sglang, arch: amd64, runner: gpu-l40-amd64, timeout: 150 }
          - { framework: sglang, arch: arm64, runner: cpu-arm-r8g-4xlarge, timeout: 150 }
    steps:
      - uses: actions/checkout@v4
      - name: Check if build succeeded
        id: check_build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +x
          echo "Checking build status for ${{ matrix.framework }} (${{ matrix.arch }})"
          BUILD_JOB_NAME="Build ${{ matrix.framework }} (${{ matrix.arch }})"

          JOBS=$(curl -s -S -L --fail-with-body \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs?per_page=100" 2>&1)

          if [ $? -ne 0 ]; then
            echo "Error: Failed to query GitHub API"
            exit 1
          fi

          BUILD_STATUS=$(echo "$JOBS" | jq -r --arg job_name "$BUILD_JOB_NAME" '.jobs[] | select(.name == $job_name) | .conclusion')

          echo "Build status for '$BUILD_JOB_NAME': $BUILD_STATUS"

          if [ "$BUILD_STATUS" != "success" ]; then
            echo "Error: Build failed or did not complete successfully. Failing test job."
            exit 1
          fi

          echo "Build succeeded. Proceeding with tests."
      - name: Login to ECR
        shell: bash
        env:
          ECR_HOSTNAME: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_DEFAULT_REGION }} | docker login --username AWS --password-stdin ${ECR_HOSTNAME}
      - name: Pull nightly image
        uses: ./.github/actions/ecr-pull-image
        with:
          registry_image: ${{ env.REGISTRY_IMAGE }}
          image_prefix: ${{ env.NIGHTLY_IMAGE_PREFIX }}
          framework: ${{ matrix.framework }}
          architecture: ${{ matrix.arch }}
          ecr_hostname: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
      - name: Run E2E Tests (gpu_2)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-${{ matrix.arch }}
          pytest_marks: "nightly and ${{ matrix.framework }} and e2e and gpu_2"
          framework: ${{ matrix.framework }}
          test_type: e2e
          platform_arch: ${{ matrix.arch }}

  component-tests:
    name: ${{ matrix.framework }}-${{ matrix.arch }}-${{ matrix.component }}
    needs: [build-amd64, build-arm64]
    if: always()
    runs-on: ${{ matrix.runner }}
    timeout-minutes: ${{ matrix.timeout }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { framework: vllm, arch: amd64, component: router, runner: gpu-l40-amd64, timeout: 90, marks: "nightly and router" }
          - { framework: vllm, arch: amd64, component: planner, runner: gpu-l40-amd64, timeout: 90, marks: "nightly and planner" }
          - { framework: vllm, arch: amd64, component: kvbm, runner: gpu-l40-amd64, timeout: 90, marks: "nightly and kvbm and not slow" }
          - { framework: vllm, arch: arm64, component: router, runner: cpu-arm-r8g-4xlarge, timeout: 60, marks: "nightly and router" }
          - { framework: vllm, arch: arm64, component: planner, runner: cpu-arm-r8g-4xlarge, timeout: 60, marks: "nightly and planner" }
          - { framework: vllm, arch: arm64, component: kvbm, runner: cpu-arm-r8g-4xlarge, timeout: 60, marks: "nightly and kvbm" }
          - { framework: trtllm, arch: amd64, component: router, runner: gpu-l40-amd64, timeout: 90, marks: "nightly and router" }
          - { framework: trtllm, arch: amd64, component: planner, runner: gpu-l40-amd64, timeout: 90, marks: "nightly and planner" }
          - { framework: trtllm, arch: amd64, component: kvbm, runner: gpu-l40-amd64, timeout: 90, marks: "nightly and kvbm" }
          - { framework: trtllm, arch: arm64, component: router, runner: cpu-arm-r8g-4xlarge, timeout: 60, marks: "nightly and router" }
          - { framework: trtllm, arch: arm64, component: planner, runner: cpu-arm-r8g-4xlarge, timeout: 60, marks: "nightly and planner" }
          - { framework: trtllm, arch: arm64, component: kvbm, runner: cpu-arm-r8g-4xlarge, timeout: 60, marks: "nightly and kvbm" }
          - { framework: sglang, arch: amd64, component: router, runner: gpu-l40-amd64, timeout: 90, marks: "nightly and router" }
          - { framework: sglang, arch: amd64, component: planner, runner: gpu-l40-amd64, timeout: 90, marks: "nightly and planner" }
          - { framework: sglang, arch: amd64, component: kvbm, runner: gpu-l40-amd64, timeout: 90, marks: "nightly and kvbm" }
          - { framework: sglang, arch: arm64, component: router, runner: cpu-arm-r8g-4xlarge, timeout: 60, marks: "nightly and router" }
          - { framework: sglang, arch: arm64, component: planner, runner: cpu-arm-r8g-4xlarge, timeout: 60, marks: "nightly and planner" }
          - { framework: sglang, arch: arm64, component: kvbm, runner: cpu-arm-r8g-4xlarge, timeout: 60, marks: "nightly and kvbm" }
    steps:
      - uses: actions/checkout@v4
      - name: Check if build succeeded
        id: check_build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +x
          echo "Checking build status for ${{ matrix.framework }} (${{ matrix.arch }})"

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            BUILD_JOB_NAME="Build ${{ matrix.framework }} (amd64)"
          else
            BUILD_JOB_NAME="Build ${{ matrix.framework }} (arm64)"
          fi

          JOBS=$(curl -s -S -L --fail-with-body \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs?per_page=100" 2>&1)

          if [ $? -ne 0 ]; then
            echo "Error: Failed to query GitHub API"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          BUILD_STATUS=$(echo "$JOBS" | jq -r --arg job_name "$BUILD_JOB_NAME" '.jobs[] | select(.name == $job_name) | .conclusion')

          echo "Build status for '$BUILD_JOB_NAME': $BUILD_STATUS"

          if [ "$BUILD_STATUS" != "success" ]; then
            echo "Build failed or did not complete successfully. Skipping tests."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Build succeeded. Proceeding with tests."
      - name: Login to ECR
        shell: bash
        env:
          ECR_HOSTNAME: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_DEFAULT_REGION }} | docker login --username AWS --password-stdin ${ECR_HOSTNAME}
      - name: Pull nightly image
        uses: ./.github/actions/ecr-pull-image
        with:
          registry_image: ${{ env.REGISTRY_IMAGE }}
          image_prefix: ${{ env.NIGHTLY_IMAGE_PREFIX }}
          framework: ${{ matrix.framework }}
          architecture: ${{ matrix.arch }}
          ecr_hostname: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
      - name: Run Component Tests (${{ matrix.component }})
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ matrix.framework }}-${{ matrix.arch }}
          pytest_marks: "${{ matrix.marks }}"
          framework: ${{ matrix.framework }}
          test_type: component
          platform_arch: ${{ matrix.arch }}

  ############################## RESULTS SUMMARY ##############################
  results-summary:
    name: Results Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [build-amd64, build-arm64, unit-tests, integration-tests, e2e-single-gpu-tests, e2e-multi-gpu-tests, component-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Gather job metadata
        id: gather
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +x -e
          echo "# Nightly CI Results Summary" > results.md
          echo "" >> results.md
          echo "| Stage | Status | Runner | Duration (min) | Artifacts |" >> results.md
          echo "|-------|--------|--------|----------------|-----------|" >> results.md

          curl -s -S -L --fail-with-body \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs?per_page=100" \
            2>/dev/null | jq -c '.jobs[] | {id, name, runner_name, conclusion, started_at, completed_at}' > jobs.jsonl

          while read job_entry; do
            job_id=$(echo "$job_entry" | jq -r '.id')
            name=$(echo "$job_entry" | jq -r '.name')
            runner=$(echo "$job_entry" | jq -r '.runner_name')
            status=$(echo "$job_entry" | jq -r '.conclusion')
            started=$(echo "$job_entry" | jq -r '.started_at')
            completed=$(echo "$job_entry" | jq -r '.completed_at')
            minutes="N/A"
            if [[ "$started" != "null" && "$completed" != "null" ]]; then
              start_epoch=$(date -d "$started" +%s)
              end_epoch=$(date -d "$completed" +%s)
              minutes=$(( (end_epoch - start_epoch)/60 ))
            fi
            artifact_link="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#job-$job_id"
            printf "| %s | %s | %s | %s | [Log & Artifacts](%s) |\n" "$name" "$status" "$runner" "$minutes" "$artifact_link" >> results.md
          done < jobs.jsonl

          echo "" >> results.md
          echo "---" >> results.md
      - name: Display workflow summary
        run: cat results.md
      - name: Upload results summary as job summary
        run: cat results.md >> $GITHUB_STEP_SUMMARY
      - name: Upload results as artifact for Slack
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-results-summary
          path: results.md
          retention-days: 7
