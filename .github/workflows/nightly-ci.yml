# SPDX-FileCopyrightText: Copyright (c) 2024-2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Nightly CI pipeline

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-nightly-${{ github.run_id }}
  cancel-in-progress: false

############################## BUILD JOBS ##############################

jobs:
  build-vllm-amd64:
    name: Build (vllm.amd64)
    runs-on: cpu-amd-m5-2xlarge
    env:
      FRAMEWORK: vllm
      ARCH: amd64
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.ARCH == 'arm64' && '25.06-cuda12.9-devel-ubuntu24.04' || '' }}
          runtime_image_tag: ${{ env.ARCH == 'arm64' && '12.9.0-runtime-ubuntu24.04' || '' }}
          cuda_version: ${{ env.ARCH == 'arm64' && '129' || '' }}
          torch_backend: ${{ env.ARCH == 'arm64' && 'cu129' || '' }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Image
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tag: ai-dynamo/dynamo:nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
          aws_push: 'false'
          azure_push: 'true'
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-vllm-arm64:
    name: Build (vllm.arm64)
    runs-on: cpu-arm-r8g-4xlarge
    env:
      FRAMEWORK: vllm
      ARCH: arm64
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.ARCH == 'arm64' && '25.06-cuda12.9-devel-ubuntu24.04' || '' }}
          runtime_image_tag: ${{ env.ARCH == 'arm64' && '12.9.0-runtime-ubuntu24.04' || '' }}
          cuda_version: ${{ env.ARCH == 'arm64' && '129' || '' }}
          torch_backend: ${{ env.ARCH == 'arm64' && 'cu129' || '' }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Image
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tag: ai-dynamo/dynamo:nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
          aws_push: 'false'
          azure_push: 'true'
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-trtllm-amd64:
    name: Build (trtllm.amd64)
    runs-on: cpu-amd-m5-2xlarge
    env:
      FRAMEWORK: trtllm
      ARCH: amd64
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.ARCH == 'arm64' && '25.06-cuda12.9-devel-ubuntu24.04' || '' }}
          runtime_image_tag: ${{ env.ARCH == 'arm64' && '12.9.0-runtime-ubuntu24.04' || '' }}
          cuda_version: ${{ env.ARCH == 'arm64' && '129' || '' }}
          torch_backend: ${{ env.ARCH == 'arm64' && 'cu129' || '' }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Image
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tag: ai-dynamo/dynamo:nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
          aws_push: 'false'
          azure_push: 'true'
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-trtllm-arm64:
    name: Build (trtllm.arm64)
    runs-on: cpu-arm-r8g-4xlarge
    env:
      FRAMEWORK: trtllm
      ARCH: arm64
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.ARCH == 'arm64' && '25.06-cuda12.9-devel-ubuntu24.04' || '' }}
          runtime_image_tag: ${{ env.ARCH == 'arm64' && '12.9.0-runtime-ubuntu24.04' || '' }}
          cuda_version: ${{ env.ARCH == 'arm64' && '129' || '' }}
          torch_backend: ${{ env.ARCH == 'arm64' && 'cu129' || '' }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Image
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tag: ai-dynamo/dynamo:nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
          aws_push: 'false'
          azure_push: 'true'
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-sglang-amd64:
    name: Build (sglang.amd64)
    runs-on: cpu-amd-m5-2xlarge
    env:
      FRAMEWORK: sglang
      ARCH: amd64
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.ARCH == 'arm64' && '25.06-cuda12.9-devel-ubuntu24.04' || '' }}
          runtime_image_tag: ${{ env.ARCH == 'arm64' && '12.9.0-runtime-ubuntu24.04' || '' }}
          cuda_version: ${{ env.ARCH == 'arm64' && '129' || '' }}
          torch_backend: ${{ env.ARCH == 'arm64' && 'cu129' || '' }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Image
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tag: ai-dynamo/dynamo:nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
          aws_push: 'false'
          azure_push: 'true'
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-sglang-arm64:
    name: Build (sglang.arm64)
    runs-on: cpu-arm-r8g-4xlarge
    env:
      FRAMEWORK: sglang
      ARCH: arm64
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.ARCH == 'arm64' && '25.06-cuda12.9-devel-ubuntu24.04' || '' }}
          runtime_image_tag: ${{ env.ARCH == 'arm64' && '12.9.0-runtime-ubuntu24.04' || '' }}
          cuda_version: ${{ env.ARCH == 'arm64' && '129' || '' }}
          torch_backend: ${{ env.ARCH == 'arm64' && 'cu129' || '' }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Image
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tag: ai-dynamo/dynamo:nightly-${{ env.FRAMEWORK }}-${{ env.ARCH }}
          aws_push: 'false'
          azure_push: 'true'
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  ############################## UNIT TEST JOBS ##############################

  unit-vllm-amd64:
    name: Unit Tests (vllm.amd64)
    runs-on: cpu-amd-m5-2xlarge
    needs: build-vllm-amd64
    if: needs.build-vllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-amd64
          pytest_marks: "vllm and unit and nightly"
          framework: vllm
          test_type: unit
          platform_arch: amd64

  unit-vllm-arm64:
    name: Unit Tests (vllm.arm64)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-vllm-arm64
    if: needs.build-vllm-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-arm64
          pytest_marks: "vllm and unit and nightly"
          framework: vllm
          test_type: unit
          platform_arch: arm64

  unit-trtllm-amd64:
    name: Unit Tests (trtllm.amd64)
    runs-on: cpu-amd-m5-2xlarge
    needs: build-trtllm-amd64
    if: needs.build-trtllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-amd64
          pytest_marks: "trtllm and unit and nightly"
          framework: trtllm
          test_type: unit
          platform_arch: amd64

  unit-trtllm-arm64:
    name: Unit Tests (trtllm.arm64)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-trtllm-arm64
    if: needs.build-trtllm-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-arm64
          pytest_marks: "trtllm and unit and nightly"
          framework: trtllm
          test_type: unit
          platform_arch: arm64

  unit-sglang-amd64:
    name: Unit Tests (sglang.amd64)
    runs-on: cpu-amd-m5-2xlarge
    needs: build-sglang-amd64
    if: needs.build-sglang-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-amd64
          pytest_marks: "sglang and unit and nightly"
          framework: sglang
          test_type: unit
          platform_arch: amd64

  unit-sglang-arm64:
    name: Unit Tests (sglang.arm64)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-sglang-arm64
    if: needs.build-sglang-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-arm64
          pytest_marks: "sglang and unit and nightly"
          framework: sglang
          test_type: unit
          platform_arch: arm64

  ############################## INTEGRATION TEST JOBS ##############################

  integration-vllm-amd64:
    name: Integration Tests (vllm.amd64)
    runs-on: gpu-l40-amd64
    needs: build-vllm-amd64
    if: needs.build-vllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Integration Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-amd64
          pytest_marks: "vllm and integration and nightly"
          framework: vllm
          test_type: integration
          platform_arch: amd64

  integration-trtllm-amd64:
    name: Integration Tests (trtllm.amd64)
    runs-on: gpu-l40-amd64
    needs: build-trtllm-amd64
    if: needs.build-trtllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Integration Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-amd64
          pytest_marks: "trtllm and integration and nightly"
          framework: trtllm
          test_type: integration
          platform_arch: amd64

  integration-sglang-amd64:
    name: Integration Tests (sglang.amd64)
    runs-on: gpu-l40-amd64
    needs: build-sglang-amd64
    if: needs.build-sglang-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Integration Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-amd64
          pytest_marks: "sglang and integration and nightly"
          framework: sglang
          test_type: integration
          platform_arch: amd64

  ############################## E2E SINGLE GPU TEST JOBS ##############################

  e2e-single-vllm-amd64:
    name: E2E Tests Single GPU (vllm.amd64)
    runs-on: gpu-l40-amd64
    needs: build-vllm-amd64
    if: needs.build-vllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run E2E Tests (gpu_1)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-amd64
          pytest_marks: "nightly and vllm and e2e and gpu_1"
          framework: vllm
          test_type: e2e
          platform_arch: amd64

  e2e-single-trtllm-amd64:
    name: E2E Tests Single GPU (trtllm.amd64)
    runs-on: gpu-l40-amd64
    needs: build-trtllm-amd64
    if: needs.build-trtllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run E2E Tests (gpu_1)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-amd64
          pytest_marks: "nightly and trtllm and e2e and gpu_1"
          framework: trtllm
          test_type: e2e
          platform_arch: amd64

  e2e-single-sglang-amd64:
    name: E2E Tests Single GPU (sglang.amd64)
    runs-on: gpu-l40-amd64
    needs: build-sglang-amd64
    if: needs.build-sglang-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run E2E Tests (gpu_1)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-amd64
          pytest_marks: "nightly and sglang and e2e and gpu_1"
          framework: sglang
          test_type: e2e
          platform_arch: amd64

  ############################## E2E MULTI GPU TEST JOBS ##############################

  e2e-multi-vllm-amd64:
    name: E2E Tests Multi-GPU (vllm.amd64)
    runs-on: gpu-l40-amd64
    needs: build-vllm-amd64
    if: needs.build-vllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run E2E Tests (gpu_2)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-amd64
          pytest_marks: "nightly and vllm and e2e and gpu_2"
          framework: vllm
          test_type: e2e
          platform_arch: amd64

  e2e-multi-trtllm-amd64:
    name: E2E Tests Multi-GPU (trtllm.amd64)
    runs-on: gpu-l40-amd64
    needs: build-trtllm-amd64
    if: needs.build-trtllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run E2E Tests (gpu_2)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-amd64
          pytest_marks: "nightly and trtllm and e2e and gpu_2"
          framework: trtllm
          test_type: e2e
          platform_arch: amd64

  e2e-multi-sglang-amd64:
    name: E2E Tests Multi-GPU (sglang.amd64)
    runs-on: gpu-l40-amd64
    needs: build-sglang-amd64
    if: needs.build-sglang-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run E2E Tests (gpu_2)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-amd64
          pytest_marks: "nightly and sglang and e2e and gpu_2"
          framework: sglang
          test_type: e2e
          platform_arch: amd64

  ############################## COMPONENT TEST JOBS ##############################

  component-vllm-amd64-router:
    name: Component Tests (vllm.amd64.router)
    runs-on: gpu-l40-amd64
    needs: build-vllm-amd64
    if: needs.build-vllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-amd64
          pytest_marks: "nightly and router"
          framework: vllm
          test_type: component
          platform_arch: amd64

  component-vllm-amd64-planner:
    name: Component Tests (vllm.amd64.planner)
    runs-on: gpu-l40-amd64
    needs: build-vllm-amd64
    if: needs.build-vllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-amd64
          pytest_marks: "nightly and planner"
          framework: vllm
          test_type: component
          platform_arch: amd64

  component-vllm-amd64-kvbm:
    name: Component Tests (vllm.amd64.kvbm)
    runs-on: gpu-l40-amd64
    needs: build-vllm-amd64
    if: needs.build-vllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-amd64
          pytest_marks: "nightly and kvbm and not slow" #TODO remove this.
          framework: vllm
          test_type: component
          platform_arch: amd64

  component-vllm-arm64-router:
    name: Component Tests (vllm.arm64.router)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-vllm-arm64
    if: needs.build-vllm-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-arm64
          pytest_marks: "nightly and router"
          framework: vllm
          test_type: component
          platform_arch: arm64

  component-vllm-arm64-planner:
    name: Component Tests (vllm.arm64.planner)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-vllm-arm64
    if: needs.build-vllm-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-arm64
          pytest_marks: "nightly and planner"
          framework: vllm
          test_type: component
          platform_arch: arm64

  component-vllm-arm64-kvbm:
    name: Component Tests (vllm.arm64.kvbm)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-vllm-arm64
    if: needs.build-vllm-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-vllm-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-vllm-arm64
          pytest_marks: "nightly and kvbm"
          framework: vllm
          test_type: component
          platform_arch: arm64

  component-trtllm-amd64-router:
    name: Component Tests (trtllm.amd64.router)
    runs-on: gpu-l40-amd64
    needs: build-trtllm-amd64
    if: needs.build-trtllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-amd64
          pytest_marks: "nightly and router"
          framework: trtllm
          test_type: component
          platform_arch: amd64

  component-trtllm-amd64-planner:
    name: Component Tests (trtllm.amd64.planner)
    runs-on: gpu-l40-amd64
    needs: build-trtllm-amd64
    if: needs.build-trtllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-amd64
          pytest_marks: "nightly and planner"
          framework: trtllm
          test_type: component
          platform_arch: amd64

  component-trtllm-amd64-kvbm:
    name: Component Tests (trtllm.amd64.kvbm)
    runs-on: gpu-l40-amd64
    needs: build-trtllm-amd64
    if: needs.build-trtllm-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-amd64
          pytest_marks: "nightly and kvbm"
          framework: trtllm
          test_type: component
          platform_arch: amd64

  component-trtllm-arm64-router:
    name: Component Tests (trtllm.arm64.router)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-trtllm-arm64
    if: needs.build-trtllm-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-arm64
          pytest_marks: "nightly and router"
          framework: trtllm
          test_type: component
          platform_arch: arm64

  component-trtllm-arm64-planner:
    name: Component Tests (trtllm.arm64.planner)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-trtllm-arm64
    if: needs.build-trtllm-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-arm64
          pytest_marks: "nightly and planner"
          framework: trtllm
          test_type: component
          platform_arch: arm64

  component-trtllm-arm64-kvbm:
    name: Component Tests (trtllm.arm64.kvbm)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-trtllm-arm64
    if: needs.build-trtllm-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-trtllm-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-trtllm-arm64
          pytest_marks: "nightly and kvbm"
          framework: trtllm
          test_type: component
          platform_arch: arm64

  component-sglang-amd64-router:
    name: Component Tests (sglang.amd64.router)
    runs-on: gpu-l40-amd64
    needs: build-sglang-amd64
    if: needs.build-sglang-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-amd64
          pytest_marks: "nightly and router"
          framework: sglang
          test_type: component
          platform_arch: amd64

  component-sglang-amd64-planner:
    name: Component Tests (sglang.amd64.planner)
    runs-on: gpu-l40-amd64
    needs: build-sglang-amd64
    if: needs.build-sglang-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-amd64
          pytest_marks: "nightly and planner"
          framework: sglang
          test_type: component
          platform_arch: amd64

  component-sglang-amd64-kvbm:
    name: Component Tests (sglang.amd64.kvbm)
    runs-on: gpu-l40-amd64
    needs: build-sglang-amd64
    if: needs.build-sglang-amd64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-amd64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-amd64
          pytest_marks: "nightly and kvbm"
          framework: sglang
          test_type: component
          platform_arch: amd64

  component-sglang-arm64-router:
    name: Component Tests (sglang.arm64.router)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-sglang-arm64
    if: needs.build-sglang-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-arm64
          pytest_marks: "nightly and router"
          framework: sglang
          test_type: component
          platform_arch: arm64

  component-sglang-arm64-planner:
    name: Component Tests (sglang.arm64.planner)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-sglang-arm64
    if: needs.build-sglang-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-arm64
          pytest_marks: "nightly and planner"
          framework: sglang
          test_type: component
          platform_arch: arm64

  component-sglang-arm64-kvbm:
    name: Component Tests (sglang.arm64.kvbm)
    runs-on: cpu-arm-r8g-4xlarge
    needs: build-sglang-arm64
    if: needs.build-sglang-arm64.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/docker-pull-image
        with:
          image_tag: nightly-sglang-arm64
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: nightly-sglang-arm64
          pytest_marks: "nightly and kvbm"
          framework: sglang
          test_type: component
          platform_arch: arm64

  ############################## RESULTS SUMMARY ##############################
  #TODO: Update this to add links to the jobs and add more details.
  results-summary:
    name: Results Summary
    runs-on: ubuntu-latest
    if: always()
    needs:
      - build-vllm-amd64
      - build-vllm-arm64
      - build-trtllm-amd64
      - build-trtllm-arm64
      - build-sglang-amd64
      - build-sglang-arm64
      - unit-vllm-amd64
      - unit-vllm-arm64
      - unit-trtllm-amd64
      - unit-trtllm-arm64
      - unit-sglang-amd64
      - unit-sglang-arm64
      - integration-vllm-amd64
      - integration-trtllm-amd64
      - integration-sglang-amd64
      - e2e-single-vllm-amd64
      - e2e-single-trtllm-amd64
      - e2e-single-sglang-amd64
      - e2e-multi-vllm-amd64
      - e2e-multi-trtllm-amd64
      - e2e-multi-sglang-amd64
      - component-vllm-amd64-router
      - component-vllm-amd64-planner
      - component-vllm-amd64-kvbm
      - component-vllm-arm64-router
      - component-vllm-arm64-planner
      - component-vllm-arm64-kvbm
      - component-trtllm-amd64-router
      - component-trtllm-amd64-planner
      - component-trtllm-amd64-kvbm
      - component-trtllm-arm64-router
      - component-trtllm-arm64-planner
      - component-trtllm-arm64-kvbm
      - component-sglang-amd64-router
      - component-sglang-amd64-planner
      - component-sglang-amd64-kvbm
      - component-sglang-arm64-router
      - component-sglang-arm64-planner
      - component-sglang-arm64-kvbm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Gather job metadata
        id: gather
        run: |
          set -e
          echo "# Nightly CI Results Summary" > results.md
          echo "" >> results.md
          echo "| Stage            | Status   | Runner                | Duration (min) | Artifacts                  |" >> results.md
          echo "|------------------|----------|-----------------------|----------------|----------------------------|" >> results.md

          gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs -q ".jobs[] | {id, name, runner_name, conclusion, started_at, completed_at}" > jobs.jsonl

          while read job_entry; do
            job_id=$(echo "$job_entry" | jq -r '.id')
            name=$(echo "$job_entry" | jq -r '.name')
            runner=$(echo "$job_entry" | jq -r '.runner_name')
            status=$(echo "$job_entry" | jq -r '.conclusion')
            started=$(echo "$job_entry" | jq -r '.started_at')
            completed=$(echo "$job_entry" | jq -r '.completed_at')
            minutes="N/A"
            if [[ "$started" != "null" && "$completed" != "null" ]]; then
              start_epoch=$(date -d "$started" +%s)
              end_epoch=$(date -d "$completed" +%s)
              minutes=$(( (end_epoch - start_epoch)/60 ))
            fi
            artifact_link="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#job-$job_id"
            printf "| %s | %s | %s | %s | [Log & Artifacts](%s) |\n" "$name" "$status" "$runner" "$minutes" "$artifact_link" >> results.md
          done < jobs.jsonl

          echo "" >> results.md
          echo "---" >> results.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Display workflow summary
        run: cat results.md
      - name: Upload results summary as job summary
        run: cat results.md >> $GITHUB_STEP_SUMMARY
      - name: Upload results as artifact for Slack
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-results-summary
          path: results.md
          retention-days: 7

  # TODO: improve the Slack message and add more details.
  # notify-slack:
  #   name: Notify Slack
  #   runs-on: cpu-amd-m5-2xlarge
  #   if: always() && github.event_name == 'schedule' && !github.event.repository.fork
  #   needs: results-summary
  #   steps:
  #     - name: Download results summary
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: nightly-results-summary
  #         path: .
  #       continue-on-error: true

  #     - name: Send Slack notification
  #       env:
  #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NOTIFY_NIGHTLY_WEBHOOK_URL }}
  #         RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  #       run: |
  #         set +x  # Prevent printing secrets.

  #         # Ensure results.md exists
  #         if [ ! -f results.md ]; then
  #           echo "Results file not found, creating fallback message"
  #           echo "Nightly CI Run: ${RUN_URL}" > results.md
  #         fi

  #         # Truncate large messages (Slack has ~40KB limit)
  #         MAX_SIZE=30000
  #         FILE_SIZE=$(wc -c < results.md)
  #         if [ "$FILE_SIZE" -gt "$MAX_SIZE" ]; then
  #           echo "Results file too large ($FILE_SIZE bytes), truncating..."
  #           head -c 29000 results.md > results_truncated.md
  #           printf "\n\n...(Results truncated. Full details: %s)" "$RUN_URL" >> results_truncated.md
  #           mv results_truncated.md results.md
  #         fi

  #         # Safely encode message to JSON using jq
  #         # Read file content and create proper JSON payload
  #         PAYLOAD=$(jq -n --rawfile content results.md '{text: $content}')

  #         # Send to Slack with retry logic
  #         send_slack() {
  #           local retries=3
  #           local delay=5

  #           for attempt in $(seq 1 $retries); do
  #             echo "Sending Slack notification (attempt $attempt/$retries)..."

  #             http_code=$(curl -s -w "%{http_code}" -o /tmp/slack_response.txt \
  #                  -X POST \
  #                  -H "Content-Type: application/json" \
  #                  -d "$PAYLOAD" \
  #                  "$SLACK_WEBHOOK_URL")

  #             if [ "$http_code" = "200" ]; then
  #               echo "Slack notification sent successfully"
  #               return 0
  #             else
  #               echo "HTTP $http_code returned. Response: $(cat /tmp/slack_response.txt 2>/dev/null || echo 'N/A')"
  #               if [ $attempt -lt $retries ]; then
  #                 echo "Retrying in ${delay}s..."
  #                 sleep $delay
  #               fi
  #             fi
  #           done

  #           echo "Warning: Slack notification failed after $retries attempts (non-blocking)"
  #           return 0
  #         }

  #         send_slack || true