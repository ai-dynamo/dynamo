# SPDX-FileCopyrightText: Copyright (c) 2024-2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Nightly CI pipeline

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-nightly-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

defaults:
  run:
    shell: bash --noprofile --norc -eo pipefail {0}

env:
  REGISTRY_IMAGE: ai-dynamo/dynamo
  NIGHTLY_IMAGE_PREFIX: nightly
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
  AZURE_ACR_HOSTNAME: ${{ secrets.AZURE_ACR_HOSTNAME }}
  PREFER_PROVIDER: aws

############################## BUILD JOBS ##############################

jobs:
  build-vllm-amd64:
    name: Build vLLM (amd64)
    runs-on: cpu-amd-m5-2xlarge
    timeout-minutes: 90
    env:
      FRAMEWORK: vllm
      ARCH: amd64
      BASE_IMAGE_TAG: ''
      RUNTIME_IMAGE_TAG: ''
      CUDA_VERSION: ''
      TORCH_BACKEND: ''
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials (OIDC)
        if: secrets.AWS_NIGHTLY_ROLE != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_NIGHTLY_ROLE }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Configure AWS credentials (static keys)
        if: secrets.AWS_NIGHTLY_ROLE == '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.BASE_IMAGE_TAG }}
          runtime_image_tag: ${{ env.RUNTIME_IMAGE_TAG }}
          cuda_version: ${{ env.CUDA_VERSION }}
          torch_backend: ${{ env.TORCH_BACKEND }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Images
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}-run-${{ github.run_id }}
          aws_push: 'true'
          azure_push: 'true'
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ env.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-vllm-arm64:
    name: Build vLLM (arm64)
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 90
    env:
      FRAMEWORK: vllm
      ARCH: arm64
      BASE_IMAGE_TAG: '25.06-cuda12.9-devel-ubuntu24.04'
      RUNTIME_IMAGE_TAG: '12.9.0-runtime-ubuntu24.04'
      CUDA_VERSION: '129'
      TORCH_BACKEND: 'cu129'
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials (OIDC)
        if: secrets.AWS_NIGHTLY_ROLE != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_NIGHTLY_ROLE }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Configure AWS credentials (static keys)
        if: secrets.AWS_NIGHTLY_ROLE == '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.BASE_IMAGE_TAG }}
          runtime_image_tag: ${{ env.RUNTIME_IMAGE_TAG }}
          cuda_version: ${{ env.CUDA_VERSION }}
          torch_backend: ${{ env.TORCH_BACKEND }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Images
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}-run-${{ github.run_id }}
          aws_push: 'true'
          azure_push: 'true'
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ env.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-trtllm-amd64:
    name: Build TRTLLM (amd64)
    runs-on: cpu-amd-m5-2xlarge
    timeout-minutes: 90
    env:
      FRAMEWORK: trtllm
      ARCH: amd64
      BASE_IMAGE_TAG: ''
      RUNTIME_IMAGE_TAG: ''
      CUDA_VERSION: ''
      TORCH_BACKEND: ''
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials (OIDC)
        if: secrets.AWS_NIGHTLY_ROLE != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_NIGHTLY_ROLE }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Configure AWS credentials (static keys)
        if: secrets.AWS_NIGHTLY_ROLE == '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.BASE_IMAGE_TAG }}
          runtime_image_tag: ${{ env.RUNTIME_IMAGE_TAG }}
          cuda_version: ${{ env.CUDA_VERSION }}
          torch_backend: ${{ env.TORCH_BACKEND }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Images
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}-run-${{ github.run_id }}
          aws_push: 'true'
          azure_push: 'true'
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ env.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-trtllm-arm64:
    name: Build TRTLLM (arm64)
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 90
    env:
      FRAMEWORK: trtllm
      ARCH: arm64
      BASE_IMAGE_TAG: '25.06-cuda12.9-devel-ubuntu24.04'
      RUNTIME_IMAGE_TAG: '12.9.0-runtime-ubuntu24.04'
      CUDA_VERSION: '129'
      TORCH_BACKEND: 'cu129'
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials (OIDC)
        if: secrets.AWS_NIGHTLY_ROLE != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_NIGHTLY_ROLE }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Configure AWS credentials (static keys)
        if: secrets.AWS_NIGHTLY_ROLE == '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.BASE_IMAGE_TAG }}
          runtime_image_tag: ${{ env.RUNTIME_IMAGE_TAG }}
          cuda_version: ${{ env.CUDA_VERSION }}
          torch_backend: ${{ env.TORCH_BACKEND }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Images
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}-run-${{ github.run_id }}
          aws_push: 'true'
          azure_push: 'true'
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ env.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-sglang-amd64:
    name: Build SGLang (amd64)
    runs-on: cpu-amd-m5-2xlarge
    timeout-minutes: 90
    env:
      FRAMEWORK: sglang
      ARCH: amd64
      BASE_IMAGE_TAG: ''
      RUNTIME_IMAGE_TAG: ''
      CUDA_VERSION: ''
      TORCH_BACKEND: ''
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials (OIDC)
        if: secrets.AWS_NIGHTLY_ROLE != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_NIGHTLY_ROLE }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Configure AWS credentials (static keys)
        if: secrets.AWS_NIGHTLY_ROLE == '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.BASE_IMAGE_TAG }}
          runtime_image_tag: ${{ env.RUNTIME_IMAGE_TAG }}
          cuda_version: ${{ env.CUDA_VERSION }}
          torch_backend: ${{ env.TORCH_BACKEND }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Images
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}-run-${{ github.run_id }}
          aws_push: 'true'
          azure_push: 'true'
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ env.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

  build-sglang-arm64:
    name: Build SGLang (arm64)
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 90
    env:
      FRAMEWORK: sglang
      ARCH: arm64
      BASE_IMAGE_TAG: '25.06-cuda12.9-devel-ubuntu24.04'
      RUNTIME_IMAGE_TAG: '12.9.0-runtime-ubuntu24.04'
      CUDA_VERSION: '129'
      TORCH_BACKEND: 'cu129'
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials (OIDC)
        if: secrets.AWS_NIGHTLY_ROLE != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_NIGHTLY_ROLE }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Configure AWS credentials (static keys)
        if: secrets.AWS_NIGHTLY_ROLE == '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Build Docker Image
        id: build
        uses: ./.github/actions/docker-build
        with:
          framework: ${{ env.FRAMEWORK }}
          target: runtime
          platform: linux/${{ env.ARCH }}
          base_image_tag: ${{ env.BASE_IMAGE_TAG }}
          runtime_image_tag: ${{ env.RUNTIME_IMAGE_TAG }}
          cuda_version: ${{ env.CUDA_VERSION }}
          torch_backend: ${{ env.TORCH_BACKEND }}
          ngc_ci_access_token: ${{ secrets.NGC_CI_ACCESS_TOKEN }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
      - name: Tag and Push Nightly Images
        uses: ./.github/actions/docker-tag-push
        with:
          local_image: ${{ steps.build.outputs.image_tag }}
          push_tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}
            ${{ env.REGISTRY_IMAGE }}:${{ env.NIGHTLY_IMAGE_PREFIX }}-${{ env.FRAMEWORK }}-${{ env.ARCH }}-run-${{ github.run_id }}
          aws_push: 'true'
          azure_push: 'true'
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_default_region: ${{ env.AWS_DEFAULT_REGION }}
          azure_acr_hostname: ${{ env.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

############################## TEST JOBS ##############################

  unit-vllm-amd64:
    name: Unit vLLM (amd64)
    needs: build-vllm-amd64
    runs-on: cpu-amd-m5-2xlarge
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
          pytest_marks: "vllm and unit and nightly"
          framework: vllm
          test_type: unit
          platform_arch: amd64

  unit-vllm-arm64:
    name: Unit vLLM (arm64)
    needs: build-vllm-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-arm64
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-arm64
          pytest_marks: "vllm and unit and nightly"
          framework: vllm
          test_type: unit
          platform_arch: arm64

  unit-trtllm-amd64:
    name: Unit TRTLLM (amd64)
    needs: build-trtllm-amd64
    runs-on: cpu-amd-m5-2xlarge
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
          pytest_marks: "trtllm and unit and nightly"
          framework: trtllm
          test_type: unit
          platform_arch: amd64

  unit-trtllm-arm64:
    name: Unit TRTLLM (arm64)
    needs: build-trtllm-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-arm64
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-arm64
          pytest_marks: "trtllm and unit and nightly"
          framework: trtllm
          test_type: unit
          platform_arch: arm64

  unit-sglang-amd64:
    name: Unit SGLang (amd64)
    needs: build-sglang-amd64
    runs-on: cpu-amd-m5-2xlarge
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
          pytest_marks: "sglang and unit and nightly"
          framework: sglang
          test_type: unit
          platform_arch: amd64

  unit-sglang-arm64:
    name: Unit SGLang (arm64)
    needs: build-sglang-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-arm64
      - name: Run Unit Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-arm64
          pytest_marks: "sglang and unit and nightly"
          framework: sglang
          test_type: unit
          platform_arch: arm64

  integration-vllm-amd64:
    name: Integration vLLM (amd64)
    needs: build-vllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
      - name: Run Integration Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
          pytest_marks: "vllm and integration and nightly"
          framework: vllm
          test_type: integration
          platform_arch: amd64

  integration-trtllm-amd64:
    name: Integration TRTLLM (amd64)
    needs: build-trtllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
      - name: Run Integration Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
          pytest_marks: "trtllm and integration and nightly"
          framework: trtllm
          test_type: integration
          platform_arch: amd64

  integration-sglang-amd64:
    name: Integration SGLang (amd64)
    needs: build-sglang-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
      - name: Run Integration Tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
          pytest_marks: "sglang and integration and nightly"
          framework: sglang
          test_type: integration
          platform_arch: amd64

  e2e-single-vllm-amd64:
    name: E2E Single GPU vLLM (amd64)
    needs: build-vllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
      - name: Run E2E Tests (gpu_1)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
          pytest_marks: "nightly and vllm and e2e and gpu_1"
          framework: vllm
          test_type: e2e
          platform_arch: amd64

  e2e-single-trtllm-amd64:
    name: E2E Single GPU TRTLLM (amd64)
    needs: build-trtllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
      - name: Run E2E Tests (gpu_1)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
          pytest_marks: "nightly and trtllm and e2e and gpu_1"
          framework: trtllm
          test_type: e2e
          platform_arch: amd64

  e2e-single-sglang-amd64:
    name: E2E Single GPU SGLang (amd64)
    needs: build-sglang-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
      - name: Run E2E Tests (gpu_1)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
          pytest_marks: "nightly and sglang and e2e and gpu_1"
          framework: sglang
          test_type: e2e
          platform_arch: amd64

  e2e-multi-vllm-amd64:
    name: E2E Multi GPU vLLM (amd64)
    needs: build-vllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 150
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
      - name: Run E2E Tests (gpu_2)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
          pytest_marks: "nightly and vllm and e2e and gpu_2"
          framework: vllm
          test_type: e2e
          platform_arch: amd64

  e2e-multi-trtllm-amd64:
    name: E2E Multi GPU TRTLLM (amd64)
    needs: build-trtllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 150
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
      - name: Run E2E Tests (gpu_2)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
          pytest_marks: "nightly and trtllm and e2e and gpu_2"
          framework: trtllm
          test_type: e2e
          platform_arch: amd64

  e2e-multi-sglang-amd64:
    name: E2E Multi GPU SGLang (amd64)
    needs: build-sglang-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 150
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
      - name: Run E2E Tests (gpu_2)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
          pytest_marks: "nightly and sglang and e2e and gpu_2"
          framework: sglang
          test_type: e2e
          platform_arch: amd64

  component-vllm-amd64-router:
    name: Component vLLM router (amd64)
    needs: build-vllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
          pytest_marks: "nightly and router"
          framework: vllm
          test_type: component
          platform_arch: amd64

  component-vllm-amd64-planner:
    name: Component vLLM planner (amd64)
    needs: build-vllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
          pytest_marks: "nightly and planner"
          framework: vllm
          test_type: component
          platform_arch: amd64

  component-vllm-amd64-kvbm:
    name: Component vLLM kvbm (amd64)
    needs: build-vllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-amd64
          pytest_marks: "nightly and kvbm and not slow"
          framework: vllm
          test_type: component
          platform_arch: amd64

  component-vllm-arm64-router:
    name: Component vLLM router (arm64)
    needs: build-vllm-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-arm64
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-arm64
          pytest_marks: "nightly and router"
          framework: vllm
          test_type: component
          platform_arch: arm64

  component-vllm-arm64-planner:
    name: Component vLLM planner (arm64)
    needs: build-vllm-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-arm64
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-arm64
          pytest_marks: "nightly and planner"
          framework: vllm
          test_type: component
          platform_arch: arm64

  component-vllm-arm64-kvbm:
    name: Component vLLM kvbm (arm64)
    needs: build-vllm-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-arm64
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-vllm-arm64
          pytest_marks: "nightly and kvbm"
          framework: vllm
          test_type: component
          platform_arch: arm64

  component-trtllm-amd64-router:
    name: Component TRTLLM router (amd64)
    needs: build-trtllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
          pytest_marks: "nightly and router"
          framework: trtllm
          test_type: component
          platform_arch: amd64

  component-trtllm-amd64-planner:
    name: Component TRTLLM planner (amd64)
    needs: build-trtllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
          pytest_marks: "nightly and planner"
          framework: trtllm
          test_type: component
          platform_arch: amd64

  component-trtllm-amd64-kvbm:
    name: Component TRTLLM kvbm (amd64)
    needs: build-trtllm-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-amd64
          pytest_marks: "nightly and kvbm"
          framework: trtllm
          test_type: component
          platform_arch: amd64

  component-trtllm-arm64-router:
    name: Component TRTLLM router (arm64)
    needs: build-trtllm-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-arm64
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-arm64
          pytest_marks: "nightly and router"
          framework: trtllm
          test_type: component
          platform_arch: arm64

  component-trtllm-arm64-planner:
    name: Component TRTLLM planner (arm64)
    needs: build-trtllm-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-arm64
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-arm64
          pytest_marks: "nightly and planner"
          framework: trtllm
          test_type: component
          platform_arch: arm64

  component-trtllm-arm64-kvbm:
    name: Component TRTLLM kvbm (arm64)
    needs: build-trtllm-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-arm64
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-trtllm-arm64
          pytest_marks: "nightly and kvbm"
          framework: trtllm
          test_type: component
          platform_arch: arm64

  component-sglang-amd64-router:
    name: Component SGLang router (amd64)
    needs: build-sglang-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
          pytest_marks: "nightly and router"
          framework: sglang
          test_type: component
          platform_arch: amd64

  component-sglang-amd64-planner:
    name: Component SGLang planner (amd64)
    needs: build-sglang-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
          pytest_marks: "nightly and planner"
          framework: sglang
          test_type: component
          platform_arch: amd64

  component-sglang-amd64-kvbm:
    name: Component SGLang kvbm (amd64)
    needs: build-sglang-amd64
    runs-on: gpu-l40-amd64
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-amd64
          pytest_marks: "nightly and kvbm"
          framework: sglang
          test_type: component
          platform_arch: amd64

  component-sglang-arm64-router:
    name: Component SGLang router (arm64)
    needs: build-sglang-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-arm64
      - name: Run Component Tests (router)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-arm64
          pytest_marks: "nightly and router"
          framework: sglang
          test_type: component
          platform_arch: arm64

  component-sglang-arm64-planner:
    name: Component SGLang planner (arm64)
    needs: build-sglang-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-arm64
      - name: Run Component Tests (planner)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-arm64
          pytest_marks: "nightly and planner"
          framework: sglang
          test_type: component
          platform_arch: arm64

  component-sglang-arm64-kvbm:
    name: Component SGLang kvbm (arm64)
    needs: build-sglang-arm64
    runs-on: cpu-arm-r8g-4xlarge
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Pull nightly image
        uses: ./.github/actions/docker-pull-image
        with:
          provider: 'aws'
          repository: ${{ env.REGISTRY_IMAGE }}
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-arm64
      - name: Run Component Tests (kvbm)
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ env.NIGHTLY_IMAGE_PREFIX }}-sglang-arm64
          pytest_marks: "nightly and kvbm"
          framework: sglang
          test_type: component
          platform_arch: arm64

  ############################## RESULTS SUMMARY ##############################
  #TODO: Update this to add links to the jobs and add more details.
  results-summary:
    name: Results Summary
    runs-on: ubuntu-latest
    if: always()
    needs:
      - build-vllm-amd64
      - build-vllm-arm64
      - build-trtllm-amd64
      - build-trtllm-arm64
      - build-sglang-amd64
      - build-sglang-arm64
      - unit-vllm-amd64
      - unit-vllm-arm64
      - unit-trtllm-amd64
      - unit-trtllm-arm64
      - unit-sglang-amd64
      - unit-sglang-arm64
      - integration-vllm-amd64
      - integration-trtllm-amd64
      - integration-sglang-amd64
      - e2e-single-vllm-amd64
      - e2e-single-trtllm-amd64
      - e2e-single-sglang-amd64
      - e2e-multi-vllm-amd64
      - e2e-multi-trtllm-amd64
      - e2e-multi-sglang-amd64
      - component-vllm-amd64-router
      - component-vllm-amd64-planner
      - component-vllm-amd64-kvbm
      - component-vllm-arm64-router
      - component-vllm-arm64-planner
      - component-vllm-arm64-kvbm
      - component-trtllm-amd64-router
      - component-trtllm-amd64-planner
      - component-trtllm-amd64-kvbm
      - component-trtllm-arm64-router
      - component-trtllm-arm64-planner
      - component-trtllm-arm64-kvbm
      - component-sglang-amd64-router
      - component-sglang-amd64-planner
      - component-sglang-amd64-kvbm
      - component-sglang-arm64-router
      - component-sglang-arm64-planner
      - component-sglang-arm64-kvbm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Gather job metadata
        id: gather
        run: |
          set -e
          echo "# Nightly CI Results Summary" > results.md
          echo "" >> results.md
          echo "| Stage            | Status   | Runner                | Duration (min) | Artifacts                  |" >> results.md
          echo "|------------------|----------|-----------------------|----------------|----------------------------|" >> results.md

          gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs -q ".jobs[] | {id, name, runner_name, conclusion, started_at, completed_at}" > jobs.jsonl

          while read job_entry; do
            job_id=$(echo "$job_entry" | jq -r '.id')
            name=$(echo "$job_entry" | jq -r '.name')
            runner=$(echo "$job_entry" | jq -r '.runner_name')
            status=$(echo "$job_entry" | jq -r '.conclusion')
            started=$(echo "$job_entry" | jq -r '.started_at')
            completed=$(echo "$job_entry" | jq -r '.completed_at')
            minutes="N/A"
            if [[ "$started" != "null" && "$completed" != "null" ]]; then
              start_epoch=$(date -d "$started" +%s)
              end_epoch=$(date -d "$completed" +%s)
              minutes=$(( (end_epoch - start_epoch)/60 ))
            fi
            artifact_link="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#job-$job_id"
            printf "| %s | %s | %s | %s | [Log & Artifacts](%s) |\n" "$name" "$status" "$runner" "$minutes" "$artifact_link" >> results.md
          done < jobs.jsonl

          echo "" >> results.md
          echo "---" >> results.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Display workflow summary
        run: cat results.md
      - name: Upload results summary as job summary
        run: cat results.md >> $GITHUB_STEP_SUMMARY
      - name: Upload results as artifact for Slack
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-results-summary
          path: results.md
          retention-days: 7

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'schedule' && !github.event.repository.fork && secrets.SLACK_NOTIFY_NIGHTLY_WEBHOOK_URL != ''
    needs: results-summary
    permissions:
      contents: read
    steps:
      - name: Send Slack notification
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NOTIFY_NIGHTLY_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          JOBS_JSON=$(mktemp)
          gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs --paginate > "$JOBS_JSON"

          FAIL_BLOCK=$(jq -r '.jobs[] | select(.conclusion != "success" and .conclusion != "skipped" and .conclusion != null) |
             "â€¢ " + .name + " (status: " + (.conclusion // "unknown") + ")"' "$JOBS_JSON")

          SUMMARY="Nightly CI results: ${RUN_URL}\n\n"
          if [ -z "${FAIL_BLOCK}" ]; then
            SUMMARY+="All jobs succeeded."
          else
            SUMMARY+="Failing jobs:\n${FAIL_BLOCK}"
          fi

          PAYLOAD=$(jq -n --arg text "$SUMMARY" '{text: $text}')

          send_slack() {
            retry=0
            until [ $retry -ge 3 ]; do
              if curl -sSf -X POST -H "Content-Type: application/json" -d="$PAYLOAD" "$SLACK_WEBHOOK_URL" > /dev/null; then
                echo "Slack notification sent"
                return 0
              fi
              retry=$((retry+1))
              echo "Slack notification failed (attempt ${retry}/3). Retrying in 10s..."
              sleep 10
            done
            echo "Warning: Slack notification failed after 3 attempts" >&2
            return 0
          }

          set +x
          send_slack