# SPDX-FileCopyrightText: Copyright (c) 2024-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Release RC Announcement

on:
  # Runs every weekday at 9 AM PST (17:00 UTC)
  # Note: During daylight saving time (PDT), this will be 10 AM local time
  schedule:
    - cron: '0 17 * * 1-5'
  # Allow manual trigger for testing
  workflow_dispatch:
  push:
    branches:
      - pvijayakrish/automate-release-announcement

permissions:
  contents: read

jobs:
  announce-rc:
    name: Announce RC to Slack
    runs-on: prod-builder-amd-v1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read release variables
        id: vars
        uses: ./.github/actions/read-release-vars

      - name: Send Slack announcement
        if: steps.vars.outputs.announce_rc == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.RELEASE_WEBHOOK_URL }}
          VERSIONS_FILE: ${{ steps.vars.outputs.release_versions_file }}
        run: |
          set -euo pipefail
          [ -n "${SLACK_WEBHOOK_URL:-}" ] || { echo "Error: RELEASE_WEBHOOK_URL not configured"; exit 1; }

          for VERSION in $(jq -r '.[]' "$VERSIONS_FILE"); do
            MSG="Next RC for dynamo ${VERSION} will be started at 3 pm PST today. Ensure the CPs are mergeable and updated in release canvas for QA verification."
            if curl -sSf -X POST -H "Content-Type: application/json" \
              -d "$(jq -n --arg t "$MSG" '{text:$t}')" "$SLACK_WEBHOOK_URL" 2>/dev/null; then
              echo "Sent announcement for ${VERSION}"
            else
              echo "Failed to send announcement for ${VERSION}" >&2; exit 1
            fi
          done