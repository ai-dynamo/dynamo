# SPDX-FileCopyrightText: Copyright (c) 2024-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Classify Workflow Errors (Reusable)

on:
  workflow_call:
    inputs:
      python_version:
        description: 'Python version to use'
        type: string
        default: '3.11'
      max_parallel_jobs:
        description: 'Max parallel jobs to analyze'
        type: string
        default: '5'
      enable_pr_comments:
        description: 'Enable PR comments'
        type: string
        default: 'true'
      nvidia_inference_model:
        description: 'Override LLM model (defaults to repo var NVIDIA_INFERENCE_MODEL)'
        required: false
        type: string
        default: ''
    secrets:
      NVIDIA_INFERENCE_API_KEY:
        required: false
      GITHUB_TOKEN:
        required: true

jobs:
  classify-workflow-errors:
    name: Classify All Workflow Errors
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y python3-venv || true
          python3 -m venv /tmp/error-classification-venv
          . /tmp/error-classification-venv/bin/activate
          pip install -r error_classification/requirements.txt

      - name: Classify Workflow Errors
        continue-on-error: true
        env:
          NVIDIA_INFERENCE_API_KEY: ${{ secrets.NVIDIA_INFERENCE_API_KEY }}
          NVIDIA_INFERENCE_MODEL: ${{ inputs.nvidia_inference_model || vars.NVIDIA_INFERENCE_MODEL }}
          API_FORMAT: "openai"
          API_BASE_URL: "https://inference-api.nvidia.com/v1"
          ENABLE_ERROR_CLASSIFICATION: "true"
          ENABLE_PR_COMMENTS: ${{ inputs.enable_pr_comments }}
          MAX_PARALLEL_JOBS: ${{ inputs.max_parallel_jobs }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          . /tmp/error-classification-venv/bin/activate
          python3 .github/scripts/classify_workflow_errors.py
