# SPDX-FileCopyrightText: Copyright (c) 2024-2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Build, Test, and Copy Framework Image

on:
  workflow_call:
    inputs:
      framework:
        description: 'Framework name (vllm, sglang, trtllm)'
        required: true
        type: string
      arm_base_image_tag:
        description: 'ARM64 base image tag override'
        required: false
        type: string
        default: ''
      arm_runtime_image_tag:
        description: 'ARM64 runtime image tag override'
        required: false
        type: string
        default: ''
      arm_cuda_version:
        description: 'ARM64 CUDA version override'
        required: false
        type: string
        default: ''
      arm_torch_backend:
        description: 'ARM64 torch backend override'
        required: false
        type: string
        default: ''
      build_arm64:
        description: 'Whether to build ARM64 images'
        required: false
        type: boolean
        default: true
      run_tests:
        description: 'Whether to run pytest'
        required: false
        type: boolean
        default: true
      copy_to_acr:
        description: 'Whether to copy images to ACR'
        required: false
        type: boolean
        default: true
      builder_name:
        description: 'Buildkit builder name'
        required: true
        type: string
      extra_tags:
        description: 'Additional tags (newline-separated, -$platform suffix auto-appended)'
        required: false
        type: string
        default: ''
      build_image:
        description: 'Whether to build image'
        required: false
        type: boolean
        default: true
      no_cache:
        description: 'Disable Docker build cache'
        required: false
        type: boolean
        default: false
      push_image:
        description: 'Push image to registry'
        required: false
        type: boolean
        default: true
      no_load:
        description: 'Do not load the image into docker (useful for validation-only builds with remote builders)'
        required: false
        type: boolean
        default: false
    secrets:
      AWS_DEFAULT_REGION:
        required: true
      AWS_ACCOUNT_ID:
        required: true
      AZURE_ACR_HOSTNAME:
        required: true
      AZURE_ACR_USER:
        required: true
      AZURE_ACR_PASSWORD:
        required: true
      CI_TOKEN:
        required: false
      SCCACHE_S3_BUCKET:
        required: false
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false
    outputs:
      image_tag_amd64:
        description: 'AMD64 image tag in ACR'
        value: ${{ jobs.copy-to-acr.outputs.target_tag_plain }}-amd64 }}
      image_tag_arm64:
        description: 'ARM64 image tag in ACR'
        value: ${{ jobs.copy-to-acr.outputs.target_tag_plain }}-arm64 }}

jobs:
  # ============================================================================
  # BUILD
  # ============================================================================
  build:
    if: inputs.build_image
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJSON(inputs.build_arm64 && '["amd64", "arm64"]' || '["amd64"]') }}
    name: build ${{ inputs.framework }}-${{ matrix.platform }}
    runs-on: builder-cpu-amd-runner
    outputs:
      target_tag_plain: ${{ steps.calculate-target-tag.outputs.target_tag_plain }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0

      - name: Calculate extra tags with platform suffix # will get redundant upon multi arch builds support
        id: extra-tags
        shell: bash
        env:
          EXTRA_TAGS: ${{ inputs.extra_tags }}
          PLATFORM: ${{ matrix.platform }}
        run: |
          if [ -n "$EXTRA_TAGS" ]; then
            RESULT=""
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                RESULT+="${tag}-${PLATFORM}"$'\n'
              fi
            done <<< "$EXTRA_TAGS"
            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "$RESULT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "tags=" >> $GITHUB_OUTPUT
          fi

      - name: Route buildkit workers
        id: route-buildkit
        continue-on-error: true
        shell: bash
        run: .github/scripts/route_buildkit.sh --arch ${{ matrix.platform }} --flavor ${{ inputs.framework }}

      - name: Bootstrap Buildkit
        uses: ./.github/actions/bootstrap-buildkit
        with:
          builder_name: ${{ inputs.builder_name }}
          buildkit_worker_addresses: ${{ steps.route-buildkit.outputs[format('{0}_{1}', inputs.framework, matrix.platform)] }}
          platform: linux/${{ matrix.platform }}

      - name: Docker Login
        uses: ./.github/actions/docker-login
        with:
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

      - name: Calculate target tag
        id: calculate-target-tag
        shell: bash
        run: |
          TARGET_TAG_PLAIN="${{ github.sha }}-${{ inputs.framework }}"
          echo "target_tag_plain=${TARGET_TAG_PLAIN}" >> $GITHUB_OUTPUT

      - name: Build Container
        id: build-image
        uses: ./.github/actions/docker-build
        with:
          image_tag: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/ai-dynamo/dynamo:${{ steps.calculate-target-tag.outputs.target_tag_plain }}-${{ matrix.platform }}
          framework: ${{ inputs.framework }}
          target: runtime
          platform: linux/${{ matrix.platform }}
          base_image_tag: ${{ matrix.platform == 'arm64' && inputs.arm_base_image_tag || '' }}
          runtime_image_tag: ${{ matrix.platform == 'arm64' && inputs.arm_runtime_image_tag || '' }}
          cuda_version: ${{ matrix.platform == 'arm64' && inputs.arm_cuda_version || '' }}
          torch_backend: ${{ matrix.platform == 'arm64' && inputs.arm_torch_backend || '' }}
          ci_token: ${{ secrets.CI_TOKEN }}
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          sccache_s3_bucket: ${{ secrets.SCCACHE_S3_BUCKET }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          no_cache: ${{ inputs.no_cache }}
          extra_tags: ${{ steps.extra-tags.outputs.tags }}
          push_image: ${{ inputs.push_image }}
          no_load: ${{ inputs.no_load }}

  # ============================================================================
  # TEST
  # ============================================================================
  test:
    if: inputs.run_tests
    needs: [build]
    name: test ${{ inputs.framework }}-amd64
    runs-on: gpu-l40-amd64
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0

      - name: Docker Login
        uses: ./.github/actions/docker-login
        with:
          aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}

      - name: Run tests
        uses: ./.github/actions/pytest
        with:
          image_tag: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/ai-dynamo/dynamo:${{ needs.build.outputs.target_tag_plain }}-amd64
          pytest_marks: "pre_merge and ${{ inputs.framework }} and (gpu_0 or gpu_1)"
          framework: ${{ inputs.framework }}
          test_type: "pre_merge"
          platform_arch: amd64
          enable_mypy: 'true'

  # ============================================================================
  # COPY TO ACR
  # ============================================================================
  copy-to-acr:
    needs: [build, test]
    # Run if copy_to_acr is true AND build succeeded AND (test succeeded OR test was skipped)
    if: |
      always() &&
      inputs.copy_to_acr &&
      needs.build.result == 'success' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    strategy:
      fail-fast: true
      matrix:
        platform: ${{ fromJSON(inputs.build_arm64 && '["amd64", "arm64"]' || '["amd64"]') }}
    name: copy ${{ inputs.framework }}-${{ matrix.platform }}
    runs-on: builder-cpu-amd-runner
    outputs:
      target_tag_plain: ${{ needs.build.outputs.target_tag_plain }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0

      - name: Copy image to target registry
        uses: ./.github/actions/skopeo-copy
        with:
          source_registry: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com
          source_image: ai-dynamo/dynamo
          source_tag: ${{ needs.build.outputs.target_tag_plain }}-${{ matrix.platform }}
          target_registry: ${{ secrets.AZURE_ACR_HOSTNAME }}
          target_image: ai-dynamo/dynamo
          target_tag: ${{ needs.build.outputs.target_tag_plain }}-${{ matrix.platform }}
          source_aws_default_region: ${{ secrets.AWS_DEFAULT_REGION }}
          source_aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          target_azure_acr_hostname: ${{ secrets.AZURE_ACR_HOSTNAME }}
          target_azure_acr_user: ${{ secrets.AZURE_ACR_USER }}
          target_azure_acr_password: ${{ secrets.AZURE_ACR_PASSWORD }}
