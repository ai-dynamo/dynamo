# SPDX-FileCopyrightText: Copyright (c) 2024-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: kvbm-kernels CUDA Tests

on:
  push:
    branches:
      - main
      - release/*.*.*
    paths:
      - 'lib/kvbm-kernels/**'
      - 'lib/kvbm-physical/**'
      - '.github/workflows/kvbm-kernels-cuda-tests.yml'
  pull_request:
    paths:
      - 'lib/kvbm-kernels/**'
      - 'lib/kvbm-physical/**'
      - '.github/workflows/kvbm-kernels-cuda-tests.yml'

concurrency:
  group: ${{ github.event_name == 'pull_request' && format('{0}-{1}', github.workflow, github.event.pull_request.number) || format('{0}-{1}', github.workflow, github.run_id) }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  cuda-test:
    name: CUDA ${{ matrix.cuda_version }}
    runs-on: prod-tester-amd-gpu-v1
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - cuda_version: "12.8"
            cuda_image: nvidia/cuda:12.8.1-devel-ubuntu24.04
          - cuda_version: "12.9"
            cuda_image: nvidia/cuda:12.9.0-devel-ubuntu24.04
          - cuda_version: "13.0"
            cuda_image: nvidia/cuda:13.0.0-devel-ubuntu24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Build and test in CUDA ${{ matrix.cuda_version }} container
        run: |
          docker run --rm --gpus all \
            -v "${{ github.workspace }}:/workspace:ro" \
            ${{ matrix.cuda_image }} \
            bash -c '
              set -euo pipefail

              # Install build dependencies
              apt-get update -qq && apt-get install -y -qq curl build-essential pkg-config > /dev/null

              # Install Rust via rustup
              curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
              source "$HOME/.cargo/env"

              # Report versions
              nvcc --version
              rustc --version
              cargo --version

              # Copy source to writable location (workspace is ro-mounted)
              cp -a /workspace /tmp/build
              cd /tmp/build/lib/kvbm-kernels

              # Build tests (auto-detects CUDA version from nvcc)
              echo "::group::cargo test --no-run"
              cargo test --all-features -p kvbm-kernels --no-run 2>&1
              cargo test --all-features -p kvbm-physical --no-run 2>&1
              echo "::endgroup::"

              # Run tests
              echo "::group::cargo test"
              cargo test --all-features -p kvbm-kernels -- --nocapture 2>&1
              cargo test --all-features -p kvbm-physical -- --nocapture 2>&1
              echo "::endgroup::"
            '

  status-check:
    name: kvbm-kernels CUDA Status
    runs-on: ubuntu-latest
    needs: [cuda-test]
    if: always()
    steps:
      - name: Check all matrix jobs passed
        run: |
          echo '${{ toJson(needs) }}' | jq -e 'to_entries | map(.value.result) | all(. == "success")'
