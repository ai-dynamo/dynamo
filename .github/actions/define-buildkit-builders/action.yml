name: 'Define Buildkit Builders'
description: 'Create Kubernetes-based Docker Buildx builders for multiple platforms'

inputs:
  builder_name:
    description: 'Builder name'
    required: true
  replicas:
    description: 'Number of replicas per platform'
    required: false
    default: '4'
  linux_amd64:
    description: 'Enable linux/amd64 builder (CPU nodes)'
    required: false
    default: 'true'
  linux_amd64_gpu:
    description: 'Enable linux/amd64 builder (GPU L40 nodes)'
    required: false
    default: 'false'
  linux_arm64:
    description: 'Enable linux/arm64 builder'
    required: false
    default: 'true'

runs:
  using: 'composite'
  steps:
    - name: Define amd64 builder
      if: inputs.linux_amd64 == 'true'
      uses: ./.github/actions/buildkit-builder
      with:
        builder_name: ${{ inputs.builder_name }}
        mode: create
        platform: linux/amd64
        replicas: ${{ inputs.replicas }}
        nodeselector: 'eks.amazonaws.com/nodegroup=cpu-amd-m5-2xlarge,kubernetes.io/arch=amd64'
        tolerations: 'key=nodepool,value=build-nodes,effect=NoSchedule'
        ephemeral_storage: '30Gi'
        requests_cpu: '5'
        requests_memory: '16Gi'
        limits_memory: '24Gi'

    - name: Define amd64 GPU builder
      if: inputs.linux_amd64_gpu == 'true'
      uses: ./.github/actions/buildkit-builder
      with:
        builder_name: ${{ inputs.builder_name }}
        mode: ${{ inputs.linux_amd64 == 'true' && 'append' || 'create' }}
        platform: linux/amd64
        replicas: ${{ inputs.replicas }}
        nodeselector: 'eks.amazonaws.com/nodegroup=gpu-l40-g6-4xlarge,kubernetes.io/arch=amd64'
        tolerations: 'key=nodepool,value=build-nodes,effect=NoSchedule'
        ephemeral_storage: '220Gi'
        requests_cpu: '8'
        requests_memory: '48Gi'
        limits_memory: '52Gi'

    - name: Define arm64 builder
      if: inputs.linux_arm64 == 'true'
      uses: ./.github/actions/buildkit-builder
      with:
        builder_name: ${{ inputs.builder_name }}
        mode: ${{ (inputs.linux_amd64 == 'true' || inputs.linux_amd64_gpu == 'true') && 'append' || 'create' }}
        platform: linux/arm64
        replicas: ${{ inputs.replicas }}
        nodeselector: 'eks.amazonaws.com/nodegroup=cpu-arm-r8g-4xlarge,kubernetes.io/arch=arm64'
        tolerations: 'key=nodepool,value=build-nodes,effect=NoSchedule'
        ephemeral_storage: '140Gi'
        requests_cpu: '8'
        requests_memory: '48Gi'
        limits_memory: '52Gi'

    - name: Inspect Buildkit Builders
      shell: bash
      run: |
        docker buildx inspect