name: 'Skopeo Login'
description: 'Login to multiple container registries using skopeo (ECR, NGC, ACR)'

inputs:
  ngc_ci_access_token:
    description: 'NGC CI Access Token'
    required: false
  aws_default_region:
    description: 'AWS Default Region'
    required: false
  aws_account_id:
    description: 'AWS Account ID'
    required: false
  azure_acr_hostname:
    description: 'Azure ACR hostname'
    required: false
  azure_acr_user:
    description: 'Azure ACR user'
    required: false
  azure_acr_password:
    description: 'Azure ACR password'
    required: false

runs:
  using: "composite"
  steps:
    - name: Install skopeo
      shell: bash
      run: |
        if ! command -v skopeo &> /dev/null; then
          echo "Installing skopeo..."
          if [ -f /etc/debian_version ]; then
            sudo apt-get update && sudo apt-get install -y skopeo
          elif [ -f /etc/redhat-release ]; then
            sudo dnf install -y skopeo
          else
            echo "Unsupported OS for automatic skopeo installation"
            exit 1
          fi
        else
          echo "skopeo is already installed"
        fi
        skopeo --version

    - name: ECR Login
      shell: bash
      if: ${{ inputs.aws_default_region != '' && inputs.aws_account_id != '' }}
      env:
        ECR_HOSTNAME: ${{ inputs.aws_account_id }}.dkr.ecr.${{ inputs.aws_default_region }}.amazonaws.com
      run: |
        set -euo pipefail
        aws ecr get-login-password --region ${{ inputs.aws_default_region }} | skopeo login --username AWS --password-stdin "${ECR_HOSTNAME}"

    - name: NGC Login
      if: ${{ inputs.ngc_ci_access_token != '' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "${{ inputs.ngc_ci_access_token }}" | skopeo login nvcr.io -u '$oauthtoken' --password-stdin

    - name: ACR Login
      shell: bash
      if: ${{ inputs.azure_acr_hostname != '' && inputs.azure_acr_user != '' && inputs.azure_acr_password != '' }}
      run: |
        set -euo pipefail
        echo "${{ inputs.azure_acr_password }}" | skopeo login "${{ inputs.azure_acr_hostname }}" --username "${{ inputs.azure_acr_user }}" --password-stdin
