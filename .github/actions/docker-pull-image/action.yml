name: 'Pull Docker Image'
description: 'Login to a registry and pull a tagged image into the local cache'
inputs:
  image_tag:
    description: 'Local image tag (e.g., nightly-vllm-amd64)'
    required: true
  repository:
    description: 'Repository path (default ai-dynamo/dynamo)'
    required: false
    default: 'ai-dynamo/dynamo'
  provider:
    description: 'Registry provider: azure | aws'
    required: false
    default: 'azure'
  # Azure inputs
  azure_acr_hostname:
    description: 'Azure ACR hostname'
    required: false
  azure_acr_user:
    description: 'Azure ACR username'
    required: false
  azure_acr_password:
    description: 'Azure ACR password'
    required: false
  # AWS inputs
  aws_account_id:
    description: 'AWS Account ID'
    required: false
  aws_default_region:
    description: 'AWS Default Region'
    required: false
  aws_access_key_id:
    description: 'AWS Access Key ID'
    required: false
  aws_secret_access_key:
    description: 'AWS Secret Access Key'
    required: false

runs:
  using: "composite"
  steps:
    - name: Login to Azure ACR
      if: ${{ !(inputs.provider == 'aws' || env.PREFER_PROVIDER == 'aws' || inputs.aws_account_id != '') }}
      shell: bash
      env:
        AZURE_ACR_HOSTNAME: ${{ inputs.azure_acr_hostname || env.AZURE_ACR_HOSTNAME }}
      run: |
        set -euo pipefail
        echo "${{ inputs.azure_acr_password }}" | docker login "${AZURE_ACR_HOSTNAME}" --username ${{ inputs.azure_acr_user }} --password-stdin
    - name: Pull and tag image from ACR
      if: ${{ !(inputs.provider == 'aws' || env.PREFER_PROVIDER == 'aws' || inputs.aws_account_id != '') }}
      shell: bash
      env:
        AZURE_ACR_HOSTNAME: ${{ inputs.azure_acr_hostname || env.AZURE_ACR_HOSTNAME }}
      run: |
        set -euo pipefail
        docker pull "${AZURE_ACR_HOSTNAME}/${{ inputs.repository }}:${{ inputs.image_tag }}"
        docker tag "${AZURE_ACR_HOSTNAME}/${{ inputs.repository }}:${{ inputs.image_tag }}" ${{ inputs.image_tag }}

    - name: Login to AWS ECR
      if: ${{ inputs.provider == 'aws' || env.PREFER_PROVIDER == 'aws' || inputs.aws_account_id != '' }}
      shell: bash
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id || env.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key || env.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ inputs.aws_default_region || env.AWS_DEFAULT_REGION }}
        AWS_ACCOUNT_ID: ${{ inputs.aws_account_id || env.AWS_ACCOUNT_ID }}
      run: |
        set -euo pipefail
        aws ecr get-login-password --region "${AWS_DEFAULT_REGION}" | \
          docker login --username AWS --password-stdin "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
    - name: Pull and tag image from ECR
      if: ${{ inputs.provider == 'aws' || env.PREFER_PROVIDER == 'aws' || inputs.aws_account_id != '' }}
      shell: bash
      env:
        AWS_DEFAULT_REGION: ${{ inputs.aws_default_region || env.AWS_DEFAULT_REGION }}
        AWS_ACCOUNT_ID: ${{ inputs.aws_account_id || env.AWS_ACCOUNT_ID }}
      run: |
        set -euo pipefail
        ECR_HOSTNAME="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
        docker pull "${ECR_HOSTNAME}/${{ inputs.repository }}:${{ inputs.image_tag }}"
        docker tag "${ECR_HOSTNAME}/${{ inputs.repository }}:${{ inputs.image_tag }}" ${{ inputs.image_tag }}