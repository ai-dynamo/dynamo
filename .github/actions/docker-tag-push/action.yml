description: 'Tag and Push Docker Images'

inputs:
  local_image:
    description: 'Local Image Name:Tag'
    required: true
  push_tags:
    description: 'Target Name:Tag (newline-separated list for multiple tags)'
    required: true
  aws_push:
    description: 'Push to AWS Boolean'
    required: false
    default: 'false'
  azure_push:
    description: 'Push to Azure Container Registry (ACR) Boolean'
    required: false
    default: 'false'
  aws_account_id:
    description: 'AWS Account ID'
    required: false
  aws_default_region:
    description: 'AWS Default Region'
    required: false
  aws_access_key_id:
    description: 'AWS Access Key ID'
    required: false
  aws_secret_access_key:
    description: 'AWS Secret Access Key'
    required: false
  azure_acr_hostname:
    description: 'Azure ACR hostname'
    required: false
  azure_acr_user:
    description: 'Azure ACR user'
    required: false
  azure_acr_password:
    description: 'Azure ACR password'
    required: false

outputs:
  image_tags:
    description: 'Image Tags'
    value: ${{ inputs.push_tags }}

runs:
  using: "composite"
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ECR Login
      shell: bash
      if: ${{ inputs.aws_push == 'true' }}
      env:
        AWS_ACCOUNT_ID: ${{ inputs.aws_account_id || env.AWS_ACCOUNT_ID }}
        AWS_DEFAULT_REGION: ${{ inputs.aws_default_region || env.AWS_DEFAULT_REGION }}
        AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id || env.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key || env.AWS_SECRET_ACCESS_KEY }}
      run: |
        retry=0
        until [ $retry -ge 3 ]; do
          if aws ecr get-login-password --region "${AWS_DEFAULT_REGION}" | \
             docker login --username AWS --password-stdin "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"; then
            break
          fi
          retry=$((retry+1))
          echo "ECR login failed (attempt ${retry}/3). Retrying in 10s..."
          sleep 10
        done
        if [ $retry -ge 3 ]; then
          echo "ECR login failed after 3 attempts" >&2
          exit 1
        fi

    - name: ACR Login
      shell: bash
      if: ${{ inputs.azure_push == 'true' }}
      run: |
        retry=0
        until [ $retry -ge 3 ]; do
          if echo "${{ inputs.azure_acr_password }}" | docker login ${{ inputs.azure_acr_hostname || env.AZURE_ACR_HOSTNAME }} --username ${{ inputs.azure_acr_user }} --password-stdin; then
            break
          fi
          retry=$((retry+1))
          echo "ACR login failed (attempt ${retry}/3). Retrying in 10s..."
          sleep 10
        done
        if [ $retry -ge 3 ]; then
          echo "ACR login failed after 3 attempts" >&2
          exit 1
        fi

    - name: ECR Tag and Push
      shell: bash
      if: ${{ inputs.aws_push == 'true' }}
      env:
        LOCAL_IMAGE: ${{ inputs.local_image }}
        PUSH_TAGS: ${{ inputs.push_tags }}
        AWS_ACCOUNT_ID: ${{ inputs.aws_account_id || env.AWS_ACCOUNT_ID }}
        AWS_DEFAULT_REGION: ${{ inputs.aws_default_region || env.AWS_DEFAULT_REGION }}
      run: |
        ECR_HOSTNAME="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"

        while IFS= read -r TAG; do
          if [ -z "$TAG" ]; then
            continue
          fi
          echo "Tagging and pushing: ${ECR_HOSTNAME}/${TAG}"
          docker tag "${LOCAL_IMAGE}" "${ECR_HOSTNAME}/${TAG}"
          retry=0
          until [ $retry -ge 3 ]; do
            if docker push "${ECR_HOSTNAME}/${TAG}"; then
              break
            fi
            retry=$((retry+1))
            echo "ECR push failed (attempt ${retry}/3). Retrying in 15s..."
            sleep 15
          done
          if [ $retry -ge 3 ]; then
            echo "ECR push failed after 3 attempts" >&2
            exit 1
          fi
        done <<< "$PUSH_TAGS"

    - name: ACR Tag and Push
      shell: bash
      if: ${{ inputs.azure_push == 'true' }}
      env:
        LOCAL_IMAGE: ${{ inputs.local_image }}
        PUSH_TAGS: ${{ inputs.push_tags }}
        AZURE_ACR_HOSTNAME: ${{ inputs.azure_acr_hostname || env.AZURE_ACR_HOSTNAME }}
      run: |
        while IFS= read -r TAG; do
          if [ -z "$TAG" ]; then
            continue
          fi
          echo "Tagging and pushing: ${AZURE_ACR_HOSTNAME}/${TAG}"
          docker tag "${LOCAL_IMAGE}" "${AZURE_ACR_HOSTNAME}/${TAG}"
          retry=0
          until [ $retry -ge 3 ]; do
            if docker push "${AZURE_ACR_HOSTNAME}/${TAG}"; then
              break
            fi
            retry=$((retry+1))
            echo "ACR push failed (attempt ${retry}/3). Retrying in 15s..."
            sleep 15
          done
          if [ $retry -ge 3 ]; then
            echo "ACR push failed after 3 attempts" >&2
            exit 1
          fi
        done <<< "$PUSH_TAGS"
