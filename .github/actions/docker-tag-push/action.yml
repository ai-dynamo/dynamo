description: 'Tag and Push Docker Images'
inputs:
  local_image:
    description: 'Local Image Name:Tag'
    required: true
  push_tag:
    description: 'Target Tag for ECR'
    required: false
  aws_push:
    description: 'Push to AWS Boolean'
    required: false
    default: 'false'
  azure_push:
    description: 'Push to Azure Container Registry (ACR) Boolean'
    required: false
    default: 'false'
  aws_account_id:
    description: 'AWS Account ID'
    required: false
  aws_default_region:
    description: 'AWS Default Region'
    required: false
  aws_access_key_id:
    description: 'AWS Access Key ID'
    required: false
  aws_secret_access_key:
    description: 'AWS Secret Access Key'
    required: false
  azure_acr_hostname:
    description: 'Azure ACR hostname'
    required: false
  azure_acr_user:
    description: 'Azure ACR user'
    required: false
  azure_acr_password:
    description: 'Azure ACR password'
    required: false

env:
  AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id || '' }}
  AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key || '' }}
  AWS_REGION: ${{ inputs.aws_default_region || '' }}
  AWS_ACCOUNT_ID: ${{ inputs.aws_account_id || '' }}
  AWS_PUSH: ${{ inputs.aws_push || '' }}

  AZURE_ACR_USER: ${{ inputs.azure_acr_user || '' }}
  AZURE_ACR_PASSWORD: ${{ inputs.azure_acr_password || '' }}
  AZURE_ACR_HOSTNAME: ${{ inputs.azure_acr_hostname || '' }}
  ACR_PUSH: ${{ inputs.azure_push || '' }}

  LOCAL_IMAGE: ${{ inputs.local_image || '' }}
  PUSH_TAG: ${{ inputs.push_tag || '' }}

outputs:
  image_tag:
    description: 'Image Tag'
    value: ${{ inputs.push_tag }}

runs:
  using: "composite"
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    # - name: Install tools
    - name: ECR Login
      if: ${{ env.AWS_PUSH == 'true' }}
      env:
        ECR_HOSTNAME: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
      run: |
        aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_HOSTNAME}
    - name: ACR Login
      if: ${{ env.ACR_PUSH == 'true' }}
      run: |
        echo "${ACR_PASSWORD}" | docker login ${ACR_HOSTNAME} --username ${ACR_USER} --password-stdin
    - name: ECR Tag and Push
      if: ${{ env.AWS_PUSH == 'true' }}
      env:
        ECR_HOSTNAME: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
      run: |
        docker tag ${LOCAL_IMAGE} ${ECR_HOSTNAME}/${PUSH_TAG}
        docker push ${ECR_HOSTNAME}/${PUSH_TAG}
    - name: ACR Tag and Push
      if: ${{ env.ACR_PUSH == 'true' }}
      run: |
        docker tag ${LOCAL_IMAGE} ${ACR_HOSTNAME}/${PUSH_TAG}
        docker push ${ACR_HOSTNAME}/${PUSH_TAG}
