name: 'Dynamo Backend Validation'
description: 'Build and test container for a Dynamo backend'
inputs:
  framework:
    description: 'Framework to validate'
    required: true
    default: 'vllm'
  pytest_marks:
    description: 'Pytest marks'
    required: true
    default: 'e2e and vllm and gpu_1 and not slow'
  target:
    description: 'Target to build'
    required: false
    default: 'runtime'
  ngc_ci_access_token:
    description: 'NGC CI Access Token'
    required: true
  ci_token:
    description: 'CI Token'
    required: true
  aws_default_region:
    description: 'AWS Default Region'
    required: true
  sccache_s3_bucket:
    description: 'SCCache S3 Bucket'
    required: true
  aws_access_key_id:
    description: 'AWS Access Key ID'
    required: true
  aws_secret_access_key:
    description: 'AWS Secret Access Key'
    required: true    

runs:
  using: "composite"
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to NGC
      if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push'
      shell: bash
      run: |
        echo "${{ inputs.ngc_ci_access_token }}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
    - name: Cleanup
      if: always()
      shell: bash
      run: |
        docker system prune -af
    - name: Build image
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.ci_token }}
        AWS_DEFAULT_REGION: ${{ inputs.aws_default_region }}
        SCCACHE_S3_BUCKET:  ${{ inputs.sccache_s3_bucket }}
        AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
      run: |
        ./container/build.sh --tag ${{ inputs.framework }}:latest \
          --target ${{ inputs.target }} \
          --framework ${{ inputs.framework }} \
          --use-sccache \
          --sccache-bucket "$SCCACHE_S3_BUCKET" \
          --sccache-region "$AWS_DEFAULT_REGION"
    - name: Run pytest
      shell: bash
      env:
        CONTAINER_ID: test_${{ github.run_id }}_${{ github.run_attempt }}_${{ github.job }}_${{ inputs.framework }}
        PYTEST_XML_FILE: pytest_test_report.xml
      run: |
        docker run --runtime=nvidia --rm --gpus all -w /workspace \
          --network host \
          --name ${{ env.CONTAINER_ID }}_pytest \
          ${{ inputs.framework }}:latest \
          bash -c "pytest -xsv --basetemp=/tmp --junitxml=${{ env.PYTEST_XML_FILE }} -m \"${{ inputs.pytest_marks }}\""