# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

{{- if .Values.checkpoint.enabled }}
---
# Seccomp profile to block io_uring syscalls
# CRIU doesn't support io_uring memory mappings, so we block these syscalls
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "dynamo-operator.fullname" . }}-seccomp-block-iouring
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dynamo-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: checkpoint-agent
data:
  block-iouring.json: |
    {
      "defaultAction": "SCMP_ACT_ALLOW",
      "architectures": ["SCMP_ARCH_X86_64", "SCMP_ARCH_X86", "SCMP_ARCH_X32"],
      "syscalls": [
        {
          "names": ["io_uring_setup", "io_uring_enter", "io_uring_register"],
          "action": "SCMP_ACT_ERRNO",
          "comment": "Block io_uring syscalls - CRIU doesn't support io_uring memory mappings"
        }
      ]
    }
---
# ServiceAccount for checkpoint agent
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "dynamo-operator.fullname" . }}-checkpoint-agent
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dynamo-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: checkpoint-agent
---
# ClusterRole for checkpoint agent
# Needs to watch pods and update Checkpoint CR status
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "dynamo-operator.fullname" . }}-checkpoint-agent
  labels:
    {{- include "dynamo-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: checkpoint-agent
rules:
  # Watch pods on node to detect checkpoint-source pods becoming ready
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
---
# ClusterRoleBinding for checkpoint agent
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "dynamo-operator.fullname" . }}-checkpoint-agent
  labels:
    {{- include "dynamo-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: checkpoint-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "dynamo-operator.fullname" . }}-checkpoint-agent
subjects:
  - kind: ServiceAccount
    name: {{ include "dynamo-operator.fullname" . }}-checkpoint-agent
    namespace: {{ .Release.Namespace }}
---
# DaemonSet for checkpoint agent
# Runs on GPU nodes, watches for checkpoint-source pods, performs CRIU checkpointing
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "dynamo-operator.fullname" . }}-checkpoint-agent
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dynamo-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: checkpoint-agent
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: checkpoint-agent
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: checkpoint-agent
        app.kubernetes.io/instance: {{ .Release.Name }}
        {{- with .Values.checkpoint.agent.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with .Values.checkpoint.agent.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      serviceAccountName: {{ include "dynamo-operator.fullname" . }}-checkpoint-agent
      hostPID: true
      hostNetwork: true
      {{- with .Values.checkpoint.agent.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      tolerations:
        # Default tolerations to run on GPU nodes
        - operator: Exists
        {{- with .Values.checkpoint.agent.tolerations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with .Values.checkpoint.agent.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.checkpoint.agent.runtimeClassName }}
      # Use specified runtime class for GPU access (e.g., nvidia for CUDA checkpointing)
      runtimeClassName: {{ .Values.checkpoint.agent.runtimeClassName }}
      {{- end }}
      initContainers:
        # Deploy seccomp profile to host before starting the agent
        # This profile blocks io_uring syscalls that CRIU doesn't support
        - name: deploy-seccomp
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              mkdir -p /host-seccomp/profiles
              cp /seccomp-profiles/block-iouring.json /host-seccomp/profiles/block-iouring.json
              echo "Deployed seccomp profile to /var/lib/kubelet/seccomp/profiles/block-iouring.json"
          volumeMounts:
            - name: seccomp-profiles
              mountPath: /seccomp-profiles
              readOnly: true
            - name: host-seccomp
              mountPath: /host-seccomp
      containers:
        - name: agent
          image: "{{ .Values.checkpoint.agent.image.repository }}:{{ .Values.checkpoint.agent.image.tag }}"
          imagePullPolicy: {{ .Values.checkpoint.agent.image.pullPolicy }}
          securityContext:
            privileged: true
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            # Agent mode: use "watcher" to watch for labeled pods
            - name: CHECKPOINT_SIGNAL_FROM
              value: "watcher"
            # Checkpoint storage directory (PVC-only for now)
            - name: CHECKPOINT_DIR
              value: {{ .Values.checkpoint.storage.pvc.basePath | quote }}
            # Host proc mount point for CRIU operations
            - name: HOST_PROC
              value: "/host/proc"
            # Containerd socket path
            - name: CONTAINERD_SOCKET
              value: {{ .Values.checkpoint.agent.containerRuntimeSocket }}
            {{- if .Values.checkpoint.agent.cudaPluginDir }}
            # CUDA plugin directory for GPU checkpoint support
            - name: CUDA_PLUGIN_DIR
              value: {{ .Values.checkpoint.agent.cudaPluginDir | quote }}
            {{- end }}
            {{- if .Values.checkpoint.agent.criuGhostLimit }}
            # CRIU ghost file size limit in bytes
            - name: CRIU_GHOST_LIMIT
              value: {{ .Values.checkpoint.agent.criuGhostLimit | quote }}
            {{- end }}
            {{- if .Values.checkpoint.agent.criuTimeout }}
            # CRIU timeout in seconds
            - name: CRIU_TIMEOUT
              value: {{ .Values.checkpoint.agent.criuTimeout | quote }}
            {{- end }}
            # Keep for future S3/OCI support (not yet used by agent)
            - name: DYNAMO_CHECKPOINT_STORAGE_TYPE
              value: {{ .Values.checkpoint.storage.type | quote }}
          volumeMounts:
            {{- if eq .Values.checkpoint.storage.type "pvc" }}
            # Mount the checkpoint PVC (only for PVC storage type)
            - name: checkpoints
              mountPath: {{ .Values.checkpoint.storage.pvc.basePath }}
            {{- end }}
            # Mount containerd runtime directory for checkpoint operations
            - name: containerd-run
              mountPath: /run/containerd
            # Mount kubelet pods directory for volume discovery
            - name: kubelet-pods
              mountPath: /var/lib/kubelet/pods
              readOnly: true
            # Mount containerd storage for filesystem info
            - name: containerd-storage
              mountPath: /var/lib/containerd
              readOnly: true
            # Mount host proc for CRIU and signal file writing
            - name: host-proc
              mountPath: /host/proc
            # Mount host cgroup for CRIU
            - name: host-cgroup
              mountPath: /sys/fs/cgroup
              readOnly: true
            {{- if and (eq .Values.checkpoint.storage.type "oci") .Values.checkpoint.storage.oci.credentialsSecretRef }}
            # Mount docker config for OCI registry auth
            - name: docker-config
              mountPath: /root/.docker
              readOnly: true
            {{- end }}
          {{- if and (eq .Values.checkpoint.storage.type "s3") .Values.checkpoint.storage.s3.credentialsSecretRef }}
          envFrom:
            - secretRef:
                name: {{ .Values.checkpoint.storage.s3.credentialsSecretRef }}
          {{- end }}
          resources:
            {{- toYaml .Values.checkpoint.agent.resources | nindent 12 }}
      volumes:
        # Seccomp profile ConfigMap (used by initContainer)
        - name: seccomp-profiles
          configMap:
            name: {{ include "dynamo-operator.fullname" . }}-seccomp-block-iouring
        # Host seccomp directory (for deploying the profile)
        - name: host-seccomp
          hostPath:
            path: /var/lib/kubelet/seccomp
            type: DirectoryOrCreate
        {{- if eq .Values.checkpoint.storage.type "pvc" }}
        - name: checkpoints
          persistentVolumeClaim:
            claimName: {{ .Values.checkpoint.storage.pvc.pvcName }}
        {{- end }}
        # Containerd runtime directory (read-write for checkpoint operations)
        - name: containerd-run
          hostPath:
            path: /run/containerd
            type: Directory
        # Kubelet pods directory (for volume discovery)
        - name: kubelet-pods
          hostPath:
            path: /var/lib/kubelet/pods
            type: Directory
        # Containerd storage directory (for filesystem info)
        - name: containerd-storage
          hostPath:
            path: /var/lib/containerd
            type: Directory
        # Host proc (for CRIU and signal files - needs write access)
        - name: host-proc
          hostPath:
            path: /proc
            type: Directory
        # Host cgroup (for CRIU)
        - name: host-cgroup
          hostPath:
            path: /sys/fs/cgroup
            type: Directory
        {{- if and (eq .Values.checkpoint.storage.type "oci") .Values.checkpoint.storage.oci.credentialsSecretRef }}
        - name: docker-config
          secret:
            secretName: {{ .Values.checkpoint.storage.oci.credentialsSecretRef }}
        {{- end }}
      {{- with .Values.checkpoint.agent.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

