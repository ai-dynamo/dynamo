# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Storage-version migration job for DynamoGraphDeploymentRequest (DGDR).
#
# When the storage version changes from v1alpha1 to v1beta1, existing objects in
# etcd remain encoded in the old format. This job performs a no-op PUT on every
# DGDR so the API server re-persists them in the current storage version (v1beta1)
# via the conversion webhook. It then patches status.storedVersions on the CRD to
# remove the old version, which is required before v1alpha1 can be dropped.
#
# Runs as a post-install/post-upgrade hook AFTER the conversion webhook is configured
# (hook-weight "3", the conversion patch runs at "2").

{{- if .Values.webhook.certManager.enabled }}
---
# ServiceAccount for the storage-version migration job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "dynamo-operator.fullname" . }}-storage-migration
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/component: storage-migration
    app.kubernetes.io/created-by: dynamo-operator
    app.kubernetes.io/part-of: dynamo-operator
  {{- include "dynamo-operator.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "3"
    "helm.sh/hook-delete-policy": before-hook-creation
---
# ClusterRole: read/update DGDRs across all namespaces + patch CRD status
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "dynamo-operator.fullname" . }}-{{ .Release.Namespace }}-storage-migration
  labels:
    app.kubernetes.io/component: storage-migration
    app.kubernetes.io/created-by: dynamo-operator
    app.kubernetes.io/part-of: dynamo-operator
  {{- include "dynamo-operator.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "3"
    "helm.sh/hook-delete-policy": before-hook-creation
rules:
  # List and update DGDRs to trigger re-persistence
  - apiGroups: ["nvidia.com"]
    resources: ["dynamographdeploymentrequests"]
    verbs: ["list", "get", "update"]
  # Patch CRD status to remove old storedVersions entry
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions"]
    resourceNames: ["dynamographdeploymentrequests.nvidia.com"]
    verbs: ["get", "patch"]
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions/status"]
    resourceNames: ["dynamographdeploymentrequests.nvidia.com"]
    verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "dynamo-operator.fullname" . }}-{{ .Release.Namespace }}-storage-migration
  labels:
    app.kubernetes.io/component: storage-migration
    app.kubernetes.io/created-by: dynamo-operator
    app.kubernetes.io/part-of: dynamo-operator
  {{- include "dynamo-operator.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "3"
    "helm.sh/hook-delete-policy": before-hook-creation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "dynamo-operator.fullname" . }}-{{ .Release.Namespace }}-storage-migration
subjects:
  - kind: ServiceAccount
    name: {{ include "dynamo-operator.fullname" . }}-storage-migration
    namespace: {{ .Release.Namespace }}
---
# Job: re-persist all DGDRs then clean up storedVersions
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "dynamo-operator.fullname" . }}-storage-migration-{{ .Release.Revision }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/component: storage-migration
    app.kubernetes.io/created-by: dynamo-operator
    app.kubernetes.io/part-of: dynamo-operator
  {{- include "dynamo-operator.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "4"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 5
  template:
    metadata:
      name: {{ include "dynamo-operator.fullname" . }}-storage-migration
      labels:
        app.kubernetes.io/component: storage-migration
        app.kubernetes.io/created-by: dynamo-operator
        app.kubernetes.io/part-of: dynamo-operator
      {{- include "dynamo-operator.labels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ include "dynamo-operator.fullname" . }}-storage-migration
      restartPolicy: OnFailure
      {{- with .Values.controllerManager.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.controllerManager.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: storage-migration
          image: {{ .Values.webhook.certGenerator.image.repository }}:{{ .Values.webhook.certGenerator.image.tag }}
          imagePullPolicy: {{ .Values.webhook.certGenerator.image.pullPolicy }}
          command:
            - /bin/bash
            - -c
            - |
              set -e

              CRD_NAME="dynamographdeploymentrequests.nvidia.com"
              RESOURCE="dynamographdeploymentrequests.v1beta1.nvidia.com"

              echo "Starting DGDR storage-version migration..."

              # Verify the conversion webhook is operational before migrating.
              # A simple list call through v1beta1 exercises the webhook for any
              # v1alpha1-stored objects.
              echo "Verifying conversion webhook is operational..."
              if ! kubectl get dgdr --all-namespaces -o name > /dev/null 2>&1; then
                echo "WARNING: Could not list DGDRs. Conversion webhook may not be ready."
                echo "Waiting 10s for webhook to become available..."
                sleep 10
              fi

              # Fetch all DGDRs and re-PUT them via v1beta1 so the API server
              # re-encodes them in the current storage version.
              DGDR_COUNT=0
              DGDR_ERRORS=0

              for ns_name in $(kubectl get dgdr --all-namespaces -o jsonpath='{range .items[*]}{.metadata.namespace}/{.metadata.name}{"\n"}{end}'); do
                ns="${ns_name%%/*}"
                name="${ns_name##*/}"

                echo "  Migrating ${ns}/${name}..."
                if kubectl get dgdr "${name}" -n "${ns}" -o json | \
                   kubectl replace -f - > /dev/null 2>&1; then
                  DGDR_COUNT=$((DGDR_COUNT + 1))
                else
                  echo "  WARNING: Failed to migrate ${ns}/${name}"
                  DGDR_ERRORS=$((DGDR_ERRORS + 1))
                fi
              done

              echo "Migrated ${DGDR_COUNT} DGDR(s), ${DGDR_ERRORS} error(s)."

              if [ "${DGDR_ERRORS}" -gt 0 ]; then
                echo "ERROR: Some objects failed to migrate. Skipping storedVersions cleanup."
                exit 1
              fi

              # Patch the CRD status to remove v1alpha1 from storedVersions.
              echo "Updating CRD status.storedVersions to [v1beta1]..."
              kubectl patch crd "${CRD_NAME}" \
                --subresource=status \
                --type='json' \
                -p='[{"op":"replace","path":"/status/storedVersions","value":["v1beta1"]}]'

              echo "Storage-version migration complete."
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
{{- end }}
