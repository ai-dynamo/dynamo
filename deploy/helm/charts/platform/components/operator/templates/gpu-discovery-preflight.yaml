# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Template-time check: verifies the installer has cluster-scoped RBAC access for GPU discovery.
# Runs only when namespaceRestriction.enabled=true and gpuDiscovery.enabled=true (the default).
# Uses Helm's lookup function (which runs as the installing user) instead of a Job-based check,
# so it tests the correct identity and requires no pod scheduling or image pulls.
{{- if and .Values.namespaceRestriction.enabled .Values.gpuDiscovery.enabled }}
{{- /*
  GPU discovery (gpu-discovery-rbac.yaml) creates a ClusterRole + ClusterRoleBinding to grant
  the namespace-scoped operator read-only node access.  Verify the installer has cluster-level
  RBAC access by probing the API server with lookup, which executes using the installer's
  kubeconfig credentials — the correct identity for this check.

  lookup returns an empty dict during helm template / --dry-run, so we use a two-probe
  heuristic to distinguish dry-run mode from insufficient permissions:
    1. Probe ClusterRoles — if non-empty, the installer has cluster RBAC access.
    2. If empty, probe the release Namespace.  All authenticated users can read their own
       namespace during a real install.  If this succeeds but ClusterRoles did not, the
       installer lacks cluster-scoped access and we fail with a helpful message.
    3. If both are empty we are in dry-run / template mode — skip the check.
*/ -}}
{{- $clusterProbe := lookup "rbac.authorization.k8s.io/v1" "ClusterRole" "" "" -}}
{{- if not $clusterProbe -}}
  {{- $nsProbe := lookup "v1" "Namespace" "" .Release.Namespace -}}
  {{- if $nsProbe -}}
    {{- fail (join "\n" (list ""
      "ERROR: GPU discovery requires cluster-scoped RBAC permissions, but the installer"
      "does not have them. This is needed to grant the namespace-scoped operator"
      "read-only node access for automatic GPU hardware discovery."
      ""
      "Options:"
      "  1. Ask your cluster admin to grant ClusterRole creation permissions and re-run."
      ""
      "  2. Disable GPU discovery and provide hardware config manually in each DGDR:"
      "     helm install ... --set dynamo-operator.gpuDiscovery.enabled=false"
      ""
      "     Then in your DynamoGraphDeploymentRequest:"
      "     spec:"
      "       profilingConfig:"
      "         config:"
      "           hardware:"
      "             numGpusPerNode: 8"
      "             gpuModel: \"H100-SXM5-80GB\""
      "             gpuVramMib: 81920"
      ""
    )) -}}
  {{- end -}}
{{- end -}}
{{- end }}
