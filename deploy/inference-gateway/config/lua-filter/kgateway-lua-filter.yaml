# Dynamo Body Injector - kGateway Configuration
#
# This configures a transformation in kGateway to inject nvext routing information
# into request bodies based on headers set by the EPP Dynamo plugins.
#
# Prerequisites:
#   - kGateway installed with inference extension support
#   - EPP deployed and setting x-worker-instance-id headers
#
# Apply with: kubectl apply -f kgateway-lua-filter.yaml

---
# kGateway TrafficPolicy to transform request body
# Uses Inja templating to inject nvext field from routing headers
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: dynamo-body-injector
  namespace: default  # Must match namespace where Gateway resource is deployed
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: inference-gateway  # Must match your gateway name
  transformation:
    request:
      body:
        parseAs: AsJson
        value: |
          {% set worker_id = header("x-worker-instance-id") %}
          {% if worker_id != "" %}
          {% set original = body %}
          {% set routing_mode = header("x-dynamo-routing-mode") %}
          {% if routing_mode == "disaggregated" %}
          {% set prefill_id = header("x-prefiller-host-port") %}
          {{ original | merge({"nvext": {"prefill_worker_id": prefill_id | int, "decode_worker_id": worker_id | int}}) | tojson }}
          {% else %}
          {{ original | merge({"nvext": {"backend_instance_id": worker_id | int}}) | tojson }}
          {% endif %}
          {% else %}
          {{ body }}
          {% endif %}
