# Dynamo Body Injector - Istio Configuration
#
# This configures an EnvoyFilter in Istio to inject nvext routing information
# into request bodies based on headers set by the EPP Dynamo plugins.
#
# Prerequisites:
#   - Istio installed with Gateway API support
#   - EPP deployed and setting x-worker-instance-id headers
#
# Apply with: kubectl apply -f istio-envoyfilter.yaml

---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: dynamo-body-injector
  namespace: default  # Must match namespace where Gateway resource is deployed
spec:
  workloadSelector:
    labels:
      gateway.networking.k8s.io/gateway-name: inference-gateway  # Must match your gateway name
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.lua
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
          inline_code: |
            -- Dynamo Body Injector Lua Filter
            -- Reads routing headers and injects nvext into request body.
            function envoy_on_request(request_handle)
              local worker_id = request_handle:headers():get("x-worker-instance-id")
              if worker_id == nil or worker_id == "" then
                return
              end

              local prefill_worker_id = request_handle:headers():get("x-prefiller-host-port")
              local routing_mode = request_handle:headers():get("x-dynamo-routing-mode")

              local body = request_handle:body()
              if body == nil then return end

              local body_str = body:getBytes(0, body:length())
              if body_str == nil or body_str == "" then return end

              local nvext_content = ""
              if routing_mode == "disaggregated" then
                local parts = {}
                if prefill_worker_id and prefill_worker_id ~= "" then
                  table.insert(parts, string.format('"prefill_worker_id":%s', prefill_worker_id))
                end
                if worker_id and worker_id ~= "" then
                  table.insert(parts, string.format('"decode_worker_id":%s', worker_id))
                end
                nvext_content = table.concat(parts, ",")
              else
                nvext_content = string.format('"backend_instance_id":%s', worker_id)
              end

              if nvext_content == "" then return end

              local nvext_json = '"nvext":{' .. nvext_content .. '}'

              -- Find the last closing brace
              local insert_pos = nil
              for i = #body_str, 1, -1 do
                if body_str:sub(i, i) == "}" then
                  insert_pos = i
                  break
                end
              end

              if insert_pos == nil then return end

              local prefix = body_str:sub(1, insert_pos - 1)
              local needs_comma = false
              for i = #prefix, 1, -1 do
                local char = prefix:sub(i, i)
                if char:match("%S") then
                  if char ~= "{" and char ~= "," then needs_comma = true end
                  break
                end
              end

              local new_body
              if needs_comma then
                new_body = prefix .. "," .. nvext_json .. "}"
              else
                new_body = prefix .. nvext_json .. "}"
              end

              request_handle:body():setBytes(new_body)
              request_handle:headers():replace("content-length", tostring(#new_body))
            end

