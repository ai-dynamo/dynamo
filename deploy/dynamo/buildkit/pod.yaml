apiVersion: v1
kind: Pod
metadata:
  name: buildkit-client
spec:
  containers:
  - name: buildctl
    image: moby/buildkit:latest
    command: ["/bin/sh", "-c"]
    args:
      - |
        mkdir -p /tmp/secrets &&
        ls -al /mnt/secrets &&
        cp /mnt/secrets/.dockerconfigjson /tmp/secrets/dockerconfig.json &&
        buildctl --addr tcp://buildkit:1234 build \
          --frontend=dockerfile.v0 \
          --local context=/ \
          --local dockerfile=/ \
          --import-cache type=local,src=/cache \
          --export-cache type=local,dest=/cache \
          --output type=image,name=myregistry.com/myimage:latest,push=true \
          --secret id=dockerconfig,src=/tmp/secrets/dockerconfig.json
    volumeMounts:
    - name: docker-secret
      mountPath: "/mnt/secrets"
      readOnly: true
  volumes:
  - name: docker-secret
    secret:
      secretName: yatai-regcred
  restartPolicy: Never
