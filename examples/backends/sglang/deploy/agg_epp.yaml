# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# SGLang Aggregated Deployment with Endpoint Picker Plugin (EPP)
#
# This example demonstrates how to deploy SGLang in aggregated mode with EPP for intelligent
# endpoint selection. EPP uses the Gateway API Inference Extension to route requests to
# frontend instances based on KV cache affinity, latency, and load metrics.
#
# Prerequisites:
# - Gateway API Inference Extension installed in the cluster
# - InferencePool CRD available (inference.networking.k8s.io/v1)
# - EPP configuration (either inline or via ConfigMap)

apiVersion: nvidia.com/v1alpha1
kind: DynamoGraphDeployment
metadata:
  name: sglang-agg-epp
spec:
  services:
    # EPP Service - Endpoint Picker Plugin for intelligent request routing
    # - Single replica (required)
    # - Uses gRPC for communication with Gateway/Ingress
    # - Creates an InferencePool resource that references frontend pods
    epp:
      componentType: epp
      replicas: 1
      extraPodSpec:
        mainContainer:
          image: my-registry/epp:my-tag
      # Option 1: Inline configuration (recommended for getting started)
      eppConfig:
        # Inline EPP configuration using the upstream EndpointPickerConfig schema
        # This configuration uses Dynamo's KV-aware scorer for intelligent routing
        config:
          # Plugins define the behavior of EPP
          plugins:
            # Required: tells EPP which profile to use (even if you only have one)
            - type: single-profile-handler
            # Picker: chooses the final endpoint after scoring
            - name: picker
              type: max-score-picker
            # Dynamo KV-aware Scorer: calls Dynamo router FFI for worker selection
            # Implements Scorer, PreRequest, and ResponseComplete:
            # - Score: Selects workers based on KV cache, sets routing headers
            # - PreRequest: Registers request with router bookkeeping
            # - ResponseComplete: Frees router bookkeeping when response completes
            - name: dyn-kv
              type: kv-aware-scorer
          # Scheduling profiles configure which plugins are used and their weights
          schedulingProfiles:
            - name: default
              plugins:
                - pluginRef: dyn-kv
                  weight: 1
                - pluginRef: picker

      # Option 2: Reference an external ConfigMap (for advanced users)
      # eppConfig:
      #   configMapRef:
      #     name: my-epp-config
      #     key: epp-config.yaml  # Optional, defaults to "epp-config-dynamo.yaml"

    # Frontend Service - SGLang HTTP/gRPC API server
    # - Multiple replicas for high availability and load distribution
    # - Selected by the InferencePool based on EPP's routing decisions
    Frontend:
      componentType: frontend
      replicas: 3  # Multiple frontends for load distribution
      extraPodSpec:
        mainContainer:
          image: my-registry/sglang-runtime:my-tag
          resources:
            requests:
              cpu: "2"
              memory: "8Gi"
            limits:
              cpu: "4"
              memory: "16Gi"

    # Decode Worker Service - SGLang decode worker for token generation
    # - Handles KV cache and token generation
    # - Connects to frontend via Dynamo platform
    decode:
      envFromSecret: hf-token-secret
      componentType: worker
      replicas: 2  # Multiple workers for parallel processing
      resources:
        limits:
          gpu: "1"
      extraPodSpec:
        mainContainer:
          image: my-registry/sglang-runtime:my-tag
          workingDir: /workspace/examples/backends/sglang
          command:
          - python3
          - -m
          - dynamo.sglang
          args:
            - --model-path
            - Qwen/Qwen3-0.6B
            - --served-model-name
            - Qwen/Qwen3-0.6B
            - --page-size
            - "16"
            - --tp
            - "1"
            - --trust-remote-code
            - --skip-tokenizer-init
