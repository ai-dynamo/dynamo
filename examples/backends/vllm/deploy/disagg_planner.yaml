# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

apiVersion: nvidia.com/v1alpha1
kind: DynamoGraphDeployment
metadata:
  name: vllm-disagg-planner
spec:
  services:
    Frontend:
      componentType: frontend
      replicas: 1
      extraPodSpec:
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:nightly-vllm-amd64
    Planner:
      componentType: planner
      replicas: 1
      extraPodSpec:
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:nightly-vllm-amd64
          command:
          - /bin/bash
          - -c
          - |
            set -e
            # Navigate to workspace root for git operations
            cd /workspace
            # Configure git safe directory (needed in containers)
            git config --global --add safe.directory /workspace
            # Check if it's already a git repo, if not initialize it
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/ai-dynamo/dynamo.git
            fi
            # Ensure origin remote exists
            git remote get-url origin || git remote add origin https://github.com/ai-dynamo/dynamo.git
            # Fetch and checkout the branch (force to overwrite any local changes)
            git fetch origin darfeen/migrate-planner-metrics
            git checkout -f FETCH_HEAD
            # Now run the planner
            export PYTHONPATH=/workspace/components/src
            cd /workspace/components/src/dynamo/planner
            python3 -m planner_sla --environment=kubernetes --backend=vllm --adjustment-interval=60 --profile-results-dir=/workspace/tests/planner/profiling_results/H200_TP1P_TP1D
    VllmDecodeWorker:
      envFromSecret: hf-token-secret
      componentType: worker
      subComponentType: decode
      replicas: 1
      resources:
        limits:
          gpu: "1"
      extraPodSpec:
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:nightly-vllm-amd64
          workingDir: /workspace/examples/backends/vllm
          command:
            - python3
          args:
            - -m
            - dynamo.vllm
            - --model
            - Qwen/Qwen3-0.6B
    VllmPrefillWorker:
      envFromSecret: hf-token-secret
      componentType: worker
      subComponentType: prefill
      replicas: 1
      resources:
        limits:
          gpu: "1"
      extraPodSpec:
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:nightly-vllm-amd64
          workingDir: /workspace/examples/backends/vllm
          command:
            - python3
          args:
            - -m
            - dynamo.vllm
            - --model
            - Qwen/Qwen3-0.6B
            - --is-prefill-worker
