networks:
  dynamo-network:
    driver: bridge

services:
  # etcd for key-value store and service discovery
  etcd:
    image: bitnamilegacy/etcd:3.6.1
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
    ports:
      - 2379:2379  # this port exposes the /metrics endpoint
      - 2380:2380
    networks:
      - dynamo-network
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 5s
      timeout: 3s
      retries: 5
    volumes:
      - etcd-data:/bitnami/etcd

  # Shared NATS server for service discovery and messaging
  nats:
    image: nats:2.11.4
    command: [ "-js", "--trace", "-m", "8222" ]
    ports:
      - 4222:4222
      - 6222:6222
      - 8222:8222  # the endpoints include /varz, /healthz, ...
    networks:
      - dynamo-network

  # Triton worker with Dynamo integration
  triton-worker:
    image: dynamo-triton:latest
    depends_on:
      etcd:
        condition: service_healthy
    environment:
      # Point to shared infrastructure services
      - NATS_SERVER=nats://nats:4222
      - ETCD_ENDPOINTS=http://etcd:2379
      # Use etcd for KV store
      - DYN_STORE_KV=etcd
      # Force NATS mode for request plane
      - DYN_REQUEST_PLANE=nats
      # Enable debug logging
      - DYN_LOG=debug
    volumes:
      # Share HuggingFace cache with frontend so file paths match
      - hf-cache:/home/dynamo/.cache/huggingface
    networks:
      - dynamo-network
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: python3 src/tritonworker.py --backend-directory /opt/tritonserver/backends

  # Dynamo frontend with KServe gRPC server
  frontend:
    image: dynamo:latest-none  # Use locally built dynamo base image (v0.7.0)
    depends_on:
      etcd:
        condition: service_healthy
      triton-worker:
        condition: service_started
    environment:
      - NATS_SERVER=nats://nats:4222
      - ETCD_ENDPOINTS=http://etcd:2379
      - DYN_STORE_KV=etcd
      - DYN_LOG=debug
    volumes:
      # Share HuggingFace cache with worker so file paths match
      - hf-cache:/home/dynamo/.cache/huggingface
    user: dynamo
    ports:
      - "8787:8787"  # KServe gRPC port
      - "8123:8000"  # HTTP port (if needed)
    networks:
      - dynamo-network
    command: python -m dynamo.frontend --kserve-grpc-server --http-port 8000

volumes:
  etcd-data:
  nats-data:
  hf-cache:  # Shared HuggingFace cache between worker and frontend

