# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# Standalone dynamo-router PodMonitor.
# Apply this if the operator Helm chart pre-dates the dynamo-router PodMonitor addition.
# If the updated Helm chart is already installed, this is a no-op (same resource).
#
# Apply (cluster-scoped, installs in the operator's namespace):
#   kubectl apply -f router-podmonitor.yaml -n <operator-namespace>

apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: dynamo-router
spec:
  namespaceSelector:
    any: true
  podMetricsEndpoints:
    - interval: 5s
      path: /metrics
      honorLabels: true
      relabelings:
        # Force port 9090 (DYN_SYSTEM_PORT) without requiring containerPort in the pod spec.
        # targetPort: 9090 would generate a keep rule on __meta_kubernetes_pod_container_port_number
        # that drops pods without an explicit containerPort: 9090 declaration.
        - action: replace
          sourceLabels:
            - __address__
          regex: '([^:]+)(?::\d+)?'
          replacement: '${1}:9090'
          targetLabel: __address__
        - action: replace
          sourceLabels:
            - __meta_kubernetes_pod_label_nvidia_com_dynamo_namespace
          targetLabel: dynamo_namespace
  selector:
    matchLabels:
      nvidia.com/dynamo-component-type: default
      nvidia.com/metrics-enabled: "true"
