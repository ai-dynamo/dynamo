# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# E2E test for the full GlobalPlanner flow with --throughput-metrics-source=router.
#
# Validates the complete pipeline:
#   1. GlobalRouter forwards requests to pool LocalRouters
#   2. LocalRouter pods emit dynamo_component_router_* metrics to cluster Prometheus
#   3. SLA Planner reads router histogram metrics (no dynamo_namespace filter â€” our fix)
#      and computes scaling decisions
#   4. SLA Planner sends scaling decisions to GlobalPlanner via scale_request endpoint
#   5. GlobalPlanner receives and logs in NO-OPERATION mode (no K8s API calls)
#
# Architecture:
#   DGD 1 (gp-ctrl):    Frontend + GlobalRouter + GlobalPlanner (no-op) + SLA Planner
#   DGD 2 (gp-prefill): LocalRouter (port 9090) + MockerPrefill
#   DGD 3 (gp-decode):  LocalRouter (port 9090) + MockerDecode
#
# Image: uses CI-built image from main (has new runtime.endpoint() API + PlannerConfig).
# Self-patch applies only our branch-specific changes:
#   - prometheus.py       (router histogram dispatch + dynamo_namespace filter removal)
#   - planner_config.py   (throughput_metrics_source field)
#   - defaults.py         (throughput_metrics_source default)
#   - prometheus_names.py (router metric name constants)
#   - global_planner_connector.py (**kwargs on validate_deployment)
#   - global_planner/{argparse_config,scale_handler,__main__}.py (--no-operation mode)
#
# Prerequisites (already deployed in darfeen-dynamo-cloud):
#   kubectl apply -f standalone-prometheus.yaml -n darfeen-dynamo-cloud
#
# Tear down old test if running:
#   kubectl delete dgd mocker-hierarchical-frontend mocker-hierarchical-prefill-pool \
#     mocker-hierarchical-decode-pool -n darfeen-dynamo-cloud 2>/dev/null || true
#
# Deploy:
#   kubectl apply -f aks-router-metrics-test-global-planner.yaml -n darfeen-dynamo-cloud
#
# Watch GlobalPlanner receive scale requests:
#   kubectl logs -n darfeen-dynamo-cloud \
#     $(kubectl get pods -n darfeen-dynamo-cloud -l nvidia.com/dynamo-component=GlobalPlanner \
#       -o jsonpath='{.items[0].metadata.name}') -f \
#     | grep -E "NO-OP|Scale request|Starting GlobalPlanner"
#
# Watch SLA Planner compute + delegate:
#   kubectl logs -n darfeen-dynamo-cloud \
#     $(kubectl get pods -n darfeen-dynamo-cloud -l nvidia.com/dynamo-component-type=planner \
#       -o jsonpath='{.items[0].metadata.name}') -f \
#     | grep -E "adjustment started|Observed|Delegating scale|GlobalPlanner scaling"
#
# Send load:
#   ./send_load.sh darfeen-dynamo-cloud
#
# Cleanup:
#   kubectl delete -f aks-router-metrics-test-global-planner.yaml -n darfeen-dynamo-cloud

# Base image: CI-built from main, has new runtime.endpoint() + planner/__main__.py
# Does NOT have: throughput_metrics_source, router prometheus fix, GlobalPlanner no-op
# Image: dynamoci.azurecr.io/ai-dynamo/dynamo:e95d0f99167fd9041b4083a3458044d588f95a37-vllm-cuda12-amd64

# =============================================================================
# GlobalRouter ConfigMap
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: gp-global-router-config
data:
  global_router_config.json: |
    {
      "num_prefill_pools": 1,
      "num_decode_pools": 1,
      "prefill_pool_dynamo_namespaces": [
        "darfeen-dynamo-cloud-gp-prefill"
      ],
      "decode_pool_dynamo_namespaces": [
        "darfeen-dynamo-cloud-gp-decode"
      ],
      "prefill_pool_selection_strategy": {
        "ttft_min": 10, "ttft_max": 3000, "ttft_resolution": 2,
        "isl_min": 0,   "isl_max": 32000, "isl_resolution": 2,
        "prefill_pool_mapping": [[0,0],[0,0]]
      },
      "decode_pool_selection_strategy": {
        "itl_min": 10,  "itl_max": 500,   "itl_resolution": 2,
        "context_length_min": 0, "context_length_max": 32000, "context_length_resolution": 2,
        "decode_pool_mapping": [[0,0],[0,0]]
      }
    }
---
# =============================================================================
# DGD 1: Frontend + GlobalRouter + GlobalPlanner (no-op) + SLA Planner
# Dynamo namespace: darfeen-dynamo-cloud-gp-ctrl
# =============================================================================
apiVersion: nvidia.com/v1alpha1
kind: DynamoGraphDeployment
metadata:
  name: gp-ctrl
spec:
  services:
    Frontend:
      componentType: frontend
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:e95d0f99167fd9041b4083a3458044d588f95a37-vllm-cuda12-amd64
          workingDir: /workspace
          command:
            - python3
            - -m
            - dynamo.frontend
          args:
            - --router-mode
            - round-robin
            - --namespace
            - darfeen-dynamo-cloud-gp-ctrl
            - --model-name
            - nvidia/Llama-3.1-8B-Instruct-FP8

    GlobalRouter:
      componentType: default
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        volumes:
          - name: global-router-config
            configMap:
              name: gp-global-router-config
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:e95d0f99167fd9041b4083a3458044d588f95a37-vllm-cuda12-amd64
          workingDir: /workspace
          command:
            - python3
            - -m
            - dynamo.global_router
          args:
            - --config
            - /config/global_router_config.json
            - --model-name
            - nvidia/Llama-3.1-8B-Instruct-FP8
            - --namespace
            - darfeen-dynamo-cloud-gp-ctrl
          volumeMounts:
            - name: global-router-config
              mountPath: /config
              readOnly: true

    GlobalPlanner:
      componentType: default
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:e95d0f99167fd9041b4083a3458044d588f95a37-vllm-cuda12-amd64
          command:
            - bash
            - -c
            - |
              set -e
              SP=/opt/dynamo/venv/lib/python3.12/site-packages
              echo "Cloning feat/throughput-metrics-source for GlobalPlanner patch..."
              git clone --depth=1 \
                --branch feat/throughput-metrics-source \
                https://github.com/ai-dynamo/dynamo /tmp/dynamo-pr 2>&1 | tail -3
              SRC_COMP=/tmp/dynamo-pr/components/src/dynamo
              echo "Patching: GlobalPlanner no-op mode..."
              cp $SRC_COMP/global_planner/argparse_config.py  $SP/dynamo/global_planner/argparse_config.py
              cp $SRC_COMP/global_planner/scale_handler.py    $SP/dynamo/global_planner/scale_handler.py
              cp $SRC_COMP/global_planner/__main__.py         $SP/dynamo/global_planner/__main__.py
              echo "Patches applied. Starting GlobalPlanner --no-operation..."
              exec python3 -m dynamo.global_planner --no-operation

    Planner:
      componentType: planner
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:e95d0f99167fd9041b4083a3458044d588f95a37-vllm-cuda12-amd64
          command:
            - bash
            - -c
            - |
              set -e
              SP=/opt/dynamo/venv/lib/python3.12/site-packages
              echo "Cloning feat/throughput-metrics-source for SLA Planner patch..."
              git clone --depth=1 \
                --branch feat/throughput-metrics-source \
                https://github.com/ai-dynamo/dynamo /tmp/dynamo-pr 2>&1 | tail -3
              SRC_LIB=/tmp/dynamo-pr/lib/bindings/python/src/dynamo
              SRC_COMP=/tmp/dynamo-pr/components/src/dynamo
              echo "Patching: throughput_metrics_source + router prometheus fix..."
              cp $SRC_LIB/prometheus_names.py                       $SP/dynamo/prometheus_names.py
              cp $SRC_COMP/planner/defaults.py                      $SP/dynamo/planner/defaults.py
              cp $SRC_COMP/planner/utils/planner_config.py          $SP/dynamo/planner/utils/planner_config.py
              cp $SRC_COMP/planner/utils/prometheus.py              $SP/dynamo/planner/utils/prometheus.py
              cp $SRC_COMP/planner/global_planner_connector.py      $SP/dynamo/planner/global_planner_connector.py
              echo "Patches applied. Starting SLA Planner global-planner mode..."
              exec python3 -m dynamo.planner --config \
                '{"environment":"global-planner","global_planner_namespace":"darfeen-dynamo-cloud-gp-ctrl","backend":"mocker","mode":"disagg","throughput_metrics_source":"router","throughput_adjustment_interval":30,"ttft":2000,"itl":200,"max_gpu_budget":-1,"prefill_engine_num_gpu":1,"decode_engine_num_gpu":1,"no_correction":true,"profile_results_dir":"/workspace/tests/planner/profiling_results/H200_TP1P_TP1D","metric_pulling_prometheus_endpoint":"http://prometheus:9090","model_name":"nvidia/Llama-3.1-8B-Instruct-FP8","enable_load_scaling":false}'
---
# =============================================================================
# DGD 2: Prefill Pool
# Dynamo namespace: darfeen-dynamo-cloud-gp-prefill
# =============================================================================
apiVersion: nvidia.com/v1alpha1
kind: DynamoGraphDeployment
metadata:
  name: gp-prefill
spec:
  services:
    LocalRouter:
      componentType: default
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:e95d0f99167fd9041b4083a3458044d588f95a37-vllm-cuda12-amd64
          workingDir: /workspace
          env:
            - name: DYN_SYSTEM_PORT
              value: "9090"
          command:
            - python3
            - -m
            - dynamo.router
          args:
            - --endpoint
            - darfeen-dynamo-cloud-gp-prefill.prefill.generate
            - --no-router-kv-events

    MockerPrefill:
      componentType: worker
      subComponentType: prefill
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:e95d0f99167fd9041b4083a3458044d588f95a37-vllm-cuda12-amd64
          workingDir: /workspace
          command:
            - python3
            - -m
            - dynamo.mocker
          args:
            - --model-path
            - nvidia/Llama-3.1-8B-Instruct-FP8
            - --model-name
            - nvidia/Llama-3.1-8B-Instruct-FP8
            - --speedup-ratio
            - "5.0"
            - --planner-profile-data
            - /workspace/tests/planner/profiling_results/H200_TP1P_TP1D
            - --is-prefill-worker
---
# =============================================================================
# DGD 3: Decode Pool
# Dynamo namespace: darfeen-dynamo-cloud-gp-decode
# =============================================================================
apiVersion: nvidia.com/v1alpha1
kind: DynamoGraphDeployment
metadata:
  name: gp-decode
spec:
  services:
    LocalRouter:
      componentType: default
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:e95d0f99167fd9041b4083a3458044d588f95a37-vllm-cuda12-amd64
          workingDir: /workspace
          env:
            - name: DYN_SYSTEM_PORT
              value: "9090"
          command:
            - python3
            - -m
            - dynamo.router
          args:
            - --endpoint
            - darfeen-dynamo-cloud-gp-decode.backend.generate
            - --no-router-kv-events
            - --router-kv-overlap-score-weight=0

    MockerDecode:
      componentType: worker
      subComponentType: decode
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:e95d0f99167fd9041b4083a3458044d588f95a37-vllm-cuda12-amd64
          workingDir: /workspace
          command:
            - python3
            - -m
            - dynamo.mocker
          args:
            - --model-path
            - nvidia/Llama-3.1-8B-Instruct-FP8
            - --model-name
            - nvidia/Llama-3.1-8B-Instruct-FP8
            - --speedup-ratio
            - "5.0"
            - --planner-profile-data
            - /workspace/tests/planner/profiling_results/H200_TP1P_TP1D
