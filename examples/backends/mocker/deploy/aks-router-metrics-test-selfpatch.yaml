# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# Disaggregated mocker deployment for testing --throughput-metrics-source=router
# on the dynamo-dev AKS cluster.
#
# Self-contained: the Planner clones feat/throughput-metrics-source at startup
# and patches its own venv â€” no ConfigMap prerequisite needed.
#
# Prerequisites (already deployed):
#   kubectl apply -f standalone-prometheus.yaml -n darfeen-dynamo-cloud
#
# Deploy:
#   kubectl apply -f aks-router-metrics-test-selfpatch.yaml -n darfeen-dynamo-cloud
#
# Watch planner observe router metrics:
#   kubectl logs -n darfeen-dynamo-cloud -l nvidia.com/dynamo-component-type=planner -f \
#     | grep -E "adjustment started|Observed|Predicted|scaling|replicas|router|throughput"
#
# Verify Prometheus is scraping the router:
#   kubectl port-forward svc/prometheus 9090:9090 -n darfeen-dynamo-cloud &
#   curl -s 'http://localhost:9090/api/v1/query' \
#     --data-urlencode 'query=dynamo_component_router_requests_total' | python3 -m json.tool
#
# Send load:
#   ./send_load.sh darfeen-dynamo-cloud
#
# Cleanup:
#   kubectl delete -f aks-router-metrics-test-selfpatch.yaml -n darfeen-dynamo-cloud

apiVersion: nvidia.com/v1alpha1
kind: DynamoGraphDeployment
metadata:
  name: mocker-router-metrics-test
spec:
  services:
    Frontend:
      componentType: frontend
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:451e3d9ea6b1a4bceb55f6a798fd857a59dfd319-vllm-cuda12-amd64
          env:
            # Use KV router mode so dynamo_component_router_* metrics are emitted.
            # --no-kv-events: mocker workers don't send KV block events, so the router
            # uses prediction mode (still tracks routing and emits metrics).
            - name: DYN_ROUTER_MODE
              value: "kv"
            - name: DYN_KV_EVENTS
              value: "false"

    Planner:
      componentType: planner
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:451e3d9ea6b1a4bceb55f6a798fd857a59dfd319-vllm-cuda12-amd64
          command:
            - bash
            - -c
            - |
              set -e
              SP=/opt/dynamo/venv/lib/python3.12/site-packages
              echo "Cloning feat/throughput-metrics-source..."
              git clone --depth=1 \
                --branch feat/throughput-metrics-source \
                https://github.com/ai-dynamo/dynamo /tmp/dynamo-pr 2>&1 | tail -3
              SRC_LIB=/tmp/dynamo-pr/lib/bindings/python/src/dynamo
              SRC_COMP=/tmp/dynamo-pr/components/src/dynamo
              echo "Patching venv..."
              cp $SRC_LIB/prometheus_names.py               $SP/dynamo/prometheus_names.py
              cp $SRC_COMP/planner/utils/prometheus.py       $SP/dynamo/planner/utils/prometheus.py
              cp $SRC_COMP/planner/utils/planner_argparse.py $SP/dynamo/planner/utils/planner_argparse.py
              cp $SRC_COMP/planner/utils/planner_core.py     $SP/dynamo/planner/utils/planner_core.py
              cp $SRC_COMP/planner/defaults.py               $SP/dynamo/planner/defaults.py
              echo "Patches applied. Starting planner..."
              exec python3 -m dynamo.planner.planner_sla \
                --environment=kubernetes \
                --backend=mocker \
                --mode=disagg \
                --adjustment-interval=30 \
                --ttft=2000 \
                --itl=200 \
                --max-gpu-budget=-1 \
                --prefill-engine-num-gpu=1 \
                --decode-engine-num-gpu=1 \
                --no-correction \
                --profile-results-dir=/workspace/tests/planner/profiling_results/H200_TP1P_TP1D \
                --metric-pulling-prometheus-endpoint=http://prometheus:9090 \
                --throughput-metrics-source=router

    prefill:
      componentType: worker
      subComponentType: prefill
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:451e3d9ea6b1a4bceb55f6a798fd857a59dfd319-vllm-cuda12-amd64
          workingDir: /workspace
          command:
            - python3
            - -m
            - dynamo.mocker
          args:
            - --model-path
            - nvidia/Llama-3.1-8B-Instruct-FP8
            - --model-name
            - nvidia/Llama-3.1-8B-Instruct-FP8
            - --speedup-ratio
            - "5.0"
            - --planner-profile-data
            - /workspace/tests/planner/profiling_results/H200_TP1P_TP1D
            - --is-prefill-worker

    decode:
      componentType: worker
      subComponentType: decode
      replicas: 1
      extraPodSpec:
        imagePullSecrets:
          - name: docker-imagepullsecret
        mainContainer:
          image: dynamoci.azurecr.io/ai-dynamo/dynamo:451e3d9ea6b1a4bceb55f6a798fd857a59dfd319-vllm-cuda12-amd64
          workingDir: /workspace
          command:
            - python3
            - -m
            - dynamo.mocker
          args:
            - --model-path
            - nvidia/Llama-3.1-8B-Instruct-FP8
            - --model-name
            - nvidia/Llama-3.1-8B-Instruct-FP8
            - --speedup-ratio
            - "5.0"
            - --planner-profile-data
            - /workspace/tests/planner/profiling_results/H200_TP1P_TP1D
            - --is-decode-worker
