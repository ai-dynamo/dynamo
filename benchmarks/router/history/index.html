<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Router benchmark trends</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg: #0f1117; --card: #161b22; --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1.5rem; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .meta { color: var(--muted); font-size: 0.875rem; margin-bottom: 1.5rem; }
    .chart-wrap { background: var(--card); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; max-width: 900px; }
    .chart-wrap h2 { font-size: 1rem; margin: 0 0 0.75rem; color: var(--muted); }
    .chart-container { position: relative; height: 280px; }
    a { color: var(--accent); }
    .empty { color: var(--muted); padding: 2rem; }
    .table-wrap { background: var(--card); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; max-width: 1200px; overflow-x: auto; }
    .table-wrap h2 { font-size: 1rem; margin: 0 0 0.75rem; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid var(--muted); }
    th { color: var(--muted); font-weight: 600; }
  </style>
</head>
<body>
  <h1>Router benchmark results over time</h1>
  <p class="meta">CI runs on main. Data: <code>benchmark_history.json</code> · <a href="https://github.com/ai-dynamo/dynamo/blob/main/benchmarks/router/history/README.md">How to view</a></p>
  <div id="loading" class="meta">Loading history…</div>
  <div id="empty" class="empty" style="display:none">No benchmark history yet. Runs on <code>main</code> are recorded automatically.</div>
  <div id="charts" style="display:none">
    <div id="table-wrap" class="table-wrap" style="display:none">
      <h2>Runs</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Model</th>
            <th>Commit</th>
            <th>ISL</th>
            <th>OSL</th>
            <th>Concurrency</th>
            <th>TP</th>
            <th>GPU SKU</th>
            <th>Test</th>
          </tr>
        </thead>
        <tbody id="runs-tbody"></tbody>
      </table>
    </div>
    <div class="chart-wrap">
      <h2>Time to first token (TTFT) p25 / p50 / p75 (ms) by prefix ratio</h2>
      <div class="chart-container"><canvas id="ttftChart"></canvas></div>
    </div>
    <div class="chart-wrap">
      <h2>Inter-token latency (ITL) p25 / p50 / p75 (ms) by prefix ratio</h2>
      <div class="chart-container"><canvas id="itlChart"></canvas></div>
    </div>
  </div>

  <script>
    (function () {
      const loading = document.getElementById('loading');
      const empty = document.getElementById('empty');
      const charts = document.getElementById('charts');

      function rawUrl() {
        const path = window.location.pathname;
        const parts = path.split('/').filter(Boolean);
        if (parts[0] && parts[1] && (parts[2] === 'blob' || parts[2] === 'tree')) {
          const branch = parts[3] || 'main';
          return 'https://raw.githubusercontent.com/' + parts[0] + '/' + parts[1] + '/' + branch + '/benchmarks/router/history/benchmark_history.json';
        }
        return null;
      }

      const dataUrl = rawUrl() || 'benchmark_history.json';

      fetch(dataUrl)
        .then(function (r) { return r.ok ? r.json() : Promise.reject(new Error('Failed to load')); })
        .then(function (history) {
          loading.style.display = 'none';
          if (!Array.isArray(history) || history.length === 0) {
            empty.style.display = 'block';
            return;
          }
          charts.style.display = 'block';

          var tableWrap = document.getElementById('table-wrap');
          var tbody = document.getElementById('runs-tbody');
          var path = window.location.pathname;
          var pathParts = path.split('/').filter(Boolean);
          var commitBaseUrl = (pathParts[0] && pathParts[1] && (pathParts[2] === 'blob' || pathParts[2] === 'tree'))
            ? 'https://github.com/' + pathParts[0] + '/' + pathParts[1] + '/commit/'
            : null;
          history.forEach(function (e) {
            var config = (e.results && e.results.config) ? e.results.config : {};
            var dateStr = (e.timestamp && e.timestamp.slice(0, 10)) || ('Run ' + e.run_id);
            var commitShort = (e.commit && e.commit.slice(0, 7)) || '—';
            var commitCell = commitBaseUrl && e.commit
              ? '<a href="' + commitBaseUrl + e.commit + '" target="_blank" rel="noopener">' + commitShort + '</a>'
              : commitShort;
            var row = '<tr>' +
              '<td>' + dateStr + '</td>' +
              '<td>' + (config.model != null ? config.model : '—') + '</td>' +
              '<td>' + commitCell + '</td>' +
              '<td>' + (config.isl != null ? config.isl : '—') + '</td>' +
              '<td>' + (config.osl != null ? config.osl : '—') + '</td>' +
              '<td>' + (config.concurrency != null ? config.concurrency : '—') + '</td>' +
              '<td>' + (config.tp != null ? config.tp : '—') + '</td>' +
              '<td>' + (config.gpu_sku != null ? config.gpu_sku : '—') + '</td>' +
              '<td>' + (e.run_url ? '<a href="' + e.run_url + '" target="_blank" rel="noopener">Test</a>' : '—') + '</td>' +
              '</tr>';
            tbody.insertAdjacentHTML('beforeend', row);
          });
          tableWrap.style.display = 'block';

          const labels = history.map(function (e) {
            const d = e.timestamp && e.timestamp.slice(0, 10);
            return d || ('Run ' + e.run_id);
          });
          const runUrls = history.map(function (e) { return e.run_url; });

          const prefixRatios = history[0].results && history[0].results.prefix_ratios
            ? history[0].results.prefix_ratios
            : [0];
          const colors = ['#58a6ff', '#3fb950', '#d29922', '#f85149', '#a371f7'];
          const percentiles = [
            { key: 'p25', metricSuffix: '_p25_values', labelSuffix: ' p25', borderDash: [8, 4] },
            { key: 'p50', metricSuffix: '_p50_values', labelSuffix: ' p50', borderDash: [] },
            { key: 'p75', metricSuffix: '_p75_values', labelSuffix: ' p75', borderDash: [2, 4] }
          ];

          function dataset(metric, prefixIndex, label, borderDash) {
            return {
              label: label,
              data: history.map(function (e) {
                const vals = e.results && e.results[metric];
                return Array.isArray(vals) && vals[prefixIndex] != null ? vals[prefixIndex] : null;
              }),
              borderColor: colors[prefixIndex % colors.length],
              backgroundColor: colors[prefixIndex % colors.length] + '20',
              fill: false,
              spanGaps: true,
              borderDash: borderDash || []
            };
          }

          function buildPercentileDatasets(metricPrefix) {
            const out = [];
            prefixRatios.forEach(function (pr, i) {
              percentiles.forEach(function (p) {
                out.push(dataset(
                  metricPrefix + p.metricSuffix,
                  i,
                  pr + p.labelSuffix,
                  p.borderDash
                ));
              });
            });
            return out;
          }

          const ttftDatasets = buildPercentileDatasets('ttft');
          const itlDatasets = buildPercentileDatasets('itl');

          function runTooltipCallback(tooltipItems) {
            if (!tooltipItems.length) return [];
            var idx = tooltipItems[0].dataIndex;
            var e = history[idx];
            if (!e) return [];
            var config = (e.results && e.results.config) ? e.results.config : {};
            var lines = [
              'Model: ' + (config.model != null ? config.model : '—'),
              'Commit: ' + (e.commit ? e.commit.slice(0, 7) : '—'),
              'ISL / OSL: ' + (config.isl != null ? config.isl : '—') + ' / ' + (config.osl != null ? config.osl : '—'),
              'Concurrency: ' + (config.concurrency != null ? config.concurrency : '—'),
              'TP: ' + (config.tp != null ? config.tp : '—'),
              'GPU SKU: ' + (config.gpu_sku != null ? config.gpu_sku : '—')
            ];
            if (e.run_url) lines.push('Test: ' + e.run_url);
            return lines;
          }

          var commonChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  afterBody: runTooltipCallback
                }
              }
            },
            scales: {
              x: { ticks: { maxRotation: 45, maxTicksLimit: 15 } },
              y: { beginAtZero: true, title: { display: true, text: 'ms' } }
            },
            onClick: function (_, el) {
              if (el.length && runUrls[el[0].index]) window.open(runUrls[el[0].index]);
            }
          };

          new Chart(document.getElementById('ttftChart'), {
            type: 'line',
            data: { labels: labels, datasets: ttftDatasets },
            options: commonChartOptions
          });

          new Chart(document.getElementById('itlChart'), {
            type: 'line',
            data: { labels: labels, datasets: itlDatasets },
            options: commonChartOptions
          });
        })
        .catch(function () {
          loading.style.display = 'none';
          empty.style.display = 'block';
          empty.textContent = 'Could not load benchmark_history.json. Open this page from the repo or use the raw JSON URL.';
        });
    })();
  </script>
</body>
</html>
