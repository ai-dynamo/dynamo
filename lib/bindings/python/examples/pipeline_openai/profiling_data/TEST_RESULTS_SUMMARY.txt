================================================================================
MEMORY TEST RESULTS SUMMARY
================================================================================

Test Date: January 2026
Test Configuration:
  - Payload: 1,000,000 chars (1 MB)
  - Concurrency: 96
  - Requests per cycle: 1,000
  - Cycles: 3

================================================================================
TEST 1: BASELINE + NO MALLOC_ARENA_MAX
================================================================================
Verified: MEMORY_TEST: BASELINE code path (NO ZeroCopyTcpDecoder)

Cycle 1: 57 MB -> 6,114 MB
Cycle 2: 6,114 MB -> 7,573 MB (+1,459 MB)
Cycle 3: 7,573 MB -> 8,389 MB (+816 MB)

FINAL: 8,389 MB
Growth per cycle: ~1,100 MB (UNBOUNDED)

================================================================================
TEST 2: BASELINE + MALLOC_ARENA_MAX=2
================================================================================
Verified: MEMORY_TEST: BASELINE code path (NO ZeroCopyTcpDecoder)

Cycle 1: 57 MB -> 4,321 MB
Cycle 2: 4,321 MB -> 4,436 MB (+115 MB)
Cycle 3: 4,436 MB -> 4,436 MB (+0 MB)

FINAL: 4,436 MB
Growth per cycle: ~58 MB (STABLE)

================================================================================
TEST 3: PR #5376 + NO MALLOC_ARENA_MAX
================================================================================
Verified: MEMORY_TEST: PR-5376 code path (WITH ZeroCopyTcpDecoder)

Cycle 1: 61 MB -> 6,282 MB
Cycle 2: 6,282 MB -> 7,368 MB (+1,086 MB)
Cycle 3: 7,368 MB -> 8,140 MB (+772 MB)

FINAL: 8,140 MB
Growth per cycle: ~930 MB (UNBOUNDED)

================================================================================
TEST 4: PR #5376 + MALLOC_ARENA_MAX=2
================================================================================
Verified: MEMORY_TEST: PR-5376 code path (WITH ZeroCopyTcpDecoder)

Cycle 1: 57 MB -> 3,946 MB
Cycle 2: 3,946 MB -> 4,004 MB (+58 MB)
Cycle 3: 4,004 MB -> 4,061 MB (+57 MB)

FINAL: 4,061 MB
Growth per cycle: ~57 MB (STABLE)

================================================================================
COMPARISON SUMMARY
================================================================================

                          | No Arena Limit | MALLOC_ARENA_MAX=2 | Reduction
--------------------------|----------------|--------------------|-----------
Baseline                  | 8,389 MB       | 4,436 MB           | 47%
PR #5376                  | 8,140 MB       | 4,061 MB           | 50%
--------------------------|----------------|--------------------|-----------
PR #5376 improvement      | 3%             | 8%                 |

================================================================================
KEY FINDINGS
================================================================================

1. MALLOC_ARENA_MAX=2 is ESSENTIAL for memory stability
   - Without it: ~1,000 MB growth per cycle (unbounded)
   - With it: ~57 MB growth per cycle (stable after warmup)

2. PR #5376 (ZeroCopyTcpDecoder) provides marginal improvement
   - 3% without MALLOC_ARENA_MAX
   - 8% with MALLOC_ARENA_MAX=2

3. Root cause: glibc malloc arena fragmentation
   - 90% of allocations in native (Rust) code
   - spawn_blocking threads each get their own arena
   - Memory freed but not returned to OS

================================================================================
RECOMMENDATION
================================================================================

For production: MALLOC_ARENA_MAX=2

================================================================================
