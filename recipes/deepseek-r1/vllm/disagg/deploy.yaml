# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

apiVersion: nvidia.com/v1alpha1
kind: DynamoGraphDeployment
metadata:
  name: vllm-dsr1-8gpu
spec:
  pvcs:
    - name: model-cache-pvc
      create: false
  services:
    Frontend:
      dynamoNamespace: vllm-dsr1-8gpu
      componentType: frontend
      replicas: 1
      extraPodSpec:
        mainContainer:
          startupProbe:
            httpGet:
              path: /health
              port: 8000
            periodSeconds: 10
            timeoutSeconds: 1800
            failureThreshold: 60
          image: nvcr.io/nvidia/ai-dynamo/vllm-runtime:0.6.1
    decode:
      dynamoNamespace: vllm-dsr1-8gpu
      componentType: worker
      replicas: 1
      resources:
        limits:
          gpu: "8"
      volumeMounts:
        - name: model-cache-pvc
          mountPoint: /model-cache
      sharedMemory:
        size: 80Gi
      extraPodSpec:
        mainContainer:
          startupProbe:
            httpGet:
              path: /health
              port: 9090
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 600
          image: nvcr.io/nvidia/ai-dynamo/vllm-runtime:0.6.1
          workingDir: /workspace/dynamo
          env:
            - name: GLOO_SOCKET_IFNAME
              value: eth0
            - name: NCCL_SOCKET_IFNAME
              value: eth0
            - name: NVSHMEM_BOOTSTRAP_UID_SOCK_IFNAME
              value: eth0
            - name: NVIDIA_GDRCOPY
              value: enabled
            - name: NVSHMEM_REMOTE_TRANSPORT
              value: ibgda
            - name: NVSHMEM_IB_ENABLE_IBGDA
              value: "true"
            - name: VLLM_USE_DEEP_GEMM
              value: "1"
            - name: VLLM_RANDOMIZE_DP_DUMMY_INPUTS
              value: "1"
            - name: VLLM_SKIP_P2P_CHECK
              value: "1"
            - name: VLLM_ALL2ALL_BACKEND
              value: deepep_low_latency
          command:
            - python3
            - -m
            - dynamo.vllm
          args:
            - --model
            - /model-cache/deepseek-r1
            - --served-model-name
            - deepseek-ai/DeepSeek-R1
            - --tensor-parallel-size
            - "1"
            - --data_parallel_size
            - "8"
            - --data-parallel-size-local
            - "8"
            - --data-parallel-hybrid-lb
            - --max-model-len
            - "2560"
            - --enable-expert-parallel
            - --async-scheduling
            - --enable-dbo
            - --dbo-decode-token-threshold
            - "32"
            - --enable-eplb
            - --eplb-config
            - '{"window_size":"1000","step_interval":"3000","num_redundant_experts":"32","log_balancedness":"False"}'
            - --compilation_config
            - '{"cudagraph_mode": "FULL_DECODE_ONLY"}'
    prefill:
      dynamoNamespace: vllm-dsr1-8gpu
      componentType: worker
      replicas: 1
      resources:
        limits:
          gpu: "8"
      volumeMounts:
        - name: model-cache-pvc
          mountPoint: /model-cache
      sharedMemory:
        size: 80Gi
      extraPodSpec:
        mainContainer:
          startupProbe:
            httpGet:
              path: /health
              port: 9090
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 600
          image: nvcr.io/nvidia/ai-dynamo/vllm-runtime:0.6.1
          workingDir: /workspace/dynamo
          env:
            - name: GLOO_SOCKET_IFNAME
              value: eth0
            - name: NCCL_SOCKET_IFNAME
              value: eth0
            - name: NVSHMEM_BOOTSTRAP_UID_SOCK_IFNAME
              value: eth0
            - name: NVIDIA_GDRCOPY
              value: enabled
            - name: NVSHMEM_REMOTE_TRANSPORT
              value: ibgda
            - name: NVSHMEM_IB_ENABLE_IBGDA
              value: "true"
            - name: VLLM_USE_DEEP_GEMM
              value: "1"
            - name: VLLM_RANDOMIZE_DP_DUMMY_INPUTS
              value: "1"
            - name: VLLM_SKIP_P2P_CHECK
              value: "1"
            - name: VLLM_ALL2ALL_BACKEND
              value: deepep_high_throughput
          command:
            - python3
            - -m
            - dynamo.vllm
          args:
            - --model
            - /model-cache/deepseek-r1
            - --served-model-name
            - deepseek-ai/DeepSeek-R1
            - --tensor-parallel-size
            - "1"
            - --data_parallel_size
            - "8"
            - --data-parallel-size-local
            - "8"
            - --data-parallel-hybrid-lb
            - --max-model-len
            - "1048"
            - --gpu-memory-utilization
            - "0.75"
            - --enable-expert-parallel
            - --async-scheduling
            - --enable-dbo
            - --dbo-decode-token-threshold
            - "32"
            - --enable-eplb
            - --eplb-config
            - '{"window_size":"1000","step_interval":"3000","num_redundant_experts":"32","log_balancedness":"False"}'
            - --is-prefill-worker

