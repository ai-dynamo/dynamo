# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
apiVersion: v1
kind: Pod
metadata:
  name: agg-mx-p2p-benchmark
  labels:
    app: benchmark
spec:
  containers:
  - name: python
    image: python:3.11
    command:
      - /bin/bash
      - -lc
      - |
        # Setup
        ulimit -n 1048576
        ulimit -u 65536
        apt update && apt install tmux curl jq -y

        # Install benchmarking tool
        pip install aiperf

        # Wait for model to be ready
        # echo "Waiting for model '${MODEL_NAME}' at http://${FRONTEND}:8000/v1/models..."
        # until curl -s "http://${FRONTEND}:8000/v1/models" | jq -e --arg model "${MODEL_NAME}" '.data[]? | select(.id == $model)' >/dev/null 2>&1; do
        #   echo "[$(date '+%H:%M:%S')] Model not ready, retrying in 5s..."
        #   sleep 5
        # done
        # echo "Model '${MODEL_NAME}' is ready!"

        # Setup Paths and Endpoints
        export INPUT_FILE="${BASE_DIR}/traces/${DATASET}.jsonl"
        export MODEL_BASE_NAME="${MODEL_NAME##*/}"
        export DATASET_NAME="${DATASET}"
        export ARTIFACT_DIR="${BASE_DIR}/artifacts/${MODEL_BASE_NAME}/${DATASET_NAME}/${RUN_TAG}/${BENCH_MODE}"
        mkdir -p "${ARTIFACT_DIR}"

        # Run Benchmark so its easy to attach and watch
        tmux new-session -d -s benchmark -c "${ARTIFACT_DIR}"
        tmux send-keys -t benchmark "aiperf profile -m ${MODEL_NAME} --input-file ${INPUT_FILE} --custom-dataset-type mooncake_trace --fixed-schedule --slice-duration ${SLICE_DURATION} --url http://${FRONTEND}:8000 --streaming --artifact-dir ${ARTIFACT_DIR} --goodput \"time_to_first_token:2000 inter_token_latency:25\" --server-metrics-formats json jsonl" C-m
        sleep 7200
    env:
      - name: MODEL_NAME
        value: meta-llama/Llama-3.3-70B-Instruct
      - name: FRONTEND
        value: vllm-agg-mx-p2p-frontend
      - name: BENCH_MODE
        value: p2p
      - name: DATASET
        value: staircase_trace
      - name: SLICE_DURATION
        value: "60"
      - name: RUN_TAG
        value: default_run
      - name: BASE_DIR
        value: /perf-cache
      - name: HF_TOKEN
        valueFrom:
          secretKeyRef:
            name: hf-token-secret
            key: HF_TOKEN
    resources:
      requests:
        cpu: "8"
        memory: 16Gi
      limits:
        cpu: "16"
        memory: 32Gi
    volumeMounts:
    - name: perf-cache
      mountPath: /perf-cache
    workingDir: /workspace
  volumes:
  - name: perf-cache
    persistentVolumeClaim:
      claimName: model-cache-llama
  restartPolicy: Never
